#include <stdlib.h>
#include <assert.h>
#include <stdio.h>
#include "cmark_amalgamation.h"

int cmark_version() { return CMARK_VERSION; }

/* Generated by re2c 0.16 */
bufsize_t _scan_at(bufsize_t (*scanner)(const unsigned char *), cmark_chunk *c,
                   bufsize_t offset) {
  bufsize_t res;
  unsigned char *ptr = (unsigned char *)c->data;

  if (ptr == NULL || offset > c->len) {
    return 0;
  } else {
    unsigned char lim = ptr[c->len];

    ptr[c->len] = '\0';
    res = scanner(ptr + offset);
    ptr[c->len] = lim;
  }

  return res;
}

// Try to match a scheme including colon.
bufsize_t _scan_scheme(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    yych = *p;
    if (yych <= '@')
      goto yy2;
    if (yych <= 'Z')
      goto yy4;
    if (yych <= '`')
      goto yy2;
    if (yych <= 'z')
      goto yy4;
  yy2:
    ++p;
  yy3 : { return 0; }
  yy4:
    yych = *(marker = ++p);
    if (yych <= '/') {
      if (yych <= '+') {
        if (yych <= '*')
          goto yy3;
      } else {
        if (yych <= ',')
          goto yy3;
        if (yych >= '/')
          goto yy3;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '9')
          goto yy5;
        if (yych <= '@')
          goto yy3;
      } else {
        if (yych <= '`')
          goto yy3;
        if (yych >= '{')
          goto yy3;
      }
    }
  yy5:
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych == '+')
          goto yy7;
      } else {
        if (yych != '/')
          goto yy7;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych >= 'A')
          goto yy7;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych <= 'z')
          goto yy7;
      }
    }
  yy6:
    p = marker;
    goto yy3;
  yy7:
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych == '+')
          goto yy10;
        goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
        goto yy10;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
        goto yy10;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych <= 'z')
          goto yy10;
        goto yy6;
      }
    }
  yy8:
    ++p;
    { return (bufsize_t)(p - start); }
  yy10:
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy6;
      } else {
        if (yych == '/')
          goto yy6;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy8;
        if (yych <= '@')
          goto yy6;
      } else {
        if (yych <= '`')
          goto yy6;
        if (yych >= '{')
          goto yy6;
      }
    }
    ++p;
    if ((yych = *p) == ':')
      goto yy8;
    goto yy6;
  }
}

// Try to match URI autolink after first <, returning number of chars matched.
bufsize_t _scan_autolink_uri(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 0,   128, 0,   128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,
    };
    yych = *p;
    if (yych <= '@')
      goto yy41;
    if (yych <= 'Z')
      goto yy43;
    if (yych <= '`')
      goto yy41;
    if (yych <= 'z')
      goto yy43;
  yy41:
    ++p;
  yy42 : { return 0; }
  yy43:
    yych = *(marker = ++p);
    if (yych <= '/') {
      if (yych <= '+') {
        if (yych <= '*')
          goto yy42;
      } else {
        if (yych <= ',')
          goto yy42;
        if (yych >= '/')
          goto yy42;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '9')
          goto yy44;
        if (yych <= '@')
          goto yy42;
      } else {
        if (yych <= '`')
          goto yy42;
        if (yych >= '{')
          goto yy42;
      }
    }
  yy44:
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych == '+')
          goto yy46;
      } else {
        if (yych != '/')
          goto yy46;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych >= 'A')
          goto yy46;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych <= 'z')
          goto yy46;
      }
    }
  yy45:
    p = marker;
    goto yy42;
  yy46:
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych == '+')
          goto yy49;
        goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
        goto yy49;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
        goto yy49;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych <= 'z')
          goto yy49;
        goto yy45;
      }
    }
  yy47:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy47;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '<')
          goto yy45;
        if (yych <= '>')
          goto yy50;
        goto yy45;
      } else {
        if (yych <= 0xDF)
          goto yy52;
        if (yych <= 0xE0)
          goto yy53;
        goto yy54;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy55;
        if (yych <= 0xEF)
          goto yy54;
        goto yy56;
      } else {
        if (yych <= 0xF3)
          goto yy57;
        if (yych <= 0xF4)
          goto yy58;
        goto yy45;
      }
    }
  yy49:
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych == '+')
          goto yy59;
        goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
        goto yy59;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
        goto yy59;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych <= 'z')
          goto yy59;
        goto yy45;
      }
    }
  yy50:
    ++p;
    { return (bufsize_t)(p - start); }
  yy52:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy45;
    if (yych <= 0xBF)
      goto yy47;
    goto yy45;
  yy53:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy45;
    if (yych <= 0xBF)
      goto yy52;
    goto yy45;
  yy54:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy45;
    if (yych <= 0xBF)
      goto yy52;
    goto yy45;
  yy55:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy45;
    if (yych <= 0x9F)
      goto yy52;
    goto yy45;
  yy56:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy45;
    if (yych <= 0xBF)
      goto yy54;
    goto yy45;
  yy57:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy45;
    if (yych <= 0xBF)
      goto yy54;
    goto yy45;
  yy58:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy45;
    if (yych <= 0x8F)
      goto yy54;
    goto yy45;
  yy59:
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    yych = *++p;
    if (yych <= '9') {
      if (yych <= ',') {
        if (yych != '+')
          goto yy45;
      } else {
        if (yych == '/')
          goto yy45;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= ':')
          goto yy47;
        if (yych <= '@')
          goto yy45;
      } else {
        if (yych <= '`')
          goto yy45;
        if (yych >= '{')
          goto yy45;
      }
    }
    ++p;
    if ((yych = *p) == ':')
      goto yy47;
    goto yy45;
  }
}

// Try to match email autolink after first <, returning num of chars matched.
bufsize_t _scan_autolink_email(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   128, 0,   128, 128, 128, 128, 128, 0,   0,
        128, 128, 0,   128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 0,   0,   0,   128, 0,   128, 0,   128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 0,   0,   0,   128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,
    };
    yych = *p;
    if (yych <= '9') {
      if (yych <= '\'') {
        if (yych == '!')
          goto yy91;
        if (yych >= '#')
          goto yy91;
      } else {
        if (yych <= ')')
          goto yy89;
        if (yych != ',')
          goto yy91;
      }
    } else {
      if (yych <= '?') {
        if (yych == '=')
          goto yy91;
        if (yych >= '?')
          goto yy91;
      } else {
        if (yych <= 'Z') {
          if (yych >= 'A')
            goto yy91;
        } else {
          if (yych <= ']')
            goto yy89;
          if (yych <= '~')
            goto yy91;
        }
      }
    }
  yy89:
    ++p;
  yy90 : { return 0; }
  yy91:
    yych = *(marker = ++p);
    if (yych <= ',') {
      if (yych <= '"') {
        if (yych == '!')
          goto yy93;
        goto yy90;
      } else {
        if (yych <= '\'')
          goto yy93;
        if (yych <= ')')
          goto yy90;
        if (yych <= '+')
          goto yy93;
        goto yy90;
      }
    } else {
      if (yych <= '>') {
        if (yych <= '9')
          goto yy93;
        if (yych == '=')
          goto yy93;
        goto yy90;
      } else {
        if (yych <= 'Z')
          goto yy93;
        if (yych <= ']')
          goto yy90;
        if (yych <= '~')
          goto yy93;
        goto yy90;
      }
    }
  yy92:
    ++p;
    yych = *p;
  yy93:
    if (yybm[0 + yych] & 128) {
      goto yy92;
    }
    if (yych <= '>')
      goto yy94;
    if (yych <= '@')
      goto yy95;
  yy94:
    p = marker;
    goto yy90;
  yy95:
    ++p;
    yych = *p;
    if (yych <= '@') {
      if (yych <= '/')
        goto yy94;
      if (yych >= ':')
        goto yy94;
    } else {
      if (yych <= 'Z')
        goto yy96;
      if (yych <= '`')
        goto yy94;
      if (yych >= '{')
        goto yy94;
    }
  yy96:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy98;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy98;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy98;
        goto yy94;
      }
    }
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy101;
      if (yych <= '/')
        goto yy94;
      goto yy102;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy102;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy102;
        goto yy94;
      }
    }
  yy98:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych <= '-')
          goto yy101;
        goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy102;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy102;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy102;
        goto yy94;
      }
    }
  yy99:
    ++p;
    { return (bufsize_t)(p - start); }
  yy101:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy103;
      if (yych <= '/')
        goto yy94;
      goto yy104;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy104;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy104;
        goto yy94;
      }
    }
  yy102:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy104;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy104;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy104;
        goto yy94;
      }
    }
  yy103:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy105;
      if (yych <= '/')
        goto yy94;
      goto yy106;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy106;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy106;
        goto yy94;
      }
    }
  yy104:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy106;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy106;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy106;
        goto yy94;
      }
    }
  yy105:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy107;
      if (yych <= '/')
        goto yy94;
      goto yy108;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy108;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy108;
        goto yy94;
      }
    }
  yy106:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy108;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy108;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy108;
        goto yy94;
      }
    }
  yy107:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy109;
      if (yych <= '/')
        goto yy94;
      goto yy110;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy110;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy110;
        goto yy94;
      }
    }
  yy108:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy110;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy110;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy110;
        goto yy94;
      }
    }
  yy109:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy111;
      if (yych <= '/')
        goto yy94;
      goto yy112;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy112;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy112;
        goto yy94;
      }
    }
  yy110:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy112;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy112;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy112;
        goto yy94;
      }
    }
  yy111:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy113;
      if (yych <= '/')
        goto yy94;
      goto yy114;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy114;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy114;
        goto yy94;
      }
    }
  yy112:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy114;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy114;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy114;
        goto yy94;
      }
    }
  yy113:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy115;
      if (yych <= '/')
        goto yy94;
      goto yy116;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy116;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy116;
        goto yy94;
      }
    }
  yy114:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy116;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy116;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy116;
        goto yy94;
      }
    }
  yy115:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy117;
      if (yych <= '/')
        goto yy94;
      goto yy118;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy118;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy118;
        goto yy94;
      }
    }
  yy116:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy118;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy118;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy118;
        goto yy94;
      }
    }
  yy117:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy119;
      if (yych <= '/')
        goto yy94;
      goto yy120;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy120;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy120;
        goto yy94;
      }
    }
  yy118:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy120;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy120;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy120;
        goto yy94;
      }
    }
  yy119:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy121;
      if (yych <= '/')
        goto yy94;
      goto yy122;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy122;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy122;
        goto yy94;
      }
    }
  yy120:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy122;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy122;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy122;
        goto yy94;
      }
    }
  yy121:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy123;
      if (yych <= '/')
        goto yy94;
      goto yy124;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy124;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy124;
        goto yy94;
      }
    }
  yy122:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy124;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy124;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy124;
        goto yy94;
      }
    }
  yy123:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy125;
      if (yych <= '/')
        goto yy94;
      goto yy126;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy126;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy126;
        goto yy94;
      }
    }
  yy124:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy126;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy126;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy126;
        goto yy94;
      }
    }
  yy125:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy127;
      if (yych <= '/')
        goto yy94;
      goto yy128;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy128;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy128;
        goto yy94;
      }
    }
  yy126:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy128;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy128;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy128;
        goto yy94;
      }
    }
  yy127:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy129;
      if (yych <= '/')
        goto yy94;
      goto yy130;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy130;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy130;
        goto yy94;
      }
    }
  yy128:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy130;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy130;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy130;
        goto yy94;
      }
    }
  yy129:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy131;
      if (yych <= '/')
        goto yy94;
      goto yy132;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy132;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy132;
        goto yy94;
      }
    }
  yy130:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy132;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy132;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy132;
        goto yy94;
      }
    }
  yy131:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy133;
      if (yych <= '/')
        goto yy94;
      goto yy134;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy134;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy134;
        goto yy94;
      }
    }
  yy132:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy134;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy134;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy134;
        goto yy94;
      }
    }
  yy133:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy135;
      if (yych <= '/')
        goto yy94;
      goto yy136;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy136;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy136;
        goto yy94;
      }
    }
  yy134:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy136;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy136;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy136;
        goto yy94;
      }
    }
  yy135:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy137;
      if (yych <= '/')
        goto yy94;
      goto yy138;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy138;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy138;
        goto yy94;
      }
    }
  yy136:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy138;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy138;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy138;
        goto yy94;
      }
    }
  yy137:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy139;
      if (yych <= '/')
        goto yy94;
      goto yy140;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy140;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy140;
        goto yy94;
      }
    }
  yy138:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy140;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy140;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy140;
        goto yy94;
      }
    }
  yy139:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy141;
      if (yych <= '/')
        goto yy94;
      goto yy142;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy142;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy142;
        goto yy94;
      }
    }
  yy140:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy142;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy142;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy142;
        goto yy94;
      }
    }
  yy141:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy143;
      if (yych <= '/')
        goto yy94;
      goto yy144;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy144;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy144;
        goto yy94;
      }
    }
  yy142:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy144;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy144;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy144;
        goto yy94;
      }
    }
  yy143:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy145;
      if (yych <= '/')
        goto yy94;
      goto yy146;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy146;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy146;
        goto yy94;
      }
    }
  yy144:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy146;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy146;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy146;
        goto yy94;
      }
    }
  yy145:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy147;
      if (yych <= '/')
        goto yy94;
      goto yy148;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy148;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy148;
        goto yy94;
      }
    }
  yy146:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy148;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy148;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy148;
        goto yy94;
      }
    }
  yy147:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy149;
      if (yych <= '/')
        goto yy94;
      goto yy150;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy150;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy150;
        goto yy94;
      }
    }
  yy148:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy150;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy150;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy150;
        goto yy94;
      }
    }
  yy149:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy151;
      if (yych <= '/')
        goto yy94;
      goto yy152;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy152;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy152;
        goto yy94;
      }
    }
  yy150:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy152;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy152;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy152;
        goto yy94;
      }
    }
  yy151:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy153;
      if (yych <= '/')
        goto yy94;
      goto yy154;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy154;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy154;
        goto yy94;
      }
    }
  yy152:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy154;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy154;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy154;
        goto yy94;
      }
    }
  yy153:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy155;
      if (yych <= '/')
        goto yy94;
      goto yy156;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy156;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy156;
        goto yy94;
      }
    }
  yy154:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy156;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy156;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy156;
        goto yy94;
      }
    }
  yy155:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy157;
      if (yych <= '/')
        goto yy94;
      goto yy158;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy158;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy158;
        goto yy94;
      }
    }
  yy156:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy158;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy158;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy158;
        goto yy94;
      }
    }
  yy157:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy159;
      if (yych <= '/')
        goto yy94;
      goto yy160;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy160;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy160;
        goto yy94;
      }
    }
  yy158:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy160;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy160;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy160;
        goto yy94;
      }
    }
  yy159:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy161;
      if (yych <= '/')
        goto yy94;
      goto yy162;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy162;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy162;
        goto yy94;
      }
    }
  yy160:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy162;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy162;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy162;
        goto yy94;
      }
    }
  yy161:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy163;
      if (yych <= '/')
        goto yy94;
      goto yy164;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy164;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy164;
        goto yy94;
      }
    }
  yy162:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy164;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy164;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy164;
        goto yy94;
      }
    }
  yy163:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy165;
      if (yych <= '/')
        goto yy94;
      goto yy166;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy166;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy166;
        goto yy94;
      }
    }
  yy164:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy166;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy166;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy166;
        goto yy94;
      }
    }
  yy165:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy167;
      if (yych <= '/')
        goto yy94;
      goto yy168;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy168;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy168;
        goto yy94;
      }
    }
  yy166:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy168;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy168;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy168;
        goto yy94;
      }
    }
  yy167:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy169;
      if (yych <= '/')
        goto yy94;
      goto yy170;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy170;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy170;
        goto yy94;
      }
    }
  yy168:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy170;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy170;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy170;
        goto yy94;
      }
    }
  yy169:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy171;
      if (yych <= '/')
        goto yy94;
      goto yy172;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy172;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy172;
        goto yy94;
      }
    }
  yy170:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy172;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy172;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy172;
        goto yy94;
      }
    }
  yy171:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy173;
      if (yych <= '/')
        goto yy94;
      goto yy174;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy174;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy174;
        goto yy94;
      }
    }
  yy172:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy174;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy174;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy174;
        goto yy94;
      }
    }
  yy173:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy175;
      if (yych <= '/')
        goto yy94;
      goto yy176;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy176;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy176;
        goto yy94;
      }
    }
  yy174:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy176;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy176;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy176;
        goto yy94;
      }
    }
  yy175:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy177;
      if (yych <= '/')
        goto yy94;
      goto yy178;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy178;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy178;
        goto yy94;
      }
    }
  yy176:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy178;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy178;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy178;
        goto yy94;
      }
    }
  yy177:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy179;
      if (yych <= '/')
        goto yy94;
      goto yy180;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy180;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy180;
        goto yy94;
      }
    }
  yy178:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy180;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy180;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy180;
        goto yy94;
      }
    }
  yy179:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy181;
      if (yych <= '/')
        goto yy94;
      goto yy182;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy182;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy182;
        goto yy94;
      }
    }
  yy180:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy182;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy182;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy182;
        goto yy94;
      }
    }
  yy181:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy183;
      if (yych <= '/')
        goto yy94;
      goto yy184;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy184;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy184;
        goto yy94;
      }
    }
  yy182:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy184;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy184;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy184;
        goto yy94;
      }
    }
  yy183:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy185;
      if (yych <= '/')
        goto yy94;
      goto yy186;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy186;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy186;
        goto yy94;
      }
    }
  yy184:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy186;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy186;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy186;
        goto yy94;
      }
    }
  yy185:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy187;
      if (yych <= '/')
        goto yy94;
      goto yy188;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy188;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy188;
        goto yy94;
      }
    }
  yy186:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy188;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy188;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy188;
        goto yy94;
      }
    }
  yy187:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy189;
      if (yych <= '/')
        goto yy94;
      goto yy190;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy190;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy190;
        goto yy94;
      }
    }
  yy188:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy190;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy190;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy190;
        goto yy94;
      }
    }
  yy189:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy191;
      if (yych <= '/')
        goto yy94;
      goto yy192;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy192;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy192;
        goto yy94;
      }
    }
  yy190:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy192;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy192;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy192;
        goto yy94;
      }
    }
  yy191:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy193;
      if (yych <= '/')
        goto yy94;
      goto yy194;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy194;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy194;
        goto yy94;
      }
    }
  yy192:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy194;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy194;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy194;
        goto yy94;
      }
    }
  yy193:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy195;
      if (yych <= '/')
        goto yy94;
      goto yy196;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy196;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy196;
        goto yy94;
      }
    }
  yy194:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy196;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy196;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy196;
        goto yy94;
      }
    }
  yy195:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy197;
      if (yych <= '/')
        goto yy94;
      goto yy198;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy198;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy198;
        goto yy94;
      }
    }
  yy196:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy198;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy198;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy198;
        goto yy94;
      }
    }
  yy197:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy199;
      if (yych <= '/')
        goto yy94;
      goto yy200;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy200;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy200;
        goto yy94;
      }
    }
  yy198:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy200;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy200;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy200;
        goto yy94;
      }
    }
  yy199:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy201;
      if (yych <= '/')
        goto yy94;
      goto yy202;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy202;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy202;
        goto yy94;
      }
    }
  yy200:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy202;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy202;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy202;
        goto yy94;
      }
    }
  yy201:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy203;
      if (yych <= '/')
        goto yy94;
      goto yy204;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy204;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy204;
        goto yy94;
      }
    }
  yy202:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy204;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy204;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy204;
        goto yy94;
      }
    }
  yy203:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy205;
      if (yych <= '/')
        goto yy94;
      goto yy206;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy206;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy206;
        goto yy94;
      }
    }
  yy204:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy206;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy206;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy206;
        goto yy94;
      }
    }
  yy205:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy207;
      if (yych <= '/')
        goto yy94;
      goto yy208;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy208;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy208;
        goto yy94;
      }
    }
  yy206:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy208;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy208;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy208;
        goto yy94;
      }
    }
  yy207:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy209;
      if (yych <= '/')
        goto yy94;
      goto yy210;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy210;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy210;
        goto yy94;
      }
    }
  yy208:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy210;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy210;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy210;
        goto yy94;
      }
    }
  yy209:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy211;
      if (yych <= '/')
        goto yy94;
      goto yy212;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy212;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy212;
        goto yy94;
      }
    }
  yy210:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy212;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy212;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy212;
        goto yy94;
      }
    }
  yy211:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy213;
      if (yych <= '/')
        goto yy94;
      goto yy214;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy214;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy214;
        goto yy94;
      }
    }
  yy212:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy214;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy214;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy214;
        goto yy94;
      }
    }
  yy213:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy215;
      if (yych <= '/')
        goto yy94;
      goto yy216;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy216;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy216;
        goto yy94;
      }
    }
  yy214:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy216;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy216;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy216;
        goto yy94;
      }
    }
  yy215:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy217;
      if (yych <= '/')
        goto yy94;
      goto yy218;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy218;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy218;
        goto yy94;
      }
    }
  yy216:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy218;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy218;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy218;
        goto yy94;
      }
    }
  yy217:
    ++p;
    yych = *p;
    if (yych <= '9') {
      if (yych == '-')
        goto yy219;
      if (yych <= '/')
        goto yy94;
      goto yy220;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy94;
        goto yy220;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy220;
        goto yy94;
      }
    }
  yy218:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= ',')
          goto yy94;
        if (yych >= '.')
          goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych <= '9')
          goto yy220;
        goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
        goto yy220;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych <= 'z')
          goto yy220;
        goto yy94;
      }
    }
  yy219:
    ++p;
    yych = *p;
    if (yych <= '@') {
      if (yych <= '/')
        goto yy94;
      if (yych <= '9')
        goto yy221;
      goto yy94;
    } else {
      if (yych <= 'Z')
        goto yy221;
      if (yych <= '`')
        goto yy94;
      if (yych <= 'z')
        goto yy221;
      goto yy94;
    }
  yy220:
    ++p;
    yych = *p;
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych <= '-')
          goto yy94;
        goto yy95;
      } else {
        if (yych <= '/')
          goto yy94;
        if (yych >= ':')
          goto yy94;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy99;
        if (yych <= '@')
          goto yy94;
      } else {
        if (yych <= '`')
          goto yy94;
        if (yych >= '{')
          goto yy94;
      }
    }
  yy221:
    ++p;
    yych = *p;
    if (yych == '.')
      goto yy95;
    if (yych == '>')
      goto yy99;
    goto yy94;
  }
}

// Try to match an HTML tag after first <, returning num of chars matched.
bufsize_t _scan_html_tag(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        /* table 1 .. 8: 0 */
        0, 250, 250, 250, 250, 250, 250, 250, 250, 235, 235, 235, 235, 235, 250,
        250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250,
        250, 250, 250, 235, 250, 202, 250, 250, 250, 250, 170, 250, 250, 250,
        250, 250, 246, 254, 250, 254, 254, 254, 254, 254, 254, 254, 254, 254,
        254, 254, 250, 234, 234, 232, 250, 250, 254, 254, 254, 254, 254, 254,
        254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254,
        254, 254, 254, 254, 254, 254, 250, 250, 122, 250, 254, 234, 254, 254,
        254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 254,
        254, 254, 254, 254, 254, 254, 254, 254, 254, 254, 250, 250, 250, 250,
        250, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        /* table 9 .. 11: 256 */
        0, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 192, 128, 128, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        192, 128, 128, 128, 128, 128, 0, 128, 224, 224, 224, 224, 224, 224, 224,
        224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224,
        224, 224, 224, 224, 224, 128, 128, 128, 128, 128, 128, 192, 192, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 128, 128, 128, 128, 128, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
    };
    yych = *p;
    if (yych <= '>') {
      if (yych <= '!') {
        if (yych >= '!')
          goto yy226;
      } else {
        if (yych == '/')
          goto yy227;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '?')
          goto yy228;
        if (yych >= 'A')
          goto yy229;
      } else {
        if (yych <= '`')
          goto yy224;
        if (yych <= 'z')
          goto yy229;
      }
    }
  yy224:
    ++p;
  yy225 : { return 0; }
  yy226:
    yych = *(marker = ++p);
    if (yybm[256 + yych] & 32) {
      goto yy232;
    }
    if (yych == '-')
      goto yy230;
    if (yych <= '@')
      goto yy225;
    if (yych <= '[')
      goto yy234;
    goto yy225;
  yy227:
    yych = *(marker = ++p);
    if (yych <= '@')
      goto yy225;
    if (yych <= 'Z')
      goto yy235;
    if (yych <= '`')
      goto yy225;
    if (yych <= 'z')
      goto yy235;
    goto yy225;
  yy228:
    yych = *(marker = ++p);
    if (yych <= 0x00)
      goto yy225;
    if (yych <= 0x7F)
      goto yy238;
    if (yych <= 0xC1)
      goto yy225;
    if (yych <= 0xF4)
      goto yy238;
    goto yy225;
  yy229:
    yych = *(marker = ++p);
    if (yybm[0 + yych] & 1) {
      goto yy247;
    }
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych == '-')
          goto yy249;
        goto yy225;
      } else {
        if (yych <= '/')
          goto yy251;
        if (yych <= '9')
          goto yy249;
        goto yy225;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy252;
        if (yych <= '@')
          goto yy225;
        goto yy249;
      } else {
        if (yych <= '`')
          goto yy225;
        if (yych <= 'z')
          goto yy249;
        goto yy225;
      }
    }
  yy230:
    yych = *++p;
    if (yych == '-')
      goto yy254;
  yy231:
    p = marker;
    goto yy225;
  yy232:
    ++p;
    yych = *p;
    if (yybm[256 + yych] & 32) {
      goto yy232;
    }
    if (yych <= 0x08)
      goto yy231;
    if (yych <= '\r')
      goto yy255;
    if (yych == ' ')
      goto yy255;
    goto yy231;
  yy234:
    yych = *++p;
    if (yych == 'C')
      goto yy257;
    if (yych == 'c')
      goto yy257;
    goto yy231;
  yy235:
    ++p;
    yych = *p;
    if (yybm[256 + yych] & 64) {
      goto yy235;
    }
    if (yych <= 0x1F) {
      if (yych <= 0x08)
        goto yy231;
      if (yych <= '\r')
        goto yy258;
      goto yy231;
    } else {
      if (yych <= ' ')
        goto yy258;
      if (yych == '>')
        goto yy252;
      goto yy231;
    }
  yy237:
    ++p;
    yych = *p;
  yy238:
    if (yybm[256 + yych] & 128) {
      goto yy237;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy231;
        if (yych >= '@')
          goto yy231;
      } else {
        if (yych <= 0xDF)
          goto yy240;
        if (yych <= 0xE0)
          goto yy241;
        goto yy242;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy243;
        if (yych <= 0xEF)
          goto yy242;
        goto yy244;
      } else {
        if (yych <= 0xF3)
          goto yy245;
        if (yych <= 0xF4)
          goto yy246;
        goto yy231;
      }
    }
    ++p;
    yych = *p;
    if (yych <= 0xE0) {
      if (yych <= '>') {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= '=')
          goto yy237;
        goto yy252;
      } else {
        if (yych <= 0x7F)
          goto yy237;
        if (yych <= 0xC1)
          goto yy231;
        if (yych >= 0xE0)
          goto yy241;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy243;
        goto yy242;
      } else {
        if (yych <= 0xF0)
          goto yy244;
        if (yych <= 0xF3)
          goto yy245;
        if (yych <= 0xF4)
          goto yy246;
        goto yy231;
      }
    }
  yy240:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy237;
    goto yy231;
  yy241:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy240;
    goto yy231;
  yy242:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy240;
    goto yy231;
  yy243:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x9F)
      goto yy240;
    goto yy231;
  yy244:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy242;
    goto yy231;
  yy245:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy242;
    goto yy231;
  yy246:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x8F)
      goto yy242;
    goto yy231;
  yy247:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 1) {
      goto yy247;
    }
    if (yych <= '>') {
      if (yych <= '9') {
        if (yych == '/')
          goto yy251;
        goto yy231;
      } else {
        if (yych <= ':')
          goto yy260;
        if (yych <= '=')
          goto yy231;
        goto yy252;
      }
    } else {
      if (yych <= '^') {
        if (yych <= '@')
          goto yy231;
        if (yych <= 'Z')
          goto yy260;
        goto yy231;
      } else {
        if (yych == '`')
          goto yy231;
        if (yych <= 'z')
          goto yy260;
        goto yy231;
      }
    }
  yy249:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 1) {
      goto yy247;
    }
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych == '-')
          goto yy249;
        goto yy231;
      } else {
        if (yych <= '/')
          goto yy251;
        if (yych <= '9')
          goto yy249;
        goto yy231;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy252;
        if (yych <= '@')
          goto yy231;
        goto yy249;
      } else {
        if (yych <= '`')
          goto yy231;
        if (yych <= 'z')
          goto yy249;
        goto yy231;
      }
    }
  yy251:
    yych = *++p;
    if (yych != '>')
      goto yy231;
  yy252:
    ++p;
    { return (bufsize_t)(p - start); }
  yy254:
    yych = *++p;
    if (yych == '-')
      goto yy264;
    if (yych == '>')
      goto yy231;
    goto yy263;
  yy255:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 2) {
      goto yy255;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= '>')
          goto yy252;
        goto yy231;
      } else {
        if (yych <= 0xDF)
          goto yy272;
        if (yych <= 0xE0)
          goto yy273;
        goto yy274;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy275;
        if (yych <= 0xEF)
          goto yy274;
        goto yy276;
      } else {
        if (yych <= 0xF3)
          goto yy277;
        if (yych <= 0xF4)
          goto yy278;
        goto yy231;
      }
    }
  yy257:
    yych = *++p;
    if (yych == 'D')
      goto yy279;
    if (yych == 'd')
      goto yy279;
    goto yy231;
  yy258:
    ++p;
    yych = *p;
    if (yych <= 0x1F) {
      if (yych <= 0x08)
        goto yy231;
      if (yych <= '\r')
        goto yy258;
      goto yy231;
    } else {
      if (yych <= ' ')
        goto yy258;
      if (yych == '>')
        goto yy252;
      goto yy231;
    }
  yy260:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 4) {
      goto yy260;
    }
    if (yych <= ',') {
      if (yych <= '\r') {
        if (yych <= 0x08)
          goto yy231;
        goto yy280;
      } else {
        if (yych == ' ')
          goto yy280;
        goto yy231;
      }
    } else {
      if (yych <= '<') {
        if (yych <= '/')
          goto yy251;
        goto yy231;
      } else {
        if (yych <= '=')
          goto yy282;
        if (yych <= '>')
          goto yy252;
        goto yy231;
      }
    }
  yy262:
    ++p;
    yych = *p;
  yy263:
    if (yybm[0 + yych] & 8) {
      goto yy262;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= '-')
          goto yy283;
        goto yy231;
      } else {
        if (yych <= 0xDF)
          goto yy265;
        if (yych <= 0xE0)
          goto yy266;
        goto yy267;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy268;
        if (yych <= 0xEF)
          goto yy267;
        goto yy269;
      } else {
        if (yych <= 0xF3)
          goto yy270;
        if (yych <= 0xF4)
          goto yy271;
        goto yy231;
      }
    }
  yy264:
    yych = *++p;
    if (yych == '-')
      goto yy251;
    if (yych == '>')
      goto yy231;
    goto yy263;
  yy265:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy262;
    goto yy231;
  yy266:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy265;
    goto yy231;
  yy267:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy265;
    goto yy231;
  yy268:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x9F)
      goto yy265;
    goto yy231;
  yy269:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy267;
    goto yy231;
  yy270:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy267;
    goto yy231;
  yy271:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x8F)
      goto yy267;
    goto yy231;
  yy272:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy255;
    goto yy231;
  yy273:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy272;
    goto yy231;
  yy274:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy272;
    goto yy231;
  yy275:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x9F)
      goto yy272;
    goto yy231;
  yy276:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy274;
    goto yy231;
  yy277:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy274;
    goto yy231;
  yy278:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x8F)
      goto yy274;
    goto yy231;
  yy279:
    yych = *++p;
    if (yych == 'A')
      goto yy284;
    if (yych == 'a')
      goto yy284;
    goto yy231;
  yy280:
    ++p;
    yych = *p;
    if (yych <= '<') {
      if (yych <= ' ') {
        if (yych <= 0x08)
          goto yy231;
        if (yych <= '\r')
          goto yy280;
        if (yych <= 0x1F)
          goto yy231;
        goto yy280;
      } else {
        if (yych <= '/') {
          if (yych <= '.')
            goto yy231;
          goto yy251;
        } else {
          if (yych == ':')
            goto yy260;
          goto yy231;
        }
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '=')
          goto yy282;
        if (yych <= '>')
          goto yy252;
        if (yych <= '@')
          goto yy231;
        goto yy260;
      } else {
        if (yych <= '_') {
          if (yych <= '^')
            goto yy231;
          goto yy260;
        } else {
          if (yych <= '`')
            goto yy231;
          if (yych <= 'z')
            goto yy260;
          goto yy231;
        }
      }
    }
  yy282:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 16) {
      goto yy285;
    }
    if (yych <= 0xE0) {
      if (yych <= '"') {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= ' ')
          goto yy287;
        goto yy288;
      } else {
        if (yych <= '\'')
          goto yy290;
        if (yych <= 0xC1)
          goto yy231;
        if (yych <= 0xDF)
          goto yy292;
        goto yy293;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy295;
        goto yy294;
      } else {
        if (yych <= 0xF0)
          goto yy296;
        if (yych <= 0xF3)
          goto yy297;
        if (yych <= 0xF4)
          goto yy298;
        goto yy231;
      }
    }
  yy283:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 8) {
      goto yy262;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= '-')
          goto yy251;
        goto yy231;
      } else {
        if (yych <= 0xDF)
          goto yy265;
        if (yych <= 0xE0)
          goto yy266;
        goto yy267;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy268;
        if (yych <= 0xEF)
          goto yy267;
        goto yy269;
      } else {
        if (yych <= 0xF3)
          goto yy270;
        if (yych <= 0xF4)
          goto yy271;
        goto yy231;
      }
    }
  yy284:
    yych = *++p;
    if (yych == 'T')
      goto yy299;
    if (yych == 't')
      goto yy299;
    goto yy231;
  yy285:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 16) {
      goto yy285;
    }
    if (yych <= 0xE0) {
      if (yych <= '=') {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= ' ')
          goto yy300;
        goto yy231;
      } else {
        if (yych <= '>')
          goto yy252;
        if (yych <= 0xC1)
          goto yy231;
        if (yych <= 0xDF)
          goto yy292;
        goto yy293;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy295;
        goto yy294;
      } else {
        if (yych <= 0xF0)
          goto yy296;
        if (yych <= 0xF3)
          goto yy297;
        if (yych <= 0xF4)
          goto yy298;
        goto yy231;
      }
    }
  yy287:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 16) {
      goto yy285;
    }
    if (yych <= 0xDF) {
      if (yych <= '\'') {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= ' ')
          goto yy302;
        if (yych >= '#')
          goto yy290;
      } else {
        if (yych == '>')
          goto yy252;
        if (yych <= 0xC1)
          goto yy231;
        goto yy292;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy293;
        if (yych == 0xED)
          goto yy295;
        goto yy294;
      } else {
        if (yych <= 0xF0)
          goto yy296;
        if (yych <= 0xF3)
          goto yy297;
        if (yych <= 0xF4)
          goto yy298;
        goto yy231;
      }
    }
  yy288:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 32) {
      goto yy288;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= '"')
          goto yy304;
        goto yy231;
      } else {
        if (yych <= 0xDF)
          goto yy305;
        if (yych <= 0xE0)
          goto yy306;
        goto yy307;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy308;
        if (yych <= 0xEF)
          goto yy307;
        goto yy309;
      } else {
        if (yych <= 0xF3)
          goto yy310;
        if (yych <= 0xF4)
          goto yy311;
        goto yy231;
      }
    }
  yy290:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy290;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= '\'')
          goto yy304;
        goto yy231;
      } else {
        if (yych <= 0xDF)
          goto yy312;
        if (yych <= 0xE0)
          goto yy313;
        goto yy314;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy315;
        if (yych <= 0xEF)
          goto yy314;
        goto yy316;
      } else {
        if (yych <= 0xF3)
          goto yy317;
        if (yych <= 0xF4)
          goto yy318;
        goto yy231;
      }
    }
  yy292:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy285;
    goto yy231;
  yy293:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy292;
    goto yy231;
  yy294:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy292;
    goto yy231;
  yy295:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x9F)
      goto yy292;
    goto yy231;
  yy296:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy294;
    goto yy231;
  yy297:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy294;
    goto yy231;
  yy298:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x8F)
      goto yy294;
    goto yy231;
  yy299:
    yych = *++p;
    if (yych == 'A')
      goto yy319;
    if (yych == 'a')
      goto yy319;
    goto yy231;
  yy300:
    ++p;
    yych = *p;
    if (yych <= '@') {
      if (yych <= '"') {
        if (yych <= '\r') {
          if (yych <= 0x00)
            goto yy231;
          if (yych <= 0x08)
            goto yy285;
          goto yy300;
        } else {
          if (yych == ' ')
            goto yy300;
          if (yych <= '!')
            goto yy285;
          goto yy231;
        }
      } else {
        if (yych <= ':') {
          if (yych == '\'')
            goto yy231;
          if (yych <= '9')
            goto yy285;
          goto yy320;
        } else {
          if (yych <= ';')
            goto yy285;
          if (yych <= '=')
            goto yy231;
          if (yych <= '>')
            goto yy252;
          goto yy285;
        }
      }
    } else {
      if (yych <= 0xDF) {
        if (yych <= '`') {
          if (yych <= 'Z')
            goto yy320;
          if (yych <= '^')
            goto yy285;
          if (yych <= '_')
            goto yy320;
          goto yy231;
        } else {
          if (yych <= 'z')
            goto yy320;
          if (yych <= 0x7F)
            goto yy285;
          if (yych <= 0xC1)
            goto yy231;
          goto yy292;
        }
      } else {
        if (yych <= 0xEF) {
          if (yych <= 0xE0)
            goto yy293;
          if (yych == 0xED)
            goto yy295;
          goto yy294;
        } else {
          if (yych <= 0xF0)
            goto yy296;
          if (yych <= 0xF3)
            goto yy297;
          if (yych <= 0xF4)
            goto yy298;
          goto yy231;
        }
      }
    }
  yy302:
    ++p;
    yych = *p;
    if (yych <= '@') {
      if (yych <= '"') {
        if (yych <= '\r') {
          if (yych <= 0x00)
            goto yy231;
          if (yych <= 0x08)
            goto yy285;
          goto yy302;
        } else {
          if (yych == ' ')
            goto yy302;
          if (yych <= '!')
            goto yy285;
          goto yy288;
        }
      } else {
        if (yych <= ':') {
          if (yych == '\'')
            goto yy290;
          if (yych <= '9')
            goto yy285;
          goto yy320;
        } else {
          if (yych <= ';')
            goto yy285;
          if (yych <= '=')
            goto yy231;
          if (yych <= '>')
            goto yy252;
          goto yy285;
        }
      }
    } else {
      if (yych <= 0xDF) {
        if (yych <= '`') {
          if (yych <= 'Z')
            goto yy320;
          if (yych <= '^')
            goto yy285;
          if (yych <= '_')
            goto yy320;
          goto yy231;
        } else {
          if (yych <= 'z')
            goto yy320;
          if (yych <= 0x7F)
            goto yy285;
          if (yych <= 0xC1)
            goto yy231;
          goto yy292;
        }
      } else {
        if (yych <= 0xEF) {
          if (yych <= 0xE0)
            goto yy293;
          if (yych == 0xED)
            goto yy295;
          goto yy294;
        } else {
          if (yych <= 0xF0)
            goto yy296;
          if (yych <= 0xF3)
            goto yy297;
          if (yych <= 0xF4)
            goto yy298;
          goto yy231;
        }
      }
    }
  yy304:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 1) {
      goto yy247;
    }
    if (yych == '/')
      goto yy251;
    if (yych == '>')
      goto yy252;
    goto yy231;
  yy305:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy288;
    goto yy231;
  yy306:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy305;
    goto yy231;
  yy307:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy305;
    goto yy231;
  yy308:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x9F)
      goto yy305;
    goto yy231;
  yy309:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy307;
    goto yy231;
  yy310:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy307;
    goto yy231;
  yy311:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x8F)
      goto yy307;
    goto yy231;
  yy312:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy290;
    goto yy231;
  yy313:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy312;
    goto yy231;
  yy314:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy312;
    goto yy231;
  yy315:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x9F)
      goto yy312;
    goto yy231;
  yy316:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy314;
    goto yy231;
  yy317:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy314;
    goto yy231;
  yy318:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x8F)
      goto yy314;
    goto yy231;
  yy319:
    yych = *++p;
    if (yych == '[')
      goto yy322;
    goto yy231;
  yy320:
    ++p;
    yych = *p;
    if (yych <= '>') {
      if (yych <= '&') {
        if (yych <= 0x1F) {
          if (yych <= 0x00)
            goto yy231;
          if (yych <= 0x08)
            goto yy285;
          if (yych <= '\r')
            goto yy324;
          goto yy285;
        } else {
          if (yych <= ' ')
            goto yy324;
          if (yych == '"')
            goto yy231;
          goto yy285;
        }
      } else {
        if (yych <= '/') {
          if (yych <= '\'')
            goto yy231;
          if (yych <= ',')
            goto yy285;
          if (yych <= '.')
            goto yy320;
          goto yy285;
        } else {
          if (yych <= ';') {
            if (yych <= ':')
              goto yy320;
            goto yy285;
          } else {
            if (yych <= '<')
              goto yy231;
            if (yych <= '=')
              goto yy282;
            goto yy252;
          }
        }
      }
    } else {
      if (yych <= 0xC1) {
        if (yych <= '_') {
          if (yych <= '@')
            goto yy285;
          if (yych <= 'Z')
            goto yy320;
          if (yych <= '^')
            goto yy285;
          goto yy320;
        } else {
          if (yych <= '`')
            goto yy231;
          if (yych <= 'z')
            goto yy320;
          if (yych <= 0x7F)
            goto yy285;
          goto yy231;
        }
      } else {
        if (yych <= 0xED) {
          if (yych <= 0xDF)
            goto yy292;
          if (yych <= 0xE0)
            goto yy293;
          if (yych <= 0xEC)
            goto yy294;
          goto yy295;
        } else {
          if (yych <= 0xF0) {
            if (yych <= 0xEF)
              goto yy294;
            goto yy296;
          } else {
            if (yych <= 0xF3)
              goto yy297;
            if (yych <= 0xF4)
              goto yy298;
            goto yy231;
          }
        }
      }
    }
  yy322:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy322;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= ']')
          goto yy326;
        goto yy231;
      } else {
        if (yych <= 0xDF)
          goto yy327;
        if (yych <= 0xE0)
          goto yy328;
        goto yy329;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy330;
        if (yych <= 0xEF)
          goto yy329;
        goto yy331;
      } else {
        if (yych <= 0xF3)
          goto yy332;
        if (yych <= 0xF4)
          goto yy333;
        goto yy231;
      }
    }
  yy324:
    ++p;
    yych = *p;
    if (yych <= '@') {
      if (yych <= '&') {
        if (yych <= 0x1F) {
          if (yych <= 0x00)
            goto yy231;
          if (yych <= 0x08)
            goto yy285;
          if (yych <= '\r')
            goto yy324;
          goto yy285;
        } else {
          if (yych <= ' ')
            goto yy324;
          if (yych == '"')
            goto yy231;
          goto yy285;
        }
      } else {
        if (yych <= ';') {
          if (yych <= '\'')
            goto yy231;
          if (yych == ':')
            goto yy320;
          goto yy285;
        } else {
          if (yych <= '<')
            goto yy231;
          if (yych <= '=')
            goto yy282;
          if (yych <= '>')
            goto yy252;
          goto yy285;
        }
      }
    } else {
      if (yych <= 0xDF) {
        if (yych <= '`') {
          if (yych <= 'Z')
            goto yy320;
          if (yych <= '^')
            goto yy285;
          if (yych <= '_')
            goto yy320;
          goto yy231;
        } else {
          if (yych <= 'z')
            goto yy320;
          if (yych <= 0x7F)
            goto yy285;
          if (yych <= 0xC1)
            goto yy231;
          goto yy292;
        }
      } else {
        if (yych <= 0xEF) {
          if (yych <= 0xE0)
            goto yy293;
          if (yych == 0xED)
            goto yy295;
          goto yy294;
        } else {
          if (yych <= 0xF0)
            goto yy296;
          if (yych <= 0xF3)
            goto yy297;
          if (yych <= 0xF4)
            goto yy298;
          goto yy231;
        }
      }
    }
  yy326:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy322;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= ']')
          goto yy334;
        goto yy231;
      } else {
        if (yych <= 0xDF)
          goto yy327;
        if (yych <= 0xE0)
          goto yy328;
        goto yy329;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy330;
        if (yych <= 0xEF)
          goto yy329;
        goto yy331;
      } else {
        if (yych <= 0xF3)
          goto yy332;
        if (yych <= 0xF4)
          goto yy333;
        goto yy231;
      }
    }
  yy327:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy322;
    goto yy231;
  yy328:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy327;
    goto yy231;
  yy329:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy327;
    goto yy231;
  yy330:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x9F)
      goto yy327;
    goto yy231;
  yy331:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy329;
    goto yy231;
  yy332:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0xBF)
      goto yy329;
    goto yy231;
  yy333:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy231;
    if (yych <= 0x8F)
      goto yy329;
    goto yy231;
  yy334:
    ++p;
    yych = *p;
    if (yych <= 0xE0) {
      if (yych <= '>') {
        if (yych <= 0x00)
          goto yy231;
        if (yych <= '=')
          goto yy322;
        goto yy252;
      } else {
        if (yych <= 0x7F)
          goto yy322;
        if (yych <= 0xC1)
          goto yy231;
        if (yych <= 0xDF)
          goto yy327;
        goto yy328;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy330;
        goto yy329;
      } else {
        if (yych <= 0xF0)
          goto yy331;
        if (yych <= 0xF3)
          goto yy332;
        if (yych <= 0xF4)
          goto yy333;
        goto yy231;
      }
    }
  }
}

// Try to match an HTML block tag start line, returning
// an integer code for the type of block (1-6, matching the spec).
// #7 is handled by a separate function, below.
bufsize_t _scan_html_block_start(const unsigned char *p) {
  const unsigned char *marker = NULL;

  {
    unsigned char yych;
    yych = *p;
    if (yych == '<')
      goto yy339;
    ++p;
  yy338 : { return 0; }
  yy339:
    yych = *(marker = ++p);
    switch (yych) {
    case '!':
      goto yy340;
    case '/':
      goto yy342;
    case '?':
      goto yy343;
    case 'A':
    case 'a':
      goto yy345;
    case 'B':
    case 'b':
      goto yy346;
    case 'C':
    case 'c':
      goto yy347;
    case 'D':
    case 'd':
      goto yy348;
    case 'F':
    case 'f':
      goto yy349;
    case 'H':
    case 'h':
      goto yy350;
    case 'I':
    case 'i':
      goto yy351;
    case 'L':
    case 'l':
      goto yy352;
    case 'M':
    case 'm':
      goto yy353;
    case 'N':
    case 'n':
      goto yy354;
    case 'O':
    case 'o':
      goto yy355;
    case 'P':
    case 'p':
      goto yy356;
    case 'S':
    case 's':
      goto yy357;
    case 'T':
    case 't':
      goto yy358;
    case 'U':
    case 'u':
      goto yy359;
    default:
      goto yy338;
    }
  yy340:
    yych = *++p;
    if (yych <= '@') {
      if (yych == '-')
        goto yy360;
    } else {
      if (yych <= 'Z')
        goto yy361;
      if (yych <= '[')
        goto yy363;
    }
  yy341:
    p = marker;
    goto yy338;
  yy342:
    yych = *++p;
    switch (yych) {
    case 'A':
    case 'a':
      goto yy345;
    case 'B':
    case 'b':
      goto yy346;
    case 'C':
    case 'c':
      goto yy347;
    case 'D':
    case 'd':
      goto yy348;
    case 'F':
    case 'f':
      goto yy349;
    case 'H':
    case 'h':
      goto yy350;
    case 'I':
    case 'i':
      goto yy351;
    case 'L':
    case 'l':
      goto yy352;
    case 'M':
    case 'm':
      goto yy353;
    case 'N':
    case 'n':
      goto yy354;
    case 'O':
    case 'o':
      goto yy355;
    case 'P':
    case 'p':
      goto yy364;
    case 'S':
    case 's':
      goto yy365;
    case 'T':
    case 't':
      goto yy358;
    case 'U':
    case 'u':
      goto yy359;
    default:
      goto yy341;
    }
  yy343:
    ++p;
    { return 3; }
  yy345:
    yych = *++p;
    if (yych <= 'S') {
      if (yych <= 'D') {
        if (yych <= 'C')
          goto yy341;
        goto yy366;
      } else {
        if (yych <= 'Q')
          goto yy341;
        if (yych <= 'R')
          goto yy367;
        goto yy368;
      }
    } else {
      if (yych <= 'q') {
        if (yych == 'd')
          goto yy366;
        goto yy341;
      } else {
        if (yych <= 'r')
          goto yy367;
        if (yych <= 's')
          goto yy368;
        goto yy341;
      }
    }
  yy346:
    yych = *++p;
    if (yych <= 'O') {
      if (yych <= 'K') {
        if (yych == 'A')
          goto yy369;
        goto yy341;
      } else {
        if (yych <= 'L')
          goto yy370;
        if (yych <= 'N')
          goto yy341;
        goto yy371;
      }
    } else {
      if (yych <= 'k') {
        if (yych == 'a')
          goto yy369;
        goto yy341;
      } else {
        if (yych <= 'l')
          goto yy370;
        if (yych == 'o')
          goto yy371;
        goto yy341;
      }
    }
  yy347:
    yych = *++p;
    if (yych <= 'O') {
      if (yych <= 'D') {
        if (yych == 'A')
          goto yy372;
        goto yy341;
      } else {
        if (yych <= 'E')
          goto yy373;
        if (yych <= 'N')
          goto yy341;
        goto yy374;
      }
    } else {
      if (yych <= 'd') {
        if (yych == 'a')
          goto yy372;
        goto yy341;
      } else {
        if (yych <= 'e')
          goto yy373;
        if (yych == 'o')
          goto yy374;
        goto yy341;
      }
    }
  yy348:
    yych = *++p;
    switch (yych) {
    case 'D':
    case 'L':
    case 'T':
    case 'd':
    case 'l':
    case 't':
      goto yy375;
    case 'E':
    case 'e':
      goto yy376;
    case 'I':
    case 'i':
      goto yy377;
    default:
      goto yy341;
    }
  yy349:
    yych = *++p;
    if (yych <= 'R') {
      if (yych <= 'N') {
        if (yych == 'I')
          goto yy378;
        goto yy341;
      } else {
        if (yych <= 'O')
          goto yy379;
        if (yych <= 'Q')
          goto yy341;
        goto yy380;
      }
    } else {
      if (yych <= 'n') {
        if (yych == 'i')
          goto yy378;
        goto yy341;
      } else {
        if (yych <= 'o')
          goto yy379;
        if (yych == 'r')
          goto yy380;
        goto yy341;
      }
    }
  yy350:
    yych = *++p;
    if (yych <= 'S') {
      if (yych <= 'D') {
        if (yych <= '0')
          goto yy341;
        if (yych <= '6')
          goto yy375;
        goto yy341;
      } else {
        if (yych <= 'E')
          goto yy381;
        if (yych == 'R')
          goto yy375;
        goto yy341;
      }
    } else {
      if (yych <= 'q') {
        if (yych <= 'T')
          goto yy382;
        if (yych == 'e')
          goto yy381;
        goto yy341;
      } else {
        if (yych <= 'r')
          goto yy375;
        if (yych == 't')
          goto yy382;
        goto yy341;
      }
    }
  yy351:
    yych = *++p;
    if (yych == 'F')
      goto yy383;
    if (yych == 'f')
      goto yy383;
    goto yy341;
  yy352:
    yych = *++p;
    if (yych <= 'I') {
      if (yych == 'E')
        goto yy384;
      if (yych <= 'H')
        goto yy341;
      goto yy385;
    } else {
      if (yych <= 'e') {
        if (yych <= 'd')
          goto yy341;
        goto yy384;
      } else {
        if (yych == 'i')
          goto yy385;
        goto yy341;
      }
    }
  yy353:
    yych = *++p;
    if (yych <= 'E') {
      if (yych == 'A')
        goto yy386;
      if (yych <= 'D')
        goto yy341;
      goto yy387;
    } else {
      if (yych <= 'a') {
        if (yych <= '`')
          goto yy341;
        goto yy386;
      } else {
        if (yych == 'e')
          goto yy387;
        goto yy341;
      }
    }
  yy354:
    yych = *++p;
    if (yych <= 'O') {
      if (yych == 'A')
        goto yy388;
      if (yych <= 'N')
        goto yy341;
      goto yy389;
    } else {
      if (yych <= 'a') {
        if (yych <= '`')
          goto yy341;
        goto yy388;
      } else {
        if (yych == 'o')
          goto yy389;
        goto yy341;
      }
    }
  yy355:
    yych = *++p;
    if (yych <= 'P') {
      if (yych == 'L')
        goto yy375;
      if (yych <= 'O')
        goto yy341;
      goto yy390;
    } else {
      if (yych <= 'l') {
        if (yych <= 'k')
          goto yy341;
        goto yy375;
      } else {
        if (yych == 'p')
          goto yy390;
        goto yy341;
      }
    }
  yy356:
    yych = *++p;
    if (yych <= '>') {
      if (yych <= ' ') {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        if (yych <= 0x1F)
          goto yy341;
        goto yy391;
      } else {
        if (yych == '/')
          goto yy393;
        if (yych <= '=')
          goto yy341;
        goto yy391;
      }
    } else {
      if (yych <= 'R') {
        if (yych == 'A')
          goto yy394;
        if (yych <= 'Q')
          goto yy341;
        goto yy395;
      } else {
        if (yych <= 'a') {
          if (yych <= '`')
            goto yy341;
          goto yy394;
        } else {
          if (yych == 'r')
            goto yy395;
          goto yy341;
        }
      }
    }
  yy357:
    yych = *++p;
    switch (yych) {
    case 'C':
    case 'c':
      goto yy396;
    case 'E':
    case 'e':
      goto yy397;
    case 'O':
    case 'o':
      goto yy398;
    case 'T':
    case 't':
      goto yy399;
    case 'U':
    case 'u':
      goto yy400;
    default:
      goto yy341;
    }
  yy358:
    yych = *++p;
    switch (yych) {
    case 'A':
    case 'a':
      goto yy401;
    case 'B':
    case 'b':
      goto yy402;
    case 'D':
    case 'd':
      goto yy375;
    case 'F':
    case 'f':
      goto yy403;
    case 'H':
    case 'h':
      goto yy404;
    case 'I':
    case 'i':
      goto yy405;
    case 'R':
    case 'r':
      goto yy406;
    default:
      goto yy341;
    }
  yy359:
    yych = *++p;
    if (yych == 'L')
      goto yy375;
    if (yych == 'l')
      goto yy375;
    goto yy341;
  yy360:
    yych = *++p;
    if (yych == '-')
      goto yy407;
    goto yy341;
  yy361:
    ++p;
    { return 4; }
  yy363:
    yych = *++p;
    if (yych == 'C')
      goto yy409;
    if (yych == 'c')
      goto yy409;
    goto yy341;
  yy364:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= '@') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'A')
          goto yy394;
        if (yych == 'a')
          goto yy394;
        goto yy341;
      }
    }
  yy365:
    yych = *++p;
    if (yych <= 'U') {
      if (yych <= 'N') {
        if (yych == 'E')
          goto yy397;
        goto yy341;
      } else {
        if (yych <= 'O')
          goto yy398;
        if (yych <= 'T')
          goto yy341;
        goto yy400;
      }
    } else {
      if (yych <= 'n') {
        if (yych == 'e')
          goto yy397;
        goto yy341;
      } else {
        if (yych <= 'o')
          goto yy398;
        if (yych == 'u')
          goto yy400;
        goto yy341;
      }
    }
  yy366:
    yych = *++p;
    if (yych == 'D')
      goto yy410;
    if (yych == 'd')
      goto yy410;
    goto yy341;
  yy367:
    yych = *++p;
    if (yych == 'T')
      goto yy411;
    if (yych == 't')
      goto yy411;
    goto yy341;
  yy368:
    yych = *++p;
    if (yych == 'I')
      goto yy412;
    if (yych == 'i')
      goto yy412;
    goto yy341;
  yy369:
    yych = *++p;
    if (yych == 'S')
      goto yy413;
    if (yych == 's')
      goto yy413;
    goto yy341;
  yy370:
    yych = *++p;
    if (yych == 'O')
      goto yy414;
    if (yych == 'o')
      goto yy414;
    goto yy341;
  yy371:
    yych = *++p;
    if (yych == 'D')
      goto yy415;
    if (yych == 'd')
      goto yy415;
    goto yy341;
  yy372:
    yych = *++p;
    if (yych == 'P')
      goto yy416;
    if (yych == 'p')
      goto yy416;
    goto yy341;
  yy373:
    yych = *++p;
    if (yych == 'N')
      goto yy417;
    if (yych == 'n')
      goto yy417;
    goto yy341;
  yy374:
    yych = *++p;
    if (yych == 'L')
      goto yy418;
    if (yych == 'l')
      goto yy418;
    goto yy341;
  yy375:
    yych = *++p;
    if (yych <= ' ') {
      if (yych <= 0x08)
        goto yy341;
      if (yych <= '\r')
        goto yy391;
      if (yych <= 0x1F)
        goto yy341;
      goto yy391;
    } else {
      if (yych <= '/') {
        if (yych <= '.')
          goto yy341;
        goto yy393;
      } else {
        if (yych == '>')
          goto yy391;
        goto yy341;
      }
    }
  yy376:
    yych = *++p;
    if (yych == 'T')
      goto yy419;
    if (yych == 't')
      goto yy419;
    goto yy341;
  yy377:
    yych = *++p;
    if (yych <= 'V') {
      if (yych <= 'Q') {
        if (yych == 'A')
          goto yy420;
        goto yy341;
      } else {
        if (yych <= 'R')
          goto yy375;
        if (yych <= 'U')
          goto yy341;
        goto yy375;
      }
    } else {
      if (yych <= 'q') {
        if (yych == 'a')
          goto yy420;
        goto yy341;
      } else {
        if (yych <= 'r')
          goto yy375;
        if (yych == 'v')
          goto yy375;
        goto yy341;
      }
    }
  yy378:
    yych = *++p;
    if (yych <= 'G') {
      if (yych == 'E')
        goto yy421;
      if (yych <= 'F')
        goto yy341;
      goto yy422;
    } else {
      if (yych <= 'e') {
        if (yych <= 'd')
          goto yy341;
        goto yy421;
      } else {
        if (yych == 'g')
          goto yy422;
        goto yy341;
      }
    }
  yy379:
    yych = *++p;
    if (yych <= 'R') {
      if (yych == 'O')
        goto yy417;
      if (yych <= 'Q')
        goto yy341;
      goto yy423;
    } else {
      if (yych <= 'o') {
        if (yych <= 'n')
          goto yy341;
        goto yy417;
      } else {
        if (yych == 'r')
          goto yy423;
        goto yy341;
      }
    }
  yy380:
    yych = *++p;
    if (yych == 'A')
      goto yy424;
    if (yych == 'a')
      goto yy424;
    goto yy341;
  yy381:
    yych = *++p;
    if (yych == 'A')
      goto yy425;
    if (yych == 'a')
      goto yy425;
    goto yy341;
  yy382:
    yych = *++p;
    if (yych == 'M')
      goto yy359;
    if (yych == 'm')
      goto yy359;
    goto yy341;
  yy383:
    yych = *++p;
    if (yych == 'R')
      goto yy426;
    if (yych == 'r')
      goto yy426;
    goto yy341;
  yy384:
    yych = *++p;
    if (yych == 'G')
      goto yy427;
    if (yych == 'g')
      goto yy427;
    goto yy341;
  yy385:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= 'M') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'N')
          goto yy428;
        if (yych == 'n')
          goto yy428;
        goto yy341;
      }
    }
  yy386:
    yych = *++p;
    if (yych == 'I')
      goto yy429;
    if (yych == 'i')
      goto yy429;
    goto yy341;
  yy387:
    yych = *++p;
    if (yych <= 'T') {
      if (yych == 'N')
        goto yy430;
      if (yych <= 'S')
        goto yy341;
      goto yy431;
    } else {
      if (yych <= 'n') {
        if (yych <= 'm')
          goto yy341;
        goto yy430;
      } else {
        if (yych == 't')
          goto yy431;
        goto yy341;
      }
    }
  yy388:
    yych = *++p;
    if (yych == 'V')
      goto yy375;
    if (yych == 'v')
      goto yy375;
    goto yy341;
  yy389:
    yych = *++p;
    if (yych == 'F')
      goto yy432;
    if (yych == 'f')
      goto yy432;
    goto yy341;
  yy390:
    yych = *++p;
    if (yych == 'T')
      goto yy433;
    if (yych == 't')
      goto yy433;
    goto yy341;
  yy391:
    ++p;
    { return 6; }
  yy393:
    yych = *++p;
    if (yych == '>')
      goto yy391;
    goto yy341;
  yy394:
    yych = *++p;
    if (yych == 'R')
      goto yy434;
    if (yych == 'r')
      goto yy434;
    goto yy341;
  yy395:
    yych = *++p;
    if (yych == 'E')
      goto yy435;
    if (yych == 'e')
      goto yy435;
    goto yy341;
  yy396:
    yych = *++p;
    if (yych == 'R')
      goto yy436;
    if (yych == 'r')
      goto yy436;
    goto yy341;
  yy397:
    yych = *++p;
    if (yych == 'C')
      goto yy416;
    if (yych == 'c')
      goto yy416;
    goto yy341;
  yy398:
    yych = *++p;
    if (yych == 'U')
      goto yy437;
    if (yych == 'u')
      goto yy437;
    goto yy341;
  yy399:
    yych = *++p;
    if (yych == 'Y')
      goto yy438;
    if (yych == 'y')
      goto yy438;
    goto yy341;
  yy400:
    yych = *++p;
    if (yych == 'M')
      goto yy439;
    if (yych == 'm')
      goto yy439;
    goto yy341;
  yy401:
    yych = *++p;
    if (yych == 'B')
      goto yy440;
    if (yych == 'b')
      goto yy440;
    goto yy341;
  yy402:
    yych = *++p;
    if (yych == 'O')
      goto yy371;
    if (yych == 'o')
      goto yy371;
    goto yy341;
  yy403:
    yych = *++p;
    if (yych == 'O')
      goto yy441;
    if (yych == 'o')
      goto yy441;
    goto yy341;
  yy404:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= 'D') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'E')
          goto yy442;
        if (yych == 'e')
          goto yy442;
        goto yy341;
      }
    }
  yy405:
    yych = *++p;
    if (yych == 'T')
      goto yy440;
    if (yych == 't')
      goto yy440;
    goto yy341;
  yy406:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= '@') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'A')
          goto yy443;
        if (yych == 'a')
          goto yy443;
        goto yy341;
      }
    }
  yy407:
    ++p;
    { return 2; }
  yy409:
    yych = *++p;
    if (yych == 'D')
      goto yy444;
    if (yych == 'd')
      goto yy444;
    goto yy341;
  yy410:
    yych = *++p;
    if (yych == 'R')
      goto yy445;
    if (yych == 'r')
      goto yy445;
    goto yy341;
  yy411:
    yych = *++p;
    if (yych == 'I')
      goto yy446;
    if (yych == 'i')
      goto yy446;
    goto yy341;
  yy412:
    yych = *++p;
    if (yych == 'D')
      goto yy447;
    if (yych == 'd')
      goto yy447;
    goto yy341;
  yy413:
    yych = *++p;
    if (yych == 'E')
      goto yy448;
    if (yych == 'e')
      goto yy448;
    goto yy341;
  yy414:
    yych = *++p;
    if (yych == 'C')
      goto yy449;
    if (yych == 'c')
      goto yy449;
    goto yy341;
  yy415:
    yych = *++p;
    if (yych == 'Y')
      goto yy375;
    if (yych == 'y')
      goto yy375;
    goto yy341;
  yy416:
    yych = *++p;
    if (yych == 'T')
      goto yy450;
    if (yych == 't')
      goto yy450;
    goto yy341;
  yy417:
    yych = *++p;
    if (yych == 'T')
      goto yy451;
    if (yych == 't')
      goto yy451;
    goto yy341;
  yy418:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= 'F') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'G')
          goto yy452;
        if (yych == 'g')
          goto yy452;
        goto yy341;
      }
    }
  yy419:
    yych = *++p;
    if (yych == 'A')
      goto yy453;
    if (yych == 'a')
      goto yy453;
    goto yy341;
  yy420:
    yych = *++p;
    if (yych == 'L')
      goto yy454;
    if (yych == 'l')
      goto yy454;
    goto yy341;
  yy421:
    yych = *++p;
    if (yych == 'L')
      goto yy455;
    if (yych == 'l')
      goto yy455;
    goto yy341;
  yy422:
    yych = *++p;
    if (yych <= 'U') {
      if (yych == 'C')
        goto yy456;
      if (yych <= 'T')
        goto yy341;
      goto yy457;
    } else {
      if (yych <= 'c') {
        if (yych <= 'b')
          goto yy341;
        goto yy456;
      } else {
        if (yych == 'u')
          goto yy457;
        goto yy341;
      }
    }
  yy423:
    yych = *++p;
    if (yych == 'M')
      goto yy375;
    if (yych == 'm')
      goto yy375;
    goto yy341;
  yy424:
    yych = *++p;
    if (yych == 'M')
      goto yy458;
    if (yych == 'm')
      goto yy458;
    goto yy341;
  yy425:
    yych = *++p;
    if (yych == 'D')
      goto yy459;
    if (yych == 'd')
      goto yy459;
    goto yy341;
  yy426:
    yych = *++p;
    if (yych == 'A')
      goto yy460;
    if (yych == 'a')
      goto yy460;
    goto yy341;
  yy427:
    yych = *++p;
    if (yych == 'E')
      goto yy461;
    if (yych == 'e')
      goto yy461;
    goto yy341;
  yy428:
    yych = *++p;
    if (yych == 'K')
      goto yy375;
    if (yych == 'k')
      goto yy375;
    goto yy341;
  yy429:
    yych = *++p;
    if (yych == 'N')
      goto yy375;
    if (yych == 'n')
      goto yy375;
    goto yy341;
  yy430:
    yych = *++p;
    if (yych == 'U')
      goto yy462;
    if (yych == 'u')
      goto yy462;
    goto yy341;
  yy431:
    yych = *++p;
    if (yych == 'A')
      goto yy375;
    if (yych == 'a')
      goto yy375;
    goto yy341;
  yy432:
    yych = *++p;
    if (yych == 'R')
      goto yy463;
    if (yych == 'r')
      goto yy463;
    goto yy341;
  yy433:
    yych = *++p;
    if (yych <= 'I') {
      if (yych == 'G')
        goto yy452;
      if (yych <= 'H')
        goto yy341;
      goto yy464;
    } else {
      if (yych <= 'g') {
        if (yych <= 'f')
          goto yy341;
        goto yy452;
      } else {
        if (yych == 'i')
          goto yy464;
        goto yy341;
      }
    }
  yy434:
    yych = *++p;
    if (yych == 'A')
      goto yy423;
    if (yych == 'a')
      goto yy423;
    goto yy341;
  yy435:
    yych = *++p;
    if (yych <= 0x1F) {
      if (yych <= 0x08)
        goto yy341;
      if (yych <= '\r')
        goto yy465;
      goto yy341;
    } else {
      if (yych <= ' ')
        goto yy465;
      if (yych == '>')
        goto yy465;
      goto yy341;
    }
  yy436:
    yych = *++p;
    if (yych == 'I')
      goto yy467;
    if (yych == 'i')
      goto yy467;
    goto yy341;
  yy437:
    yych = *++p;
    if (yych == 'R')
      goto yy468;
    if (yych == 'r')
      goto yy468;
    goto yy341;
  yy438:
    yych = *++p;
    if (yych == 'L')
      goto yy395;
    if (yych == 'l')
      goto yy395;
    goto yy341;
  yy439:
    yych = *++p;
    if (yych == 'M')
      goto yy469;
    if (yych == 'm')
      goto yy469;
    goto yy341;
  yy440:
    yych = *++p;
    if (yych == 'L')
      goto yy447;
    if (yych == 'l')
      goto yy447;
    goto yy341;
  yy441:
    yych = *++p;
    if (yych == 'O')
      goto yy470;
    if (yych == 'o')
      goto yy470;
    goto yy341;
  yy442:
    yych = *++p;
    if (yych == 'A')
      goto yy471;
    if (yych == 'a')
      goto yy471;
    goto yy341;
  yy443:
    yych = *++p;
    if (yych == 'C')
      goto yy428;
    if (yych == 'c')
      goto yy428;
    goto yy341;
  yy444:
    yych = *++p;
    if (yych == 'A')
      goto yy472;
    if (yych == 'a')
      goto yy472;
    goto yy341;
  yy445:
    yych = *++p;
    if (yych == 'E')
      goto yy473;
    if (yych == 'e')
      goto yy473;
    goto yy341;
  yy446:
    yych = *++p;
    if (yych == 'C')
      goto yy440;
    if (yych == 'c')
      goto yy440;
    goto yy341;
  yy447:
    yych = *++p;
    if (yych == 'E')
      goto yy375;
    if (yych == 'e')
      goto yy375;
    goto yy341;
  yy448:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= 'E') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'F')
          goto yy474;
        if (yych == 'f')
          goto yy474;
        goto yy341;
      }
    }
  yy449:
    yych = *++p;
    if (yych == 'K')
      goto yy475;
    if (yych == 'k')
      goto yy475;
    goto yy341;
  yy450:
    yych = *++p;
    if (yych == 'I')
      goto yy464;
    if (yych == 'i')
      goto yy464;
    goto yy341;
  yy451:
    yych = *++p;
    if (yych == 'E')
      goto yy476;
    if (yych == 'e')
      goto yy476;
    goto yy341;
  yy452:
    yych = *++p;
    if (yych == 'R')
      goto yy477;
    if (yych == 'r')
      goto yy477;
    goto yy341;
  yy453:
    yych = *++p;
    if (yych == 'I')
      goto yy478;
    if (yych == 'i')
      goto yy478;
    goto yy341;
  yy454:
    yych = *++p;
    if (yych == 'O')
      goto yy479;
    if (yych == 'o')
      goto yy479;
    goto yy341;
  yy455:
    yych = *++p;
    if (yych == 'D')
      goto yy480;
    if (yych == 'd')
      goto yy480;
    goto yy341;
  yy456:
    yych = *++p;
    if (yych == 'A')
      goto yy372;
    if (yych == 'a')
      goto yy372;
    goto yy341;
  yy457:
    yych = *++p;
    if (yych == 'R')
      goto yy447;
    if (yych == 'r')
      goto yy447;
    goto yy341;
  yy458:
    yych = *++p;
    if (yych == 'E')
      goto yy481;
    if (yych == 'e')
      goto yy481;
    goto yy341;
  yy459:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= 'D') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'E')
          goto yy476;
        if (yych == 'e')
          goto yy476;
        goto yy341;
      }
    }
  yy460:
    yych = *++p;
    if (yych == 'M')
      goto yy447;
    if (yych == 'm')
      goto yy447;
    goto yy341;
  yy461:
    yych = *++p;
    if (yych == 'N')
      goto yy471;
    if (yych == 'n')
      goto yy471;
    goto yy341;
  yy462:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= 'H') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'I')
          goto yy482;
        if (yych == 'i')
          goto yy482;
        goto yy341;
      }
    }
  yy463:
    yych = *++p;
    if (yych == 'A')
      goto yy483;
    if (yych == 'a')
      goto yy483;
    goto yy341;
  yy464:
    yych = *++p;
    if (yych == 'O')
      goto yy429;
    if (yych == 'o')
      goto yy429;
    goto yy341;
  yy465:
    ++p;
    { return 1; }
  yy467:
    yych = *++p;
    if (yych == 'P')
      goto yy484;
    if (yych == 'p')
      goto yy484;
    goto yy341;
  yy468:
    yych = *++p;
    if (yych == 'C')
      goto yy447;
    if (yych == 'c')
      goto yy447;
    goto yy341;
  yy469:
    yych = *++p;
    if (yych == 'A')
      goto yy485;
    if (yych == 'a')
      goto yy485;
    goto yy341;
  yy470:
    yych = *++p;
    if (yych == 'T')
      goto yy375;
    if (yych == 't')
      goto yy375;
    goto yy341;
  yy471:
    yych = *++p;
    if (yych == 'D')
      goto yy375;
    if (yych == 'd')
      goto yy375;
    goto yy341;
  yy472:
    yych = *++p;
    if (yych == 'T')
      goto yy486;
    if (yych == 't')
      goto yy486;
    goto yy341;
  yy473:
    yych = *++p;
    if (yych == 'S')
      goto yy487;
    if (yych == 's')
      goto yy487;
    goto yy341;
  yy474:
    yych = *++p;
    if (yych == 'O')
      goto yy488;
    if (yych == 'o')
      goto yy488;
    goto yy341;
  yy475:
    yych = *++p;
    if (yych == 'Q')
      goto yy489;
    if (yych == 'q')
      goto yy489;
    goto yy341;
  yy476:
    yych = *++p;
    if (yych == 'R')
      goto yy375;
    if (yych == 'r')
      goto yy375;
    goto yy341;
  yy477:
    yych = *++p;
    if (yych == 'O')
      goto yy490;
    if (yych == 'o')
      goto yy490;
    goto yy341;
  yy478:
    yych = *++p;
    if (yych == 'L')
      goto yy487;
    if (yych == 'l')
      goto yy487;
    goto yy341;
  yy479:
    yych = *++p;
    if (yych == 'G')
      goto yy375;
    if (yych == 'g')
      goto yy375;
    goto yy341;
  yy480:
    yych = *++p;
    if (yych == 'S')
      goto yy491;
    if (yych == 's')
      goto yy491;
    goto yy341;
  yy481:
    yych = *++p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy341;
        if (yych <= '\r')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= ' ')
          goto yy391;
        if (yych <= '.')
          goto yy341;
        goto yy393;
      }
    } else {
      if (yych <= 'R') {
        if (yych == '>')
          goto yy391;
        goto yy341;
      } else {
        if (yych <= 'S')
          goto yy491;
        if (yych == 's')
          goto yy491;
        goto yy341;
      }
    }
  yy482:
    yych = *++p;
    if (yych == 'T')
      goto yy492;
    if (yych == 't')
      goto yy492;
    goto yy341;
  yy483:
    yych = *++p;
    if (yych == 'M')
      goto yy493;
    if (yych == 'm')
      goto yy493;
    goto yy341;
  yy484:
    yych = *++p;
    if (yych == 'T')
      goto yy435;
    if (yych == 't')
      goto yy435;
    goto yy341;
  yy485:
    yych = *++p;
    if (yych == 'R')
      goto yy415;
    if (yych == 'r')
      goto yy415;
    goto yy341;
  yy486:
    yych = *++p;
    if (yych == 'A')
      goto yy494;
    if (yych == 'a')
      goto yy494;
    goto yy341;
  yy487:
    yych = *++p;
    if (yych == 'S')
      goto yy375;
    if (yych == 's')
      goto yy375;
    goto yy341;
  yy488:
    yych = *++p;
    if (yych == 'N')
      goto yy470;
    if (yych == 'n')
      goto yy470;
    goto yy341;
  yy489:
    yych = *++p;
    if (yych == 'U')
      goto yy495;
    if (yych == 'u')
      goto yy495;
    goto yy341;
  yy490:
    yych = *++p;
    if (yych == 'U')
      goto yy496;
    if (yych == 'u')
      goto yy496;
    goto yy341;
  yy491:
    yych = *++p;
    if (yych == 'E')
      goto yy470;
    if (yych == 'e')
      goto yy470;
    goto yy341;
  yy492:
    yych = *++p;
    if (yych == 'E')
      goto yy423;
    if (yych == 'e')
      goto yy423;
    goto yy341;
  yy493:
    yych = *++p;
    if (yych == 'E')
      goto yy487;
    if (yych == 'e')
      goto yy487;
    goto yy341;
  yy494:
    yych = *++p;
    if (yych == '[')
      goto yy497;
    goto yy341;
  yy495:
    yych = *++p;
    if (yych == 'O')
      goto yy499;
    if (yych == 'o')
      goto yy499;
    goto yy341;
  yy496:
    yych = *++p;
    if (yych == 'P')
      goto yy375;
    if (yych == 'p')
      goto yy375;
    goto yy341;
  yy497:
    ++p;
    { return 5; }
  yy499:
    ++p;
    if ((yych = *p) == 'T')
      goto yy447;
    if (yych == 't')
      goto yy447;
    goto yy341;
  }
}

// Try to match an HTML block tag start line of type 7, returning
// 7 if successful, 0 if not.
bufsize_t _scan_html_block_start_7(const unsigned char *p) {
  const unsigned char *marker = NULL;

  {
    unsigned char yych;
    unsigned int yyaccept = 0;
    static const unsigned char yybm[] = {
        0,   224, 224, 224, 224, 224, 224, 224, 224, 198, 210, 194, 198, 194,
        224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224, 224,
        224, 224, 224, 224, 198, 224, 128, 224, 224, 224, 224, 64,  224, 224,
        224, 224, 224, 233, 232, 224, 233, 233, 233, 233, 233, 233, 233, 233,
        233, 233, 232, 224, 192, 192, 192, 224, 224, 233, 233, 233, 233, 233,
        233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233,
        233, 233, 233, 233, 233, 233, 233, 224, 224, 224, 224, 232, 192, 233,
        233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233,
        233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 233, 224, 224, 224,
        224, 224, 0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,
    };
    yych = *p;
    if (yych == '<')
      goto yy504;
    ++p;
  yy503 : { return 0; }
  yy504:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= '@') {
      if (yych != '/')
        goto yy503;
    } else {
      if (yych <= 'Z')
        goto yy507;
      if (yych <= '`')
        goto yy503;
      if (yych <= 'z')
        goto yy507;
      goto yy503;
    }
    yych = *++p;
    if (yych <= '@')
      goto yy506;
    if (yych <= 'Z')
      goto yy509;
    if (yych <= '`')
      goto yy506;
    if (yych <= 'z')
      goto yy509;
  yy506:
    p = marker;
    if (yyaccept == 0) {
      goto yy503;
    } else {
      goto yy522;
    }
  yy507:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 2) {
      goto yy511;
    }
    if (yych <= '=') {
      if (yych <= '.') {
        if (yych == '-')
          goto yy507;
        goto yy506;
      } else {
        if (yych <= '/')
          goto yy513;
        if (yych <= '9')
          goto yy507;
        goto yy506;
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '>')
          goto yy514;
        if (yych <= '@')
          goto yy506;
        goto yy507;
      } else {
        if (yych <= '`')
          goto yy506;
        if (yych <= 'z')
          goto yy507;
        goto yy506;
      }
    }
  yy509:
    ++p;
    yych = *p;
    if (yych <= '/') {
      if (yych <= 0x1F) {
        if (yych <= 0x08)
          goto yy506;
        if (yych <= '\r')
          goto yy516;
        goto yy506;
      } else {
        if (yych <= ' ')
          goto yy516;
        if (yych == '-')
          goto yy509;
        goto yy506;
      }
    } else {
      if (yych <= '@') {
        if (yych <= '9')
          goto yy509;
        if (yych == '>')
          goto yy514;
        goto yy506;
      } else {
        if (yych <= 'Z')
          goto yy509;
        if (yych <= '`')
          goto yy506;
        if (yych <= 'z')
          goto yy509;
        goto yy506;
      }
    }
  yy511:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 2) {
      goto yy511;
    }
    if (yych <= '>') {
      if (yych <= '9') {
        if (yych != '/')
          goto yy506;
      } else {
        if (yych <= ':')
          goto yy518;
        if (yych <= '=')
          goto yy506;
        goto yy514;
      }
    } else {
      if (yych <= '^') {
        if (yych <= '@')
          goto yy506;
        if (yych <= 'Z')
          goto yy518;
        goto yy506;
      } else {
        if (yych == '`')
          goto yy506;
        if (yych <= 'z')
          goto yy518;
        goto yy506;
      }
    }
  yy513:
    yych = *++p;
    if (yych != '>')
      goto yy506;
  yy514:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 4) {
      goto yy514;
    }
    if (yych <= 0x08)
      goto yy506;
    if (yych <= '\n')
      goto yy520;
    if (yych <= '\v')
      goto yy506;
    if (yych <= '\r')
      goto yy523;
    goto yy506;
  yy516:
    ++p;
    yych = *p;
    if (yych <= 0x1F) {
      if (yych <= 0x08)
        goto yy506;
      if (yych <= '\r')
        goto yy516;
      goto yy506;
    } else {
      if (yych <= ' ')
        goto yy516;
      if (yych == '>')
        goto yy514;
      goto yy506;
    }
  yy518:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 8) {
      goto yy518;
    }
    if (yych <= ',') {
      if (yych <= '\r') {
        if (yych <= 0x08)
          goto yy506;
        goto yy524;
      } else {
        if (yych == ' ')
          goto yy524;
        goto yy506;
      }
    } else {
      if (yych <= '<') {
        if (yych <= '/')
          goto yy513;
        goto yy506;
      } else {
        if (yych <= '=')
          goto yy526;
        if (yych <= '>')
          goto yy514;
        goto yy506;
      }
    }
  yy520:
    yyaccept = 1;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 4) {
      goto yy514;
    }
    if (yych <= 0x08)
      goto yy522;
    if (yych <= '\n')
      goto yy520;
    if (yych <= '\v')
      goto yy522;
    if (yych <= '\r')
      goto yy523;
  yy522 : { return 7; }
  yy523:
    yych = *++p;
    goto yy522;
  yy524:
    ++p;
    yych = *p;
    if (yych <= '<') {
      if (yych <= ' ') {
        if (yych <= 0x08)
          goto yy506;
        if (yych <= '\r')
          goto yy524;
        if (yych <= 0x1F)
          goto yy506;
        goto yy524;
      } else {
        if (yych <= '/') {
          if (yych <= '.')
            goto yy506;
          goto yy513;
        } else {
          if (yych == ':')
            goto yy518;
          goto yy506;
        }
      }
    } else {
      if (yych <= 'Z') {
        if (yych <= '=')
          goto yy526;
        if (yych <= '>')
          goto yy514;
        if (yych <= '@')
          goto yy506;
        goto yy518;
      } else {
        if (yych <= '_') {
          if (yych <= '^')
            goto yy506;
          goto yy518;
        } else {
          if (yych <= '`')
            goto yy506;
          if (yych <= 'z')
            goto yy518;
          goto yy506;
        }
      }
    }
  yy526:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 32) {
      goto yy527;
    }
    if (yych <= 0xE0) {
      if (yych <= '"') {
        if (yych <= 0x00)
          goto yy506;
        if (yych <= ' ')
          goto yy529;
        goto yy530;
      } else {
        if (yych <= '\'')
          goto yy532;
        if (yych <= 0xC1)
          goto yy506;
        if (yych <= 0xDF)
          goto yy534;
        goto yy535;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy537;
        goto yy536;
      } else {
        if (yych <= 0xF0)
          goto yy538;
        if (yych <= 0xF3)
          goto yy539;
        if (yych <= 0xF4)
          goto yy540;
        goto yy506;
      }
    }
  yy527:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 32) {
      goto yy527;
    }
    if (yych <= 0xE0) {
      if (yych <= '=') {
        if (yych <= 0x00)
          goto yy506;
        if (yych <= ' ')
          goto yy541;
        goto yy506;
      } else {
        if (yych <= '>')
          goto yy514;
        if (yych <= 0xC1)
          goto yy506;
        if (yych <= 0xDF)
          goto yy534;
        goto yy535;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy537;
        goto yy536;
      } else {
        if (yych <= 0xF0)
          goto yy538;
        if (yych <= 0xF3)
          goto yy539;
        if (yych <= 0xF4)
          goto yy540;
        goto yy506;
      }
    }
  yy529:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 32) {
      goto yy527;
    }
    if (yych <= 0xDF) {
      if (yych <= '\'') {
        if (yych <= 0x00)
          goto yy506;
        if (yych <= ' ')
          goto yy543;
        if (yych >= '#')
          goto yy532;
      } else {
        if (yych == '>')
          goto yy514;
        if (yych <= 0xC1)
          goto yy506;
        goto yy534;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy535;
        if (yych == 0xED)
          goto yy537;
        goto yy536;
      } else {
        if (yych <= 0xF0)
          goto yy538;
        if (yych <= 0xF3)
          goto yy539;
        if (yych <= 0xF4)
          goto yy540;
        goto yy506;
      }
    }
  yy530:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy530;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy506;
        if (yych <= '"')
          goto yy545;
        goto yy506;
      } else {
        if (yych <= 0xDF)
          goto yy546;
        if (yych <= 0xE0)
          goto yy547;
        goto yy548;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy549;
        if (yych <= 0xEF)
          goto yy548;
        goto yy550;
      } else {
        if (yych <= 0xF3)
          goto yy551;
        if (yych <= 0xF4)
          goto yy552;
        goto yy506;
      }
    }
  yy532:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy532;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy506;
        if (yych <= '\'')
          goto yy545;
        goto yy506;
      } else {
        if (yych <= 0xDF)
          goto yy553;
        if (yych <= 0xE0)
          goto yy554;
        goto yy555;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy556;
        if (yych <= 0xEF)
          goto yy555;
        goto yy557;
      } else {
        if (yych <= 0xF3)
          goto yy558;
        if (yych <= 0xF4)
          goto yy559;
        goto yy506;
      }
    }
  yy534:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy527;
    goto yy506;
  yy535:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy534;
    goto yy506;
  yy536:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy534;
    goto yy506;
  yy537:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0x9F)
      goto yy534;
    goto yy506;
  yy538:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy536;
    goto yy506;
  yy539:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy536;
    goto yy506;
  yy540:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0x8F)
      goto yy536;
    goto yy506;
  yy541:
    ++p;
    yych = *p;
    if (yych <= '@') {
      if (yych <= '"') {
        if (yych <= '\r') {
          if (yych <= 0x00)
            goto yy506;
          if (yych <= 0x08)
            goto yy527;
          goto yy541;
        } else {
          if (yych == ' ')
            goto yy541;
          if (yych <= '!')
            goto yy527;
          goto yy506;
        }
      } else {
        if (yych <= ':') {
          if (yych == '\'')
            goto yy506;
          if (yych <= '9')
            goto yy527;
          goto yy560;
        } else {
          if (yych <= ';')
            goto yy527;
          if (yych <= '=')
            goto yy506;
          if (yych <= '>')
            goto yy514;
          goto yy527;
        }
      }
    } else {
      if (yych <= 0xDF) {
        if (yych <= '`') {
          if (yych <= 'Z')
            goto yy560;
          if (yych <= '^')
            goto yy527;
          if (yych <= '_')
            goto yy560;
          goto yy506;
        } else {
          if (yych <= 'z')
            goto yy560;
          if (yych <= 0x7F)
            goto yy527;
          if (yych <= 0xC1)
            goto yy506;
          goto yy534;
        }
      } else {
        if (yych <= 0xEF) {
          if (yych <= 0xE0)
            goto yy535;
          if (yych == 0xED)
            goto yy537;
          goto yy536;
        } else {
          if (yych <= 0xF0)
            goto yy538;
          if (yych <= 0xF3)
            goto yy539;
          if (yych <= 0xF4)
            goto yy540;
          goto yy506;
        }
      }
    }
  yy543:
    ++p;
    yych = *p;
    if (yych <= '@') {
      if (yych <= '"') {
        if (yych <= '\r') {
          if (yych <= 0x00)
            goto yy506;
          if (yych <= 0x08)
            goto yy527;
          goto yy543;
        } else {
          if (yych == ' ')
            goto yy543;
          if (yych <= '!')
            goto yy527;
          goto yy530;
        }
      } else {
        if (yych <= ':') {
          if (yych == '\'')
            goto yy532;
          if (yych <= '9')
            goto yy527;
          goto yy560;
        } else {
          if (yych <= ';')
            goto yy527;
          if (yych <= '=')
            goto yy506;
          if (yych <= '>')
            goto yy514;
          goto yy527;
        }
      }
    } else {
      if (yych <= 0xDF) {
        if (yych <= '`') {
          if (yych <= 'Z')
            goto yy560;
          if (yych <= '^')
            goto yy527;
          if (yych <= '_')
            goto yy560;
          goto yy506;
        } else {
          if (yych <= 'z')
            goto yy560;
          if (yych <= 0x7F)
            goto yy527;
          if (yych <= 0xC1)
            goto yy506;
          goto yy534;
        }
      } else {
        if (yych <= 0xEF) {
          if (yych <= 0xE0)
            goto yy535;
          if (yych == 0xED)
            goto yy537;
          goto yy536;
        } else {
          if (yych <= 0xF0)
            goto yy538;
          if (yych <= 0xF3)
            goto yy539;
          if (yych <= 0xF4)
            goto yy540;
          goto yy506;
        }
      }
    }
  yy545:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 2) {
      goto yy511;
    }
    if (yych == '/')
      goto yy513;
    if (yych == '>')
      goto yy514;
    goto yy506;
  yy546:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy530;
    goto yy506;
  yy547:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy546;
    goto yy506;
  yy548:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy546;
    goto yy506;
  yy549:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0x9F)
      goto yy546;
    goto yy506;
  yy550:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy548;
    goto yy506;
  yy551:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy548;
    goto yy506;
  yy552:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0x8F)
      goto yy548;
    goto yy506;
  yy553:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy532;
    goto yy506;
  yy554:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy553;
    goto yy506;
  yy555:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy553;
    goto yy506;
  yy556:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0x9F)
      goto yy553;
    goto yy506;
  yy557:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy555;
    goto yy506;
  yy558:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0xBF)
      goto yy555;
    goto yy506;
  yy559:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy506;
    if (yych <= 0x8F)
      goto yy555;
    goto yy506;
  yy560:
    ++p;
    yych = *p;
    if (yych <= '>') {
      if (yych <= '&') {
        if (yych <= 0x1F) {
          if (yych <= 0x00)
            goto yy506;
          if (yych <= 0x08)
            goto yy527;
          if (yych >= 0x0E)
            goto yy527;
        } else {
          if (yych <= ' ')
            goto yy562;
          if (yych == '"')
            goto yy506;
          goto yy527;
        }
      } else {
        if (yych <= '/') {
          if (yych <= '\'')
            goto yy506;
          if (yych <= ',')
            goto yy527;
          if (yych <= '.')
            goto yy560;
          goto yy527;
        } else {
          if (yych <= ';') {
            if (yych <= ':')
              goto yy560;
            goto yy527;
          } else {
            if (yych <= '<')
              goto yy506;
            if (yych <= '=')
              goto yy526;
            goto yy514;
          }
        }
      }
    } else {
      if (yych <= 0xC1) {
        if (yych <= '_') {
          if (yych <= '@')
            goto yy527;
          if (yych <= 'Z')
            goto yy560;
          if (yych <= '^')
            goto yy527;
          goto yy560;
        } else {
          if (yych <= '`')
            goto yy506;
          if (yych <= 'z')
            goto yy560;
          if (yych <= 0x7F)
            goto yy527;
          goto yy506;
        }
      } else {
        if (yych <= 0xED) {
          if (yych <= 0xDF)
            goto yy534;
          if (yych <= 0xE0)
            goto yy535;
          if (yych <= 0xEC)
            goto yy536;
          goto yy537;
        } else {
          if (yych <= 0xF0) {
            if (yych <= 0xEF)
              goto yy536;
            goto yy538;
          } else {
            if (yych <= 0xF3)
              goto yy539;
            if (yych <= 0xF4)
              goto yy540;
            goto yy506;
          }
        }
      }
    }
  yy562:
    ++p;
    yych = *p;
    if (yych <= '@') {
      if (yych <= '&') {
        if (yych <= 0x1F) {
          if (yych <= 0x00)
            goto yy506;
          if (yych <= 0x08)
            goto yy527;
          if (yych <= '\r')
            goto yy562;
          goto yy527;
        } else {
          if (yych <= ' ')
            goto yy562;
          if (yych == '"')
            goto yy506;
          goto yy527;
        }
      } else {
        if (yych <= ';') {
          if (yych <= '\'')
            goto yy506;
          if (yych == ':')
            goto yy560;
          goto yy527;
        } else {
          if (yych <= '<')
            goto yy506;
          if (yych <= '=')
            goto yy526;
          if (yych <= '>')
            goto yy514;
          goto yy527;
        }
      }
    } else {
      if (yych <= 0xDF) {
        if (yych <= '`') {
          if (yych <= 'Z')
            goto yy560;
          if (yych <= '^')
            goto yy527;
          if (yych <= '_')
            goto yy560;
          goto yy506;
        } else {
          if (yych <= 'z')
            goto yy560;
          if (yych <= 0x7F)
            goto yy527;
          if (yych <= 0xC1)
            goto yy506;
          goto yy534;
        }
      } else {
        if (yych <= 0xEF) {
          if (yych <= 0xE0)
            goto yy535;
          if (yych == 0xED)
            goto yy537;
          goto yy536;
        } else {
          if (yych <= 0xF0)
            goto yy538;
          if (yych <= 0xF3)
            goto yy539;
          if (yych <= 0xF4)
            goto yy540;
          goto yy506;
        }
      }
    }
  }
}

// Try to match an HTML block end line of type 1
bufsize_t _scan_html_block_end_1(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    unsigned int yyaccept = 0;
    static const unsigned char yybm[] = {
        64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 0,  64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 128, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,
    };
    yych = *p;
    if (yych <= 0xDF) {
      if (yych <= ';') {
        if (yych == '\n')
          goto yy568;
      } else {
        if (yych <= '<')
          goto yy569;
        if (yych <= 0x7F)
          goto yy566;
        if (yych <= 0xC1)
          goto yy568;
        goto yy570;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy571;
        if (yych == 0xED)
          goto yy573;
        goto yy572;
      } else {
        if (yych <= 0xF0)
          goto yy574;
        if (yych <= 0xF3)
          goto yy575;
        if (yych <= 0xF4)
          goto yy576;
        goto yy568;
      }
    }
  yy566:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F) {
      if (yych != '\n')
        goto yy578;
    } else {
      if (yych <= 0xC1)
        goto yy567;
      if (yych <= 0xF4)
        goto yy578;
    }
  yy567 : { return 0; }
  yy568:
    yych = *++p;
    goto yy567;
  yy569:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= '/') {
      if (yych == '\n')
        goto yy567;
      if (yych <= '.')
        goto yy578;
      goto yy589;
    } else {
      if (yych <= 0x7F)
        goto yy578;
      if (yych <= 0xC1)
        goto yy567;
      if (yych <= 0xF4)
        goto yy578;
      goto yy567;
    }
  yy570:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy567;
    if (yych <= 0xBF)
      goto yy577;
    goto yy567;
  yy571:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x9F)
      goto yy567;
    if (yych <= 0xBF)
      goto yy582;
    goto yy567;
  yy572:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy567;
    if (yych <= 0xBF)
      goto yy582;
    goto yy567;
  yy573:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy567;
    if (yych <= 0x9F)
      goto yy582;
    goto yy567;
  yy574:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x8F)
      goto yy567;
    if (yych <= 0xBF)
      goto yy584;
    goto yy567;
  yy575:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy567;
    if (yych <= 0xBF)
      goto yy584;
    goto yy567;
  yy576:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy567;
    if (yych <= 0x8F)
      goto yy584;
    goto yy567;
  yy577:
    ++p;
    yych = *p;
  yy578:
    if (yybm[0 + yych] & 64) {
      goto yy577;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy579;
        if (yych <= '<')
          goto yy580;
      } else {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        goto yy584;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy585;
        if (yych <= 0xEF)
          goto yy584;
        goto yy586;
      } else {
        if (yych <= 0xF3)
          goto yy587;
        if (yych <= 0xF4)
          goto yy588;
      }
    }
  yy579:
    p = marker;
    if (yyaccept == 0) {
      goto yy567;
    } else {
      goto yy599;
    }
  yy580:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xDF) {
      if (yych <= '.') {
        if (yych == '\n')
          goto yy579;
        goto yy577;
      } else {
        if (yych <= '/')
          goto yy589;
        if (yych <= 0x7F)
          goto yy577;
        if (yych <= 0xC1)
          goto yy579;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy583;
        if (yych == 0xED)
          goto yy585;
        goto yy584;
      } else {
        if (yych <= 0xF0)
          goto yy586;
        if (yych <= 0xF3)
          goto yy587;
        if (yych <= 0xF4)
          goto yy588;
        goto yy579;
      }
    }
  yy582:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy579;
    if (yych <= 0xBF)
      goto yy577;
    goto yy579;
  yy583:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy579;
    if (yych <= 0xBF)
      goto yy582;
    goto yy579;
  yy584:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy579;
    if (yych <= 0xBF)
      goto yy582;
    goto yy579;
  yy585:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy579;
    if (yych <= 0x9F)
      goto yy582;
    goto yy579;
  yy586:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy579;
    if (yych <= 0xBF)
      goto yy584;
    goto yy579;
  yy587:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy579;
    if (yych <= 0xBF)
      goto yy584;
    goto yy579;
  yy588:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy579;
    if (yych <= 0x8F)
      goto yy584;
    goto yy579;
  yy589:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 's') {
      if (yych <= 'R') {
        if (yych <= '\n') {
          if (yych <= '\t')
            goto yy577;
          goto yy579;
        } else {
          if (yych != 'P')
            goto yy577;
        }
      } else {
        if (yych <= 'o') {
          if (yych <= 'S')
            goto yy591;
          goto yy577;
        } else {
          if (yych <= 'p')
            goto yy590;
          if (yych <= 'r')
            goto yy577;
          goto yy591;
        }
      }
    } else {
      if (yych <= 0xEC) {
        if (yych <= 0xC1) {
          if (yych <= 0x7F)
            goto yy577;
          goto yy579;
        } else {
          if (yych <= 0xDF)
            goto yy582;
          if (yych <= 0xE0)
            goto yy583;
          goto yy584;
        }
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xED)
            goto yy585;
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy590:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xC1) {
      if (yych <= 'R') {
        if (yych == '\n')
          goto yy579;
        if (yych <= 'Q')
          goto yy577;
        goto yy592;
      } else {
        if (yych == 'r')
          goto yy592;
        if (yych <= 0x7F)
          goto yy577;
        goto yy579;
      }
    } else {
      if (yych <= 0xED) {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        if (yych <= 0xEC)
          goto yy584;
        goto yy585;
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy591:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 't') {
      if (yych <= 'S') {
        if (yych <= '\n') {
          if (yych <= '\t')
            goto yy577;
          goto yy579;
        } else {
          if (yych == 'C')
            goto yy593;
          goto yy577;
        }
      } else {
        if (yych <= 'b') {
          if (yych <= 'T')
            goto yy594;
          goto yy577;
        } else {
          if (yych <= 'c')
            goto yy593;
          if (yych <= 's')
            goto yy577;
          goto yy594;
        }
      }
    } else {
      if (yych <= 0xEC) {
        if (yych <= 0xC1) {
          if (yych <= 0x7F)
            goto yy577;
          goto yy579;
        } else {
          if (yych <= 0xDF)
            goto yy582;
          if (yych <= 0xE0)
            goto yy583;
          goto yy584;
        }
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xED)
            goto yy585;
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy592:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xC1) {
      if (yych <= 'E') {
        if (yych == '\n')
          goto yy579;
        if (yych <= 'D')
          goto yy577;
        goto yy595;
      } else {
        if (yych == 'e')
          goto yy595;
        if (yych <= 0x7F)
          goto yy577;
        goto yy579;
      }
    } else {
      if (yych <= 0xED) {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        if (yych <= 0xEC)
          goto yy584;
        goto yy585;
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy593:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xC1) {
      if (yych <= 'R') {
        if (yych == '\n')
          goto yy579;
        if (yych <= 'Q')
          goto yy577;
        goto yy596;
      } else {
        if (yych == 'r')
          goto yy596;
        if (yych <= 0x7F)
          goto yy577;
        goto yy579;
      }
    } else {
      if (yych <= 0xED) {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        if (yych <= 0xEC)
          goto yy584;
        goto yy585;
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy594:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xC1) {
      if (yych <= 'Y') {
        if (yych == '\n')
          goto yy579;
        if (yych <= 'X')
          goto yy577;
        goto yy597;
      } else {
        if (yych == 'y')
          goto yy597;
        if (yych <= 0x7F)
          goto yy577;
        goto yy579;
      }
    } else {
      if (yych <= 0xED) {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        if (yych <= 0xEC)
          goto yy584;
        goto yy585;
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy595:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xDF) {
      if (yych <= '=') {
        if (yych == '\n')
          goto yy579;
        goto yy577;
      } else {
        if (yych <= '>')
          goto yy598;
        if (yych <= 0x7F)
          goto yy577;
        if (yych <= 0xC1)
          goto yy579;
        goto yy582;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy583;
        if (yych == 0xED)
          goto yy585;
        goto yy584;
      } else {
        if (yych <= 0xF0)
          goto yy586;
        if (yych <= 0xF3)
          goto yy587;
        if (yych <= 0xF4)
          goto yy588;
        goto yy579;
      }
    }
  yy596:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xC1) {
      if (yych <= 'I') {
        if (yych == '\n')
          goto yy579;
        if (yych <= 'H')
          goto yy577;
        goto yy600;
      } else {
        if (yych == 'i')
          goto yy600;
        if (yych <= 0x7F)
          goto yy577;
        goto yy579;
      }
    } else {
      if (yych <= 0xED) {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        if (yych <= 0xEC)
          goto yy584;
        goto yy585;
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy597:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xC1) {
      if (yych <= 'L') {
        if (yych == '\n')
          goto yy579;
        if (yych <= 'K')
          goto yy577;
        goto yy592;
      } else {
        if (yych == 'l')
          goto yy592;
        if (yych <= 0x7F)
          goto yy577;
        goto yy579;
      }
    } else {
      if (yych <= 0xED) {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        if (yych <= 0xEC)
          goto yy584;
        goto yy585;
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy598:
    yyaccept = 1;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy577;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy599;
        if (yych <= '<')
          goto yy580;
      } else {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        goto yy584;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy585;
        if (yych <= 0xEF)
          goto yy584;
        goto yy586;
      } else {
        if (yych <= 0xF3)
          goto yy587;
        if (yych <= 0xF4)
          goto yy588;
      }
    }
  yy599 : { return (bufsize_t)(p - start); }
  yy600:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xC1) {
      if (yych <= 'P') {
        if (yych == '\n')
          goto yy579;
        if (yych <= 'O')
          goto yy577;
      } else {
        if (yych == 'p')
          goto yy601;
        if (yych <= 0x7F)
          goto yy577;
        goto yy579;
      }
    } else {
      if (yych <= 0xED) {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        if (yych <= 0xEC)
          goto yy584;
        goto yy585;
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  yy601:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy580;
    }
    if (yych <= 0xC1) {
      if (yych <= 'T') {
        if (yych == '\n')
          goto yy579;
        if (yych <= 'S')
          goto yy577;
        goto yy595;
      } else {
        if (yych == 't')
          goto yy595;
        if (yych <= 0x7F)
          goto yy577;
        goto yy579;
      }
    } else {
      if (yych <= 0xED) {
        if (yych <= 0xDF)
          goto yy582;
        if (yych <= 0xE0)
          goto yy583;
        if (yych <= 0xEC)
          goto yy584;
        goto yy585;
      } else {
        if (yych <= 0xF0) {
          if (yych <= 0xEF)
            goto yy584;
          goto yy586;
        } else {
          if (yych <= 0xF3)
            goto yy587;
          if (yych <= 0xF4)
            goto yy588;
          goto yy579;
        }
      }
    }
  }
}

// Try to match an HTML block end line of type 2
bufsize_t _scan_html_block_end_2(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    unsigned int yyaccept = 0;
    static const unsigned char yybm[] = {
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  0,  64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 128, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,
    };
    yych = *p;
    if (yych <= 0xDF) {
      if (yych <= ',') {
        if (yych == '\n')
          goto yy606;
      } else {
        if (yych <= '-')
          goto yy607;
        if (yych <= 0x7F)
          goto yy604;
        if (yych <= 0xC1)
          goto yy606;
        goto yy608;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy609;
        if (yych == 0xED)
          goto yy611;
        goto yy610;
      } else {
        if (yych <= 0xF0)
          goto yy612;
        if (yych <= 0xF3)
          goto yy613;
        if (yych <= 0xF4)
          goto yy614;
        goto yy606;
      }
    }
  yy604:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F) {
      if (yych != '\n')
        goto yy616;
    } else {
      if (yych <= 0xC1)
        goto yy605;
      if (yych <= 0xF4)
        goto yy616;
    }
  yy605 : { return 0; }
  yy606:
    yych = *++p;
    goto yy605;
  yy607:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yybm[0 + yych] & 128) {
      goto yy626;
    }
    if (yych <= 0x7F) {
      if (yych == '\n')
        goto yy605;
      goto yy616;
    } else {
      if (yych <= 0xC1)
        goto yy605;
      if (yych <= 0xF4)
        goto yy616;
      goto yy605;
    }
  yy608:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy605;
    if (yych <= 0xBF)
      goto yy615;
    goto yy605;
  yy609:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x9F)
      goto yy605;
    if (yych <= 0xBF)
      goto yy619;
    goto yy605;
  yy610:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy605;
    if (yych <= 0xBF)
      goto yy619;
    goto yy605;
  yy611:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy605;
    if (yych <= 0x9F)
      goto yy619;
    goto yy605;
  yy612:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x8F)
      goto yy605;
    if (yych <= 0xBF)
      goto yy621;
    goto yy605;
  yy613:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy605;
    if (yych <= 0xBF)
      goto yy621;
    goto yy605;
  yy614:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy605;
    if (yych <= 0x8F)
      goto yy621;
    goto yy605;
  yy615:
    ++p;
    yych = *p;
  yy616:
    if (yybm[0 + yych] & 64) {
      goto yy615;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy617;
        if (yych <= '-')
          goto yy618;
      } else {
        if (yych <= 0xDF)
          goto yy619;
        if (yych <= 0xE0)
          goto yy620;
        goto yy621;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy622;
        if (yych <= 0xEF)
          goto yy621;
        goto yy623;
      } else {
        if (yych <= 0xF3)
          goto yy624;
        if (yych <= 0xF4)
          goto yy625;
      }
    }
  yy617:
    p = marker;
    if (yyaccept == 0) {
      goto yy605;
    } else {
      goto yy629;
    }
  yy618:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy615;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy617;
        if (yych <= '-')
          goto yy626;
        goto yy617;
      } else {
        if (yych <= 0xDF)
          goto yy619;
        if (yych <= 0xE0)
          goto yy620;
        goto yy621;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy622;
        if (yych <= 0xEF)
          goto yy621;
        goto yy623;
      } else {
        if (yych <= 0xF3)
          goto yy624;
        if (yych <= 0xF4)
          goto yy625;
        goto yy617;
      }
    }
  yy619:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy617;
    if (yych <= 0xBF)
      goto yy615;
    goto yy617;
  yy620:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy617;
    if (yych <= 0xBF)
      goto yy619;
    goto yy617;
  yy621:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy617;
    if (yych <= 0xBF)
      goto yy619;
    goto yy617;
  yy622:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy617;
    if (yych <= 0x9F)
      goto yy619;
    goto yy617;
  yy623:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy617;
    if (yych <= 0xBF)
      goto yy621;
    goto yy617;
  yy624:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy617;
    if (yych <= 0xBF)
      goto yy621;
    goto yy617;
  yy625:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy617;
    if (yych <= 0x8F)
      goto yy621;
    goto yy617;
  yy626:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy626;
    }
    if (yych <= 0xDF) {
      if (yych <= '=') {
        if (yych == '\n')
          goto yy617;
        goto yy615;
      } else {
        if (yych <= '>')
          goto yy628;
        if (yych <= 0x7F)
          goto yy615;
        if (yych <= 0xC1)
          goto yy617;
        goto yy619;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy620;
        if (yych == 0xED)
          goto yy622;
        goto yy621;
      } else {
        if (yych <= 0xF0)
          goto yy623;
        if (yych <= 0xF3)
          goto yy624;
        if (yych <= 0xF4)
          goto yy625;
        goto yy617;
      }
    }
  yy628:
    yyaccept = 1;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy615;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy629;
        if (yych <= '-')
          goto yy618;
      } else {
        if (yych <= 0xDF)
          goto yy619;
        if (yych <= 0xE0)
          goto yy620;
        goto yy621;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy622;
        if (yych <= 0xEF)
          goto yy621;
        goto yy623;
      } else {
        if (yych <= 0xF3)
          goto yy624;
        if (yych <= 0xF4)
          goto yy625;
      }
    }
  yy629 : { return (bufsize_t)(p - start); }
  }
}

// Try to match an HTML block end line of type 3
bufsize_t _scan_html_block_end_3(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    unsigned int yyaccept = 0;
    static const unsigned char yybm[] = {
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  0,  64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 128, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64, 64, 64, 64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,
    };
    yych = *p;
    if (yych <= 0xDF) {
      if (yych <= '>') {
        if (yych == '\n')
          goto yy634;
      } else {
        if (yych <= '?')
          goto yy635;
        if (yych <= 0x7F)
          goto yy632;
        if (yych <= 0xC1)
          goto yy634;
        goto yy636;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy637;
        if (yych == 0xED)
          goto yy639;
        goto yy638;
      } else {
        if (yych <= 0xF0)
          goto yy640;
        if (yych <= 0xF3)
          goto yy641;
        if (yych <= 0xF4)
          goto yy642;
        goto yy634;
      }
    }
  yy632:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F) {
      if (yych != '\n')
        goto yy644;
    } else {
      if (yych <= 0xC1)
        goto yy633;
      if (yych <= 0xF4)
        goto yy644;
    }
  yy633 : { return 0; }
  yy634:
    yych = *++p;
    goto yy633;
  yy635:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= '>') {
      if (yych == '\n')
        goto yy633;
      if (yych <= '=')
        goto yy644;
      goto yy655;
    } else {
      if (yych <= 0x7F)
        goto yy644;
      if (yych <= 0xC1)
        goto yy633;
      if (yych <= 0xF4)
        goto yy644;
      goto yy633;
    }
  yy636:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy633;
    if (yych <= 0xBF)
      goto yy643;
    goto yy633;
  yy637:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x9F)
      goto yy633;
    if (yych <= 0xBF)
      goto yy648;
    goto yy633;
  yy638:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy633;
    if (yych <= 0xBF)
      goto yy648;
    goto yy633;
  yy639:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy633;
    if (yych <= 0x9F)
      goto yy648;
    goto yy633;
  yy640:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x8F)
      goto yy633;
    if (yych <= 0xBF)
      goto yy650;
    goto yy633;
  yy641:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy633;
    if (yych <= 0xBF)
      goto yy650;
    goto yy633;
  yy642:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy633;
    if (yych <= 0x8F)
      goto yy650;
    goto yy633;
  yy643:
    ++p;
    yych = *p;
  yy644:
    if (yybm[0 + yych] & 64) {
      goto yy643;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy645;
        if (yych <= '?')
          goto yy646;
      } else {
        if (yych <= 0xDF)
          goto yy648;
        if (yych <= 0xE0)
          goto yy649;
        goto yy650;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy651;
        if (yych <= 0xEF)
          goto yy650;
        goto yy652;
      } else {
        if (yych <= 0xF3)
          goto yy653;
        if (yych <= 0xF4)
          goto yy654;
      }
    }
  yy645:
    p = marker;
    if (yyaccept == 0) {
      goto yy633;
    } else {
      goto yy656;
    }
  yy646:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy646;
    }
    if (yych <= 0xDF) {
      if (yych <= '=') {
        if (yych == '\n')
          goto yy645;
        goto yy643;
      } else {
        if (yych <= '>')
          goto yy655;
        if (yych <= 0x7F)
          goto yy643;
        if (yych <= 0xC1)
          goto yy645;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy649;
        if (yych == 0xED)
          goto yy651;
        goto yy650;
      } else {
        if (yych <= 0xF0)
          goto yy652;
        if (yych <= 0xF3)
          goto yy653;
        if (yych <= 0xF4)
          goto yy654;
        goto yy645;
      }
    }
  yy648:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy645;
    if (yych <= 0xBF)
      goto yy643;
    goto yy645;
  yy649:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy645;
    if (yych <= 0xBF)
      goto yy648;
    goto yy645;
  yy650:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy645;
    if (yych <= 0xBF)
      goto yy648;
    goto yy645;
  yy651:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy645;
    if (yych <= 0x9F)
      goto yy648;
    goto yy645;
  yy652:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy645;
    if (yych <= 0xBF)
      goto yy650;
    goto yy645;
  yy653:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy645;
    if (yych <= 0xBF)
      goto yy650;
    goto yy645;
  yy654:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy645;
    if (yych <= 0x8F)
      goto yy650;
    goto yy645;
  yy655:
    yyaccept = 1;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy643;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy656;
        if (yych <= '?')
          goto yy646;
      } else {
        if (yych <= 0xDF)
          goto yy648;
        if (yych <= 0xE0)
          goto yy649;
        goto yy650;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy651;
        if (yych <= 0xEF)
          goto yy650;
        goto yy652;
      } else {
        if (yych <= 0xF3)
          goto yy653;
        if (yych <= 0xF4)
          goto yy654;
      }
    }
  yy656 : { return (bufsize_t)(p - start); }
  }
}

// Try to match an HTML block end line of type 4
bufsize_t _scan_html_block_end_4(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    unsigned int yyaccept = 0;
    static const unsigned char yybm[] = {
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 0,   128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 64,  128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128,
        128, 128, 0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,
    };
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy662;
    }
    if (yych <= 0xE0) {
      if (yych <= 0x7F) {
        if (yych == '\n')
          goto yy661;
      } else {
        if (yych <= 0xC1)
          goto yy661;
        if (yych <= 0xDF)
          goto yy665;
        goto yy666;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy668;
        goto yy667;
      } else {
        if (yych <= 0xF0)
          goto yy669;
        if (yych <= 0xF3)
          goto yy670;
        if (yych <= 0xF4)
          goto yy671;
        goto yy661;
      }
    }
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F) {
      if (yych != '\n')
        goto yy673;
    } else {
      if (yych <= 0xC1)
        goto yy660;
      if (yych <= 0xF4)
        goto yy673;
    }
  yy660 : { return 0; }
  yy661:
    yych = *++p;
    goto yy660;
  yy662:
    yyaccept = 1;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy672;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy664;
        if (yych <= '>')
          goto yy662;
      } else {
        if (yych <= 0xDF)
          goto yy675;
        if (yych <= 0xE0)
          goto yy676;
        goto yy677;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy678;
        if (yych <= 0xEF)
          goto yy677;
        goto yy679;
      } else {
        if (yych <= 0xF3)
          goto yy680;
        if (yych <= 0xF4)
          goto yy681;
      }
    }
  yy664 : { return (bufsize_t)(p - start); }
  yy665:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy660;
    if (yych <= 0xBF)
      goto yy672;
    goto yy660;
  yy666:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x9F)
      goto yy660;
    if (yych <= 0xBF)
      goto yy675;
    goto yy660;
  yy667:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy660;
    if (yych <= 0xBF)
      goto yy675;
    goto yy660;
  yy668:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy660;
    if (yych <= 0x9F)
      goto yy675;
    goto yy660;
  yy669:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x8F)
      goto yy660;
    if (yych <= 0xBF)
      goto yy677;
    goto yy660;
  yy670:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy660;
    if (yych <= 0xBF)
      goto yy677;
    goto yy660;
  yy671:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy660;
    if (yych <= 0x8F)
      goto yy677;
    goto yy660;
  yy672:
    ++p;
    yych = *p;
  yy673:
    if (yybm[0 + yych] & 128) {
      goto yy672;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy674;
        if (yych <= '>')
          goto yy662;
      } else {
        if (yych <= 0xDF)
          goto yy675;
        if (yych <= 0xE0)
          goto yy676;
        goto yy677;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy678;
        if (yych <= 0xEF)
          goto yy677;
        goto yy679;
      } else {
        if (yych <= 0xF3)
          goto yy680;
        if (yych <= 0xF4)
          goto yy681;
      }
    }
  yy674:
    p = marker;
    if (yyaccept == 0) {
      goto yy660;
    } else {
      goto yy664;
    }
  yy675:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy674;
    if (yych <= 0xBF)
      goto yy672;
    goto yy674;
  yy676:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy674;
    if (yych <= 0xBF)
      goto yy675;
    goto yy674;
  yy677:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy674;
    if (yych <= 0xBF)
      goto yy675;
    goto yy674;
  yy678:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy674;
    if (yych <= 0x9F)
      goto yy675;
    goto yy674;
  yy679:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy674;
    if (yych <= 0xBF)
      goto yy677;
    goto yy674;
  yy680:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy674;
    if (yych <= 0xBF)
      goto yy677;
    goto yy674;
  yy681:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy674;
    if (yych <= 0x8F)
      goto yy677;
    goto yy674;
  }
}

// Try to match an HTML block end line of type 5
bufsize_t _scan_html_block_end_5(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    unsigned int yyaccept = 0;
    static const unsigned char yybm[] = {
        64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 0,  64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 128, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 64, 64,  64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,
        64, 64, 0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,
    };
    yych = *p;
    if (yych <= 0xDF) {
      if (yych <= '\\') {
        if (yych == '\n')
          goto yy686;
      } else {
        if (yych <= ']')
          goto yy687;
        if (yych <= 0x7F)
          goto yy684;
        if (yych <= 0xC1)
          goto yy686;
        goto yy688;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy689;
        if (yych == 0xED)
          goto yy691;
        goto yy690;
      } else {
        if (yych <= 0xF0)
          goto yy692;
        if (yych <= 0xF3)
          goto yy693;
        if (yych <= 0xF4)
          goto yy694;
        goto yy686;
      }
    }
  yy684:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F) {
      if (yych != '\n')
        goto yy696;
    } else {
      if (yych <= 0xC1)
        goto yy685;
      if (yych <= 0xF4)
        goto yy696;
    }
  yy685 : { return 0; }
  yy686:
    yych = *++p;
    goto yy685;
  yy687:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yybm[0 + yych] & 128) {
      goto yy706;
    }
    if (yych <= 0x7F) {
      if (yych == '\n')
        goto yy685;
      goto yy696;
    } else {
      if (yych <= 0xC1)
        goto yy685;
      if (yych <= 0xF4)
        goto yy696;
      goto yy685;
    }
  yy688:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy685;
    if (yych <= 0xBF)
      goto yy695;
    goto yy685;
  yy689:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x9F)
      goto yy685;
    if (yych <= 0xBF)
      goto yy699;
    goto yy685;
  yy690:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy685;
    if (yych <= 0xBF)
      goto yy699;
    goto yy685;
  yy691:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy685;
    if (yych <= 0x9F)
      goto yy699;
    goto yy685;
  yy692:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x8F)
      goto yy685;
    if (yych <= 0xBF)
      goto yy701;
    goto yy685;
  yy693:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy685;
    if (yych <= 0xBF)
      goto yy701;
    goto yy685;
  yy694:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x7F)
      goto yy685;
    if (yych <= 0x8F)
      goto yy701;
    goto yy685;
  yy695:
    ++p;
    yych = *p;
  yy696:
    if (yybm[0 + yych] & 64) {
      goto yy695;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy697;
        if (yych <= ']')
          goto yy698;
      } else {
        if (yych <= 0xDF)
          goto yy699;
        if (yych <= 0xE0)
          goto yy700;
        goto yy701;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy702;
        if (yych <= 0xEF)
          goto yy701;
        goto yy703;
      } else {
        if (yych <= 0xF3)
          goto yy704;
        if (yych <= 0xF4)
          goto yy705;
      }
    }
  yy697:
    p = marker;
    if (yyaccept == 0) {
      goto yy685;
    } else {
      goto yy709;
    }
  yy698:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy695;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy697;
        if (yych <= ']')
          goto yy706;
        goto yy697;
      } else {
        if (yych <= 0xDF)
          goto yy699;
        if (yych <= 0xE0)
          goto yy700;
        goto yy701;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy702;
        if (yych <= 0xEF)
          goto yy701;
        goto yy703;
      } else {
        if (yych <= 0xF3)
          goto yy704;
        if (yych <= 0xF4)
          goto yy705;
        goto yy697;
      }
    }
  yy699:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy697;
    if (yych <= 0xBF)
      goto yy695;
    goto yy697;
  yy700:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy697;
    if (yych <= 0xBF)
      goto yy699;
    goto yy697;
  yy701:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy697;
    if (yych <= 0xBF)
      goto yy699;
    goto yy697;
  yy702:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy697;
    if (yych <= 0x9F)
      goto yy699;
    goto yy697;
  yy703:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy697;
    if (yych <= 0xBF)
      goto yy701;
    goto yy697;
  yy704:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy697;
    if (yych <= 0xBF)
      goto yy701;
    goto yy697;
  yy705:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy697;
    if (yych <= 0x8F)
      goto yy701;
    goto yy697;
  yy706:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy706;
    }
    if (yych <= 0xDF) {
      if (yych <= '=') {
        if (yych == '\n')
          goto yy697;
        goto yy695;
      } else {
        if (yych <= '>')
          goto yy708;
        if (yych <= 0x7F)
          goto yy695;
        if (yych <= 0xC1)
          goto yy697;
        goto yy699;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych <= 0xE0)
          goto yy700;
        if (yych == 0xED)
          goto yy702;
        goto yy701;
      } else {
        if (yych <= 0xF0)
          goto yy703;
        if (yych <= 0xF3)
          goto yy704;
        if (yych <= 0xF4)
          goto yy705;
        goto yy697;
      }
    }
  yy708:
    yyaccept = 1;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy695;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= '\n')
          goto yy709;
        if (yych <= ']')
          goto yy698;
      } else {
        if (yych <= 0xDF)
          goto yy699;
        if (yych <= 0xE0)
          goto yy700;
        goto yy701;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy702;
        if (yych <= 0xEF)
          goto yy701;
        goto yy703;
      } else {
        if (yych <= 0xF3)
          goto yy704;
        if (yych <= 0xF4)
          goto yy705;
      }
    }
  yy709 : { return (bufsize_t)(p - start); }
  }
}

// Try to match a link title (in single quotes, in double quotes, or
// in parentheses), returning number of chars matched.  Allow one
// level of internal nesting (quotes within quotes).
bufsize_t _scan_link_title(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    unsigned int yyaccept = 0;
    static const unsigned char yybm[] = {
        0,   208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208,
        208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208,
        208, 208, 208, 208, 208, 208, 192, 208, 208, 208, 208, 144, 208, 80,
        208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208,
        208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208,
        208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208,
        208, 208, 208, 208, 208, 208, 208, 208, 32,  208, 208, 208, 208, 208,
        208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208,
        208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208,
        208, 208, 0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,
    };
    yych = *p;
    if (yych <= '&') {
      if (yych == '"')
        goto yy714;
    } else {
      if (yych <= '\'')
        goto yy715;
      if (yych <= '(')
        goto yy716;
    }
    ++p;
  yy713 : { return 0; }
  yy714:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x00)
      goto yy713;
    if (yych <= 0x7F)
      goto yy718;
    if (yych <= 0xC1)
      goto yy713;
    if (yych <= 0xF4)
      goto yy718;
    goto yy713;
  yy715:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x00)
      goto yy713;
    if (yych <= 0x7F)
      goto yy732;
    if (yych <= 0xC1)
      goto yy713;
    if (yych <= 0xF4)
      goto yy732;
    goto yy713;
  yy716:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych <= 0x00)
      goto yy713;
    if (yych <= 0x7F)
      goto yy745;
    if (yych <= 0xC1)
      goto yy713;
    if (yych <= 0xF4)
      goto yy745;
    goto yy713;
  yy717:
    ++p;
    yych = *p;
  yy718:
    if (yybm[0 + yych] & 16) {
      goto yy717;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy719;
        if (yych <= '"')
          goto yy720;
        goto yy722;
      } else {
        if (yych <= 0xC1)
          goto yy719;
        if (yych <= 0xDF)
          goto yy724;
        goto yy725;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy727;
        goto yy726;
      } else {
        if (yych <= 0xF0)
          goto yy728;
        if (yych <= 0xF3)
          goto yy729;
        if (yych <= 0xF4)
          goto yy730;
      }
    }
  yy719:
    p = marker;
    if (yyaccept <= 1) {
      if (yyaccept == 0) {
        goto yy713;
      } else {
        goto yy721;
      }
    } else {
      if (yyaccept == 2) {
        goto yy734;
      } else {
        goto yy747;
      }
    }
  yy720:
    ++p;
  yy721 : { return (bufsize_t)(p - start); }
  yy722:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 16) {
      goto yy717;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy719;
        if (yych <= '"')
          goto yy757;
        goto yy722;
      } else {
        if (yych <= 0xC1)
          goto yy719;
        if (yych >= 0xE0)
          goto yy725;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy727;
        goto yy726;
      } else {
        if (yych <= 0xF0)
          goto yy728;
        if (yych <= 0xF3)
          goto yy729;
        if (yych <= 0xF4)
          goto yy730;
        goto yy719;
      }
    }
  yy724:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy717;
    goto yy719;
  yy725:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy724;
    goto yy719;
  yy726:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy724;
    goto yy719;
  yy727:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0x9F)
      goto yy724;
    goto yy719;
  yy728:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy726;
    goto yy719;
  yy729:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy726;
    goto yy719;
  yy730:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0x8F)
      goto yy726;
    goto yy719;
  yy731:
    ++p;
    yych = *p;
  yy732:
    if (yybm[0 + yych] & 64) {
      goto yy731;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy719;
        if (yych >= '(')
          goto yy735;
      } else {
        if (yych <= 0xC1)
          goto yy719;
        if (yych <= 0xDF)
          goto yy737;
        goto yy738;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy740;
        goto yy739;
      } else {
        if (yych <= 0xF0)
          goto yy741;
        if (yych <= 0xF3)
          goto yy742;
        if (yych <= 0xF4)
          goto yy743;
        goto yy719;
      }
    }
  yy733:
    ++p;
  yy734 : { return (bufsize_t)(p - start); }
  yy735:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy731;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy719;
        if (yych <= '\'')
          goto yy758;
        goto yy735;
      } else {
        if (yych <= 0xC1)
          goto yy719;
        if (yych >= 0xE0)
          goto yy738;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy740;
        goto yy739;
      } else {
        if (yych <= 0xF0)
          goto yy741;
        if (yych <= 0xF3)
          goto yy742;
        if (yych <= 0xF4)
          goto yy743;
        goto yy719;
      }
    }
  yy737:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy731;
    goto yy719;
  yy738:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy737;
    goto yy719;
  yy739:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy737;
    goto yy719;
  yy740:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0x9F)
      goto yy737;
    goto yy719;
  yy741:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy739;
    goto yy719;
  yy742:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy739;
    goto yy719;
  yy743:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0x8F)
      goto yy739;
    goto yy719;
  yy744:
    ++p;
    yych = *p;
  yy745:
    if (yybm[0 + yych] & 128) {
      goto yy744;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy719;
        if (yych >= '*')
          goto yy748;
      } else {
        if (yych <= 0xC1)
          goto yy719;
        if (yych <= 0xDF)
          goto yy750;
        goto yy751;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy753;
        goto yy752;
      } else {
        if (yych <= 0xF0)
          goto yy754;
        if (yych <= 0xF3)
          goto yy755;
        if (yych <= 0xF4)
          goto yy756;
        goto yy719;
      }
    }
  yy746:
    ++p;
  yy747 : { return (bufsize_t)(p - start); }
  yy748:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy744;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy719;
        if (yych <= ')')
          goto yy759;
        goto yy748;
      } else {
        if (yych <= 0xC1)
          goto yy719;
        if (yych >= 0xE0)
          goto yy751;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy753;
        goto yy752;
      } else {
        if (yych <= 0xF0)
          goto yy754;
        if (yych <= 0xF3)
          goto yy755;
        if (yych <= 0xF4)
          goto yy756;
        goto yy719;
      }
    }
  yy750:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy744;
    goto yy719;
  yy751:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy750;
    goto yy719;
  yy752:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy750;
    goto yy719;
  yy753:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0x9F)
      goto yy750;
    goto yy719;
  yy754:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy752;
    goto yy719;
  yy755:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0xBF)
      goto yy752;
    goto yy719;
  yy756:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy719;
    if (yych <= 0x8F)
      goto yy752;
    goto yy719;
  yy757:
    yyaccept = 1;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 16) {
      goto yy717;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy721;
        if (yych <= '"')
          goto yy720;
        goto yy722;
      } else {
        if (yych <= 0xC1)
          goto yy721;
        if (yych <= 0xDF)
          goto yy724;
        goto yy725;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy727;
        goto yy726;
      } else {
        if (yych <= 0xF0)
          goto yy728;
        if (yych <= 0xF3)
          goto yy729;
        if (yych <= 0xF4)
          goto yy730;
        goto yy721;
      }
    }
  yy758:
    yyaccept = 2;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy731;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy734;
        if (yych <= '\'')
          goto yy733;
        goto yy735;
      } else {
        if (yych <= 0xC1)
          goto yy734;
        if (yych <= 0xDF)
          goto yy737;
        goto yy738;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy740;
        goto yy739;
      } else {
        if (yych <= 0xF0)
          goto yy741;
        if (yych <= 0xF3)
          goto yy742;
        if (yych <= 0xF4)
          goto yy743;
        goto yy734;
      }
    }
  yy759:
    yyaccept = 3;
    marker = ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy744;
    }
    if (yych <= 0xE0) {
      if (yych <= '\\') {
        if (yych <= 0x00)
          goto yy747;
        if (yych <= ')')
          goto yy746;
        goto yy748;
      } else {
        if (yych <= 0xC1)
          goto yy747;
        if (yych <= 0xDF)
          goto yy750;
        goto yy751;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy753;
        goto yy752;
      } else {
        if (yych <= 0xF0)
          goto yy754;
        if (yych <= 0xF3)
          goto yy755;
        if (yych <= 0xF4)
          goto yy756;
        goto yy747;
      }
    }
  }
}

// Match space characters, including newlines.
bufsize_t _scan_spacechars(const unsigned char *p) {
  const unsigned char *start = p;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 128, 128, 128, 128, 128, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   128, 0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0,   0,   0,   0, 0,
    };
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy764;
    }
    ++p;
    { return 0; }
  yy764:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy764;
    }
    { return (bufsize_t)(p - start); }
  }
}

// Match ATX heading start.
bufsize_t _scan_atx_heading_start(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 128, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0,   0, 0, 0,
    };
    yych = *p;
    if (yych == '#')
      goto yy771;
    ++p;
  yy770 : { return 0; }
  yy771:
    yych = *(marker = ++p);
    if (yybm[0 + yych] & 128) {
      goto yy772;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy770;
      if (yych <= '\n')
        goto yy775;
      goto yy770;
    } else {
      if (yych <= '\r')
        goto yy775;
      if (yych == '#')
        goto yy776;
      goto yy770;
    }
  yy772:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy772;
    }
  yy774 : { return (bufsize_t)(p - start); }
  yy775:
    yych = *++p;
    goto yy774;
  yy776:
    yych = *++p;
    if (yybm[0 + yych] & 128) {
      goto yy772;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy777;
      if (yych <= '\n')
        goto yy775;
    } else {
      if (yych <= '\r')
        goto yy775;
      if (yych == '#')
        goto yy778;
    }
  yy777:
    p = marker;
    goto yy770;
  yy778:
    yych = *++p;
    if (yybm[0 + yych] & 128) {
      goto yy772;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy777;
      if (yych <= '\n')
        goto yy775;
      goto yy777;
    } else {
      if (yych <= '\r')
        goto yy775;
      if (yych != '#')
        goto yy777;
    }
    yych = *++p;
    if (yybm[0 + yych] & 128) {
      goto yy772;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy777;
      if (yych <= '\n')
        goto yy775;
      goto yy777;
    } else {
      if (yych <= '\r')
        goto yy775;
      if (yych != '#')
        goto yy777;
    }
    yych = *++p;
    if (yybm[0 + yych] & 128) {
      goto yy772;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy777;
      if (yych <= '\n')
        goto yy775;
      goto yy777;
    } else {
      if (yych <= '\r')
        goto yy775;
      if (yych != '#')
        goto yy777;
    }
    ++p;
    if (yybm[0 + (yych = *p)] & 128) {
      goto yy772;
    }
    if (yych <= 0x08)
      goto yy777;
    if (yych <= '\n')
      goto yy775;
    if (yych == '\r')
      goto yy775;
    goto yy777;
  }
}

// Match setext heading line.  Return 1 for level-1 heading,
// 2 for level-2, 0 for no match.
bufsize_t _scan_setext_heading_line(const unsigned char *p) {
  const unsigned char *marker = NULL;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        0, 0,  0, 0, 0, 0, 0, 0, 0, 32, 0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  32, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 64, 0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 128, 0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0,
        0, 0,  0, 0, 0, 0, 0, 0, 0, 0,  0,  0, 0, 0,
    };
    yych = *p;
    if (yych == '-')
      goto yy786;
    if (yych == '=')
      goto yy787;
    ++p;
  yy785 : { return 0; }
  yy786:
    yych = *(marker = ++p);
    if (yybm[0 + yych] & 64) {
      goto yy793;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy785;
      if (yych <= '\n')
        goto yy789;
      goto yy785;
    } else {
      if (yych <= '\r')
        goto yy789;
      if (yych == ' ')
        goto yy789;
      goto yy785;
    }
  yy787:
    yych = *(marker = ++p);
    if (yybm[0 + yych] & 128) {
      goto yy799;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy785;
      if (yych <= '\n')
        goto yy796;
      goto yy785;
    } else {
      if (yych <= '\r')
        goto yy796;
      if (yych == ' ')
        goto yy796;
      goto yy785;
    }
  yy788:
    ++p;
    yych = *p;
  yy789:
    if (yybm[0 + yych] & 32) {
      goto yy788;
    }
    if (yych <= 0x08)
      goto yy790;
    if (yych <= '\n')
      goto yy791;
    if (yych == '\r')
      goto yy791;
  yy790:
    p = marker;
    goto yy785;
  yy791:
    ++p;
    { return 2; }
  yy793:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 32) {
      goto yy788;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy790;
      if (yych <= '\n')
        goto yy791;
      goto yy790;
    } else {
      if (yych <= '\r')
        goto yy791;
      if (yych == '-')
        goto yy793;
      goto yy790;
    }
  yy795:
    ++p;
    yych = *p;
  yy796:
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy790;
      if (yych <= '\t')
        goto yy795;
      if (yych >= '\v')
        goto yy790;
    } else {
      if (yych <= '\r')
        goto yy797;
      if (yych == ' ')
        goto yy795;
      goto yy790;
    }
  yy797:
    ++p;
    { return 1; }
  yy799:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy799;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy790;
      if (yych <= '\t')
        goto yy795;
      if (yych <= '\n')
        goto yy797;
      goto yy790;
    } else {
      if (yych <= '\r')
        goto yy797;
      if (yych == ' ')
        goto yy795;
      goto yy790;
    }
  }
}

// Scan a thematic break line: "...three or more hyphens, asterisks,
// or underscores on a line by themselves. If you wish, you may use
// spaces between the hyphens or asterisks."
bufsize_t _scan_thematic_break(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        0, 0, 0,  0, 0, 0,  0, 0, 0, 240, 0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 240, 0, 0, 0,   0, 0, 0, 0,
        0, 0, 32, 0, 0, 64, 0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 128, 0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,   0, 0, 0, 0,
        0, 0, 0,  0, 0, 0,  0, 0, 0, 0,   0, 0, 0,   0, 0, 0,
    };
    yych = *p;
    if (yych <= ',') {
      if (yych == '*')
        goto yy805;
    } else {
      if (yych <= '-')
        goto yy806;
      if (yych == '_')
        goto yy807;
    }
    ++p;
  yy804 : { return 0; }
  yy805:
    yych = *(marker = ++p);
    if (yybm[0 + yych] & 16) {
      goto yy808;
    }
    if (yych == '*')
      goto yy811;
    goto yy804;
  yy806:
    yych = *(marker = ++p);
    if (yych <= 0x1F) {
      if (yych == '\t')
        goto yy813;
      goto yy804;
    } else {
      if (yych <= ' ')
        goto yy813;
      if (yych == '-')
        goto yy815;
      goto yy804;
    }
  yy807:
    yych = *(marker = ++p);
    if (yych <= 0x1F) {
      if (yych == '\t')
        goto yy817;
      goto yy804;
    } else {
      if (yych <= ' ')
        goto yy817;
      if (yych == '_')
        goto yy819;
      goto yy804;
    }
  yy808:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 16) {
      goto yy808;
    }
    if (yych == '*')
      goto yy811;
  yy810:
    p = marker;
    goto yy804;
  yy811:
    ++p;
    yych = *p;
    if (yych <= 0x1F) {
      if (yych == '\t')
        goto yy811;
      goto yy810;
    } else {
      if (yych <= ' ')
        goto yy811;
      if (yych == '*')
        goto yy821;
      goto yy810;
    }
  yy813:
    ++p;
    yych = *p;
    if (yych <= 0x1F) {
      if (yych == '\t')
        goto yy813;
      goto yy810;
    } else {
      if (yych <= ' ')
        goto yy813;
      if (yych != '-')
        goto yy810;
    }
  yy815:
    ++p;
    yych = *p;
    if (yych <= 0x1F) {
      if (yych == '\t')
        goto yy815;
      goto yy810;
    } else {
      if (yych <= ' ')
        goto yy815;
      if (yych == '-')
        goto yy823;
      goto yy810;
    }
  yy817:
    ++p;
    yych = *p;
    if (yych <= 0x1F) {
      if (yych == '\t')
        goto yy817;
      goto yy810;
    } else {
      if (yych <= ' ')
        goto yy817;
      if (yych != '_')
        goto yy810;
    }
  yy819:
    ++p;
    yych = *p;
    if (yych <= 0x1F) {
      if (yych == '\t')
        goto yy819;
      goto yy810;
    } else {
      if (yych <= ' ')
        goto yy819;
      if (yych == '_')
        goto yy825;
      goto yy810;
    }
  yy821:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 32) {
      goto yy821;
    }
    if (yych <= 0x08)
      goto yy810;
    if (yych <= '\n')
      goto yy827;
    if (yych == '\r')
      goto yy827;
    goto yy810;
  yy823:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy823;
    }
    if (yych <= 0x08)
      goto yy810;
    if (yych <= '\n')
      goto yy829;
    if (yych == '\r')
      goto yy829;
    goto yy810;
  yy825:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy825;
    }
    if (yych <= 0x08)
      goto yy810;
    if (yych <= '\n')
      goto yy831;
    if (yych == '\r')
      goto yy831;
    goto yy810;
  yy827:
    ++p;
    { return (bufsize_t)(p - start); }
  yy829:
    ++p;
    { return (bufsize_t)(p - start); }
  yy831:
    ++p;
    { return (bufsize_t)(p - start); }
  }
}

// Scan an opening code fence.
bufsize_t _scan_open_code_fence(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        0,   192, 192, 192, 192, 192, 192, 192, 192, 192, 0,   192, 192, 0,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 144, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192,
        96,  192, 0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
        0,   0,   0,   0,
    };
    yych = *p;
    if (yych == '`')
      goto yy837;
    if (yych == '~')
      goto yy838;
    ++p;
  yy836 : { return 0; }
  yy837:
    yych = *(marker = ++p);
    if (yych == '`')
      goto yy839;
    goto yy836;
  yy838:
    yych = *(marker = ++p);
    if (yych == '~')
      goto yy841;
    goto yy836;
  yy839:
    yych = *++p;
    if (yybm[0 + yych] & 16) {
      goto yy842;
    }
  yy840:
    p = marker;
    goto yy836;
  yy841:
    yych = *++p;
    if (yybm[0 + yych] & 32) {
      goto yy844;
    }
    goto yy840;
  yy842:
    ++p;
    yych = *p;
    marker = p;
    if (yybm[0 + yych] & 64) {
      goto yy846;
    }
    if (yych <= 0xE0) {
      if (yych <= '`') {
        if (yych <= 0x00)
          goto yy840;
        if (yych <= '\r')
          goto yy848;
        goto yy842;
      } else {
        if (yych <= 0xC1)
          goto yy840;
        if (yych <= 0xDF)
          goto yy850;
        goto yy851;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy853;
        goto yy852;
      } else {
        if (yych <= 0xF0)
          goto yy854;
        if (yych <= 0xF3)
          goto yy855;
        if (yych <= 0xF4)
          goto yy856;
        goto yy840;
      }
    }
  yy844:
    ++p;
    yych = *p;
    marker = p;
    if (yybm[0 + yych] & 128) {
      goto yy857;
    }
    if (yych <= 0xE0) {
      if (yych <= '~') {
        if (yych <= 0x00)
          goto yy840;
        if (yych <= '\r')
          goto yy859;
        goto yy844;
      } else {
        if (yych <= 0xC1)
          goto yy840;
        if (yych <= 0xDF)
          goto yy861;
        goto yy862;
      }
    } else {
      if (yych <= 0xEF) {
        if (yych == 0xED)
          goto yy864;
        goto yy863;
      } else {
        if (yych <= 0xF0)
          goto yy865;
        if (yych <= 0xF3)
          goto yy866;
        if (yych <= 0xF4)
          goto yy867;
        goto yy840;
      }
    }
  yy846:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 64) {
      goto yy846;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy840;
        if (yych >= 0x0E)
          goto yy840;
      } else {
        if (yych <= 0xDF)
          goto yy850;
        if (yych <= 0xE0)
          goto yy851;
        goto yy852;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy853;
        if (yych <= 0xEF)
          goto yy852;
        goto yy854;
      } else {
        if (yych <= 0xF3)
          goto yy855;
        if (yych <= 0xF4)
          goto yy856;
        goto yy840;
      }
    }
  yy848:
    ++p;
    p = marker;
    { return (bufsize_t)(p - start); }
  yy850:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy846;
    goto yy840;
  yy851:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy850;
    goto yy840;
  yy852:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy850;
    goto yy840;
  yy853:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0x9F)
      goto yy850;
    goto yy840;
  yy854:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy852;
    goto yy840;
  yy855:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy852;
    goto yy840;
  yy856:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0x8F)
      goto yy852;
    goto yy840;
  yy857:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy857;
    }
    if (yych <= 0xEC) {
      if (yych <= 0xC1) {
        if (yych <= 0x00)
          goto yy840;
        if (yych >= 0x0E)
          goto yy840;
      } else {
        if (yych <= 0xDF)
          goto yy861;
        if (yych <= 0xE0)
          goto yy862;
        goto yy863;
      }
    } else {
      if (yych <= 0xF0) {
        if (yych <= 0xED)
          goto yy864;
        if (yych <= 0xEF)
          goto yy863;
        goto yy865;
      } else {
        if (yych <= 0xF3)
          goto yy866;
        if (yych <= 0xF4)
          goto yy867;
        goto yy840;
      }
    }
  yy859:
    ++p;
    p = marker;
    { return (bufsize_t)(p - start); }
  yy861:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy857;
    goto yy840;
  yy862:
    ++p;
    yych = *p;
    if (yych <= 0x9F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy861;
    goto yy840;
  yy863:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy861;
    goto yy840;
  yy864:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0x9F)
      goto yy861;
    goto yy840;
  yy865:
    ++p;
    yych = *p;
    if (yych <= 0x8F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy863;
    goto yy840;
  yy866:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0xBF)
      goto yy863;
    goto yy840;
  yy867:
    ++p;
    yych = *p;
    if (yych <= 0x7F)
      goto yy840;
    if (yych <= 0x8F)
      goto yy863;
    goto yy840;
  }
}

// Scan a closing code fence with length at least len.
bufsize_t _scan_close_code_fence(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    static const unsigned char yybm[] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0,  128, 0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   128, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 32, 0,   0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,  0,   0,   0, 0, 0,
    };
    yych = *p;
    if (yych == '`')
      goto yy872;
    if (yych == '~')
      goto yy873;
    ++p;
  yy871 : { return 0; }
  yy872:
    yych = *(marker = ++p);
    if (yych == '`')
      goto yy874;
    goto yy871;
  yy873:
    yych = *(marker = ++p);
    if (yych == '~')
      goto yy876;
    goto yy871;
  yy874:
    yych = *++p;
    if (yybm[0 + yych] & 32) {
      goto yy877;
    }
  yy875:
    p = marker;
    goto yy871;
  yy876:
    yych = *++p;
    if (yybm[0 + yych] & 64) {
      goto yy879;
    }
    goto yy875;
  yy877:
    ++p;
    yych = *p;
    marker = p;
    if (yybm[0 + yych] & 128) {
      goto yy881;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy875;
      if (yych <= '\n')
        goto yy883;
      goto yy875;
    } else {
      if (yych <= '\r')
        goto yy883;
      if (yych == '`')
        goto yy877;
      goto yy875;
    }
  yy879:
    ++p;
    yych = *p;
    marker = p;
    if (yybm[0 + yych] & 64) {
      goto yy879;
    }
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy875;
      if (yych <= '\t')
        goto yy885;
      if (yych <= '\n')
        goto yy887;
      goto yy875;
    } else {
      if (yych <= '\r')
        goto yy887;
      if (yych == ' ')
        goto yy885;
      goto yy875;
    }
  yy881:
    ++p;
    yych = *p;
    if (yybm[0 + yych] & 128) {
      goto yy881;
    }
    if (yych <= 0x08)
      goto yy875;
    if (yych <= '\n')
      goto yy883;
    if (yych != '\r')
      goto yy875;
  yy883:
    ++p;
    p = marker;
    { return (bufsize_t)(p - start); }
  yy885:
    ++p;
    yych = *p;
    if (yych <= '\f') {
      if (yych <= 0x08)
        goto yy875;
      if (yych <= '\t')
        goto yy885;
      if (yych >= '\v')
        goto yy875;
    } else {
      if (yych <= '\r')
        goto yy887;
      if (yych == ' ')
        goto yy885;
      goto yy875;
    }
  yy887:
    ++p;
    p = marker;
    { return (bufsize_t)(p - start); }
  }
}

// Scans an entity.
// Returns number of chars matched.
bufsize_t _scan_entity(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    yych = *p;
    if (yych == '&')
      goto yy893;
    ++p;
  yy892 : { return 0; }
  yy893:
    yych = *(marker = ++p);
    if (yych <= '@') {
      if (yych != '#')
        goto yy892;
    } else {
      if (yych <= 'Z')
        goto yy896;
      if (yych <= '`')
        goto yy892;
      if (yych <= 'z')
        goto yy896;
      goto yy892;
    }
    yych = *++p;
    if (yych <= 'W') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy897;
    } else {
      if (yych <= 'X')
        goto yy898;
      if (yych == 'x')
        goto yy898;
    }
  yy895:
    p = marker;
    goto yy892;
  yy896:
    yych = *++p;
    if (yych <= '@') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy899;
      goto yy895;
    } else {
      if (yych <= 'Z')
        goto yy899;
      if (yych <= '`')
        goto yy895;
      if (yych <= 'z')
        goto yy899;
      goto yy895;
    }
  yy897:
    yych = *++p;
    if (yych <= '/')
      goto yy895;
    if (yych <= '9')
      goto yy900;
    if (yych == ';')
      goto yy901;
    goto yy895;
  yy898:
    yych = *++p;
    if (yych <= '@') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy903;
      goto yy895;
    } else {
      if (yych <= 'F')
        goto yy903;
      if (yych <= '`')
        goto yy895;
      if (yych <= 'f')
        goto yy903;
      goto yy895;
    }
  yy899:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy904;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
        goto yy904;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'z')
          goto yy904;
        goto yy895;
      }
    }
  yy900:
    yych = *++p;
    if (yych <= '/')
      goto yy895;
    if (yych <= '9')
      goto yy905;
    if (yych != ';')
      goto yy895;
  yy901:
    ++p;
    { return (bufsize_t)(p - start); }
  yy903:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy906;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'F') {
        if (yych <= '@')
          goto yy895;
        goto yy906;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'f')
          goto yy906;
        goto yy895;
      }
    }
  yy904:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy907;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
        goto yy907;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'z')
          goto yy907;
        goto yy895;
      }
    }
  yy905:
    yych = *++p;
    if (yych <= '/')
      goto yy895;
    if (yych <= '9')
      goto yy908;
    if (yych == ';')
      goto yy901;
    goto yy895;
  yy906:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy909;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'F') {
        if (yych <= '@')
          goto yy895;
        goto yy909;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'f')
          goto yy909;
        goto yy895;
      }
    }
  yy907:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy910;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
        goto yy910;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'z')
          goto yy910;
        goto yy895;
      }
    }
  yy908:
    yych = *++p;
    if (yych <= '/')
      goto yy895;
    if (yych <= '9')
      goto yy911;
    if (yych == ';')
      goto yy901;
    goto yy895;
  yy909:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy912;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'F') {
        if (yych <= '@')
          goto yy895;
        goto yy912;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'f')
          goto yy912;
        goto yy895;
      }
    }
  yy910:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy913;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
        goto yy913;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'z')
          goto yy913;
        goto yy895;
      }
    }
  yy911:
    yych = *++p;
    if (yych <= '/')
      goto yy895;
    if (yych <= '9')
      goto yy914;
    if (yych == ';')
      goto yy901;
    goto yy895;
  yy912:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy915;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'F') {
        if (yych <= '@')
          goto yy895;
        goto yy915;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'f')
          goto yy915;
        goto yy895;
      }
    }
  yy913:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy916;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
        goto yy916;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'z')
          goto yy916;
        goto yy895;
      }
    }
  yy914:
    yych = *++p;
    if (yych <= '/')
      goto yy895;
    if (yych <= '9')
      goto yy917;
    if (yych == ';')
      goto yy901;
    goto yy895;
  yy915:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy918;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'F') {
        if (yych <= '@')
          goto yy895;
        goto yy918;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'f')
          goto yy918;
        goto yy895;
      }
    }
  yy916:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy919;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
        goto yy919;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'z')
          goto yy919;
        goto yy895;
      }
    }
  yy917:
    yych = *++p;
    if (yych <= '/')
      goto yy895;
    if (yych <= '9')
      goto yy920;
    if (yych == ';')
      goto yy901;
    goto yy895;
  yy918:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy921;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'F') {
        if (yych <= '@')
          goto yy895;
        goto yy921;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'f')
          goto yy921;
        goto yy895;
      }
    }
  yy919:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy922;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
        goto yy922;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'z')
          goto yy922;
        goto yy895;
      }
    }
  yy920:
    yych = *++p;
    if (yych == ';')
      goto yy901;
    goto yy895;
  yy921:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy920;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'F') {
        if (yych <= '@')
          goto yy895;
        goto yy920;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'f')
          goto yy920;
        goto yy895;
      }
    }
  yy922:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy923;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy923:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy924;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy924:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy925;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy925:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy926;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy926:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy927;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy927:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy928;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy928:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy929;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy929:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy930;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy930:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy931;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy931:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy932;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy932:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy933;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy933:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy934;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy934:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy935;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy935:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy936;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy936:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy937;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy937:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy938;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy938:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy939;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy939:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy940;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy940:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy941;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy941:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy942;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy942:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy943;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy943:
    yych = *++p;
    if (yych <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy944;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych >= '{')
          goto yy895;
      }
    }
  yy944:
    ++p;
    if ((yych = *p) <= ';') {
      if (yych <= '/')
        goto yy895;
      if (yych <= '9')
        goto yy920;
      if (yych <= ':')
        goto yy895;
      goto yy901;
    } else {
      if (yych <= 'Z') {
        if (yych <= '@')
          goto yy895;
        goto yy920;
      } else {
        if (yych <= '`')
          goto yy895;
        if (yych <= 'z')
          goto yy920;
        goto yy895;
      }
    }
  }
}

// Returns positive value if a URL begins in a way that is potentially
// dangerous, with javascript:, vbscript:, file:, or data:, otherwise 0.
bufsize_t _scan_dangerous_url(const unsigned char *p) {
  const unsigned char *marker = NULL;
  const unsigned char *start = p;

  {
    unsigned char yych;
    unsigned int yyaccept = 0;
    yych = *p;
    if (yych <= 'V') {
      if (yych <= 'F') {
        if (yych == 'D')
          goto yy949;
        if (yych >= 'F')
          goto yy950;
      } else {
        if (yych == 'J')
          goto yy951;
        if (yych >= 'V')
          goto yy952;
      }
    } else {
      if (yych <= 'f') {
        if (yych == 'd')
          goto yy949;
        if (yych >= 'f')
          goto yy950;
      } else {
        if (yych <= 'j') {
          if (yych >= 'j')
            goto yy951;
        } else {
          if (yych == 'v')
            goto yy952;
        }
      }
    }
    ++p;
  yy948 : { return 0; }
  yy949:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych == 'A')
      goto yy953;
    if (yych == 'a')
      goto yy953;
    goto yy948;
  yy950:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych == 'I')
      goto yy955;
    if (yych == 'i')
      goto yy955;
    goto yy948;
  yy951:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych == 'A')
      goto yy956;
    if (yych == 'a')
      goto yy956;
    goto yy948;
  yy952:
    yyaccept = 0;
    yych = *(marker = ++p);
    if (yych == 'B')
      goto yy957;
    if (yych == 'b')
      goto yy957;
    goto yy948;
  yy953:
    yych = *++p;
    if (yych == 'T')
      goto yy958;
    if (yych == 't')
      goto yy958;
  yy954:
    p = marker;
    if (yyaccept == 0) {
      goto yy948;
    } else {
      goto yy966;
    }
  yy955:
    yych = *++p;
    if (yych == 'L')
      goto yy959;
    if (yych == 'l')
      goto yy959;
    goto yy954;
  yy956:
    yych = *++p;
    if (yych == 'V')
      goto yy960;
    if (yych == 'v')
      goto yy960;
    goto yy954;
  yy957:
    yych = *++p;
    if (yych == 'S')
      goto yy961;
    if (yych == 's')
      goto yy961;
    goto yy954;
  yy958:
    yych = *++p;
    if (yych == 'A')
      goto yy962;
    if (yych == 'a')
      goto yy962;
    goto yy954;
  yy959:
    yych = *++p;
    if (yych == 'E')
      goto yy963;
    if (yych == 'e')
      goto yy963;
    goto yy954;
  yy960:
    yych = *++p;
    if (yych == 'A')
      goto yy957;
    if (yych == 'a')
      goto yy957;
    goto yy954;
  yy961:
    yych = *++p;
    if (yych == 'C')
      goto yy964;
    if (yych == 'c')
      goto yy964;
    goto yy954;
  yy962:
    yych = *++p;
    if (yych == ':')
      goto yy965;
    goto yy954;
  yy963:
    yych = *++p;
    if (yych == ':')
      goto yy967;
    goto yy954;
  yy964:
    yych = *++p;
    if (yych == 'R')
      goto yy968;
    if (yych == 'r')
      goto yy968;
    goto yy954;
  yy965:
    yyaccept = 1;
    yych = *(marker = ++p);
    if (yych == 'I')
      goto yy969;
    if (yych == 'i')
      goto yy969;
  yy966 : { return (bufsize_t)(p - start); }
  yy967:
    yych = *++p;
    goto yy966;
  yy968:
    yych = *++p;
    if (yych == 'I')
      goto yy970;
    if (yych == 'i')
      goto yy970;
    goto yy954;
  yy969:
    yych = *++p;
    if (yych == 'M')
      goto yy971;
    if (yych == 'm')
      goto yy971;
    goto yy954;
  yy970:
    yych = *++p;
    if (yych == 'P')
      goto yy972;
    if (yych == 'p')
      goto yy972;
    goto yy954;
  yy971:
    yych = *++p;
    if (yych == 'A')
      goto yy973;
    if (yych == 'a')
      goto yy973;
    goto yy954;
  yy972:
    yych = *++p;
    if (yych == 'T')
      goto yy963;
    if (yych == 't')
      goto yy963;
    goto yy954;
  yy973:
    yych = *++p;
    if (yych == 'G')
      goto yy974;
    if (yych != 'g')
      goto yy954;
  yy974:
    yych = *++p;
    if (yych == 'E')
      goto yy975;
    if (yych != 'e')
      goto yy954;
  yy975:
    yych = *++p;
    if (yych != '/')
      goto yy954;
    yych = *++p;
    if (yych <= 'W') {
      if (yych <= 'J') {
        if (yych == 'G')
          goto yy977;
        if (yych <= 'I')
          goto yy954;
        goto yy978;
      } else {
        if (yych == 'P')
          goto yy979;
        if (yych <= 'V')
          goto yy954;
        goto yy980;
      }
    } else {
      if (yych <= 'j') {
        if (yych == 'g')
          goto yy977;
        if (yych <= 'i')
          goto yy954;
        goto yy978;
      } else {
        if (yych <= 'p') {
          if (yych <= 'o')
            goto yy954;
          goto yy979;
        } else {
          if (yych == 'w')
            goto yy980;
          goto yy954;
        }
      }
    }
  yy977:
    yych = *++p;
    if (yych == 'I')
      goto yy981;
    if (yych == 'i')
      goto yy981;
    goto yy954;
  yy978:
    yych = *++p;
    if (yych == 'P')
      goto yy982;
    if (yych == 'p')
      goto yy982;
    goto yy954;
  yy979:
    yych = *++p;
    if (yych == 'N')
      goto yy983;
    if (yych == 'n')
      goto yy983;
    goto yy954;
  yy980:
    yych = *++p;
    if (yych == 'E')
      goto yy984;
    if (yych == 'e')
      goto yy984;
    goto yy954;
  yy981:
    yych = *++p;
    if (yych == 'F')
      goto yy985;
    if (yych == 'f')
      goto yy985;
    goto yy954;
  yy982:
    yych = *++p;
    if (yych == 'E')
      goto yy983;
    if (yych != 'e')
      goto yy954;
  yy983:
    yych = *++p;
    if (yych == 'G')
      goto yy985;
    if (yych == 'g')
      goto yy985;
    goto yy954;
  yy984:
    yych = *++p;
    if (yych == 'B')
      goto yy987;
    if (yych == 'b')
      goto yy987;
    goto yy954;
  yy985:
    ++p;
    { return 0; }
  yy987:
    ++p;
    if ((yych = *p) == 'P')
      goto yy985;
    if (yych == 'p')
      goto yy985;
    goto yy954;
  }
}


static const char *EMDASH = "\xE2\x80\x94";
static const char *ENDASH = "\xE2\x80\x93";
static const char *ELLIPSES = "\xE2\x80\xA6";
static const char *LEFTDOUBLEQUOTE = "\xE2\x80\x9C";
static const char *RIGHTDOUBLEQUOTE = "\xE2\x80\x9D";
static const char *LEFTSINGLEQUOTE = "\xE2\x80\x98";
static const char *RIGHTSINGLEQUOTE = "\xE2\x80\x99";

// Macros for creating various kinds of simple.
#define make_str(mem, s) make_literal(mem, CMARK_NODE_TEXT, s)
#define make_code(mem, s) make_literal(mem, CMARK_NODE_CODE, s)
#define make_raw_html(mem, s) make_literal(mem, CMARK_NODE_HTML_INLINE, s)
#define make_linebreak(mem) make_simple(mem, CMARK_NODE_LINEBREAK)
#define make_softbreak(mem) make_simple(mem, CMARK_NODE_SOFTBREAK)
#define make_emph(mem) make_simple(mem, CMARK_NODE_EMPH)
#define make_strong(mem) make_simple(mem, CMARK_NODE_STRONG)

#define MAXBACKTICKS 1000

typedef struct delimiter {
  struct delimiter *previous;
  struct delimiter *next;
  cmark_node *inl_text;
  bufsize_t length;
  unsigned char delim_char;
  bool can_open;
  bool can_close;
} delimiter;

typedef struct bracket {
  struct bracket *previous;
  struct delimiter *previous_delimiter;
  cmark_node *inl_text;
  bufsize_t position;
  bool image;
  bool active;
  bool bracket_after;
} bracket;

typedef struct {
  cmark_mem *mem;
  cmark_chunk input;
  bufsize_t pos;
  cmark_reference_map *refmap;
  delimiter *last_delim;
  bracket *last_bracket;
  bufsize_t backticks[MAXBACKTICKS + 1];
  bool scanned_for_backticks;
} subject;

static CMARK_INLINE bool S_is_line_end_char(char c) {
  return (c == '\n' || c == '\r');
}

static delimiter *S_insert_emph(subject *subj, delimiter *opener,
                                delimiter *closer);

static int parse_inline(subject *subj, cmark_node *parent, int options);

static void subject_from_buf(cmark_mem *mem, subject *e, cmark_strbuf *buffer,
                             cmark_reference_map *refmap);
static bufsize_t subject_find_special_char(subject *subj, int options);

// Create an inline with a literal string value.
static CMARK_INLINE cmark_node *make_literal(cmark_mem *mem, cmark_node_type t,
                                             cmark_chunk s) {
  cmark_node *e = (cmark_node *)mem->calloc(1, sizeof(*e));
  cmark_strbuf_init(mem, &e->content, 0);
  e->type = t;
  e->as.literal = s;
  return e;
}

// Create an inline with no value.
static CMARK_INLINE cmark_node *make_simple(cmark_mem *mem, cmark_node_type t) {
  cmark_node *e = (cmark_node *)mem->calloc(1, sizeof(*e));
  cmark_strbuf_init(mem, &e->content, 0);
  e->type = t;
  return e;
}

// Like make_str, but parses entities.
static cmark_node *make_str_with_entities(cmark_mem *mem,
                                          cmark_chunk *content) {
  cmark_strbuf unescaped = CMARK_BUF_INIT(mem);

  if (houdini_unescape_html(&unescaped, content->data, content->len)) {
    return make_str(mem, cmark_chunk_buf_detach(&unescaped));
  } else {
    return make_str(mem, *content);
  }
}

// Duplicate a chunk by creating a copy of the buffer not by reusing the
// buffer like cmark_chunk_dup does.
static cmark_chunk chunk_clone(cmark_mem *mem, cmark_chunk *src) {
  cmark_chunk c;
  bufsize_t len = src->len;

  c.len = len;
  c.data = (unsigned char *)mem->calloc(len + 1, 1);
  c.alloc = 1;
  memcpy(c.data, src->data, len);
  c.data[len] = '\0';

  return c;
}

static cmark_chunk cmark_clean_autolink(cmark_mem *mem, cmark_chunk *url,
                                        int is_email) {
  cmark_strbuf buf = CMARK_BUF_INIT(mem);

  cmark_chunk_trim(url);

  if (url->len == 0) {
    cmark_chunk result = CMARK_CHUNK_EMPTY;
    return result;
  }

  if (is_email)
    cmark_strbuf_puts(&buf, "mailto:");

  houdini_unescape_html_f(&buf, url->data, url->len);
  return cmark_chunk_buf_detach(&buf);
}

static CMARK_INLINE cmark_node *make_autolink(cmark_mem *mem, cmark_chunk url,
                                              int is_email) {
  cmark_node *link = make_simple(mem, CMARK_NODE_LINK);
  link->as.link.url = cmark_clean_autolink(mem, &url, is_email);
  link->as.link.title = cmark_chunk_literal("");
  cmark_node_append_child(link, make_str_with_entities(mem, &url));
  return link;
}

static void subject_from_buf(cmark_mem *mem, subject *e, cmark_strbuf *buffer,
                             cmark_reference_map *refmap) {
  int i;
  e->mem = mem;
  e->input.data = buffer->ptr;
  e->input.len = buffer->size;
  e->input.alloc = 0;
  e->pos = 0;
  e->refmap = refmap;
  e->last_delim = NULL;
  e->last_bracket = NULL;
  for (i = 0; i <= MAXBACKTICKS; i++) {
    e->backticks[i] = 0;
  }
  e->scanned_for_backticks = false;
}

static CMARK_INLINE int isbacktick(int c) { return (c == '`'); }

static CMARK_INLINE unsigned char peek_char(subject *subj) {
  // NULL bytes should have been stripped out by now.  If they're
  // present, it's a programming error:
  assert(!(subj->pos < subj->input.len && subj->input.data[subj->pos] == 0));
  return (subj->pos < subj->input.len) ? subj->input.data[subj->pos] : 0;
}

static CMARK_INLINE unsigned char peek_at(subject *subj, bufsize_t pos) {
  return subj->input.data[pos];
}

// Return true if there are more characters in the subject.
static CMARK_INLINE int is_eof(subject *subj) {
  return (subj->pos >= subj->input.len);
}

// Advance the subject.  Doesn't check for eof.
#define advance(subj) (subj)->pos += 1

static CMARK_INLINE bool skip_spaces(subject *subj) {
  bool skipped = false;
  while (peek_char(subj) == ' ' || peek_char(subj) == '\t') {
    advance(subj);
    skipped = true;
  }
  return skipped;
}

static CMARK_INLINE bool skip_line_end(subject *subj) {
  bool seen_line_end_char = false;
  if (peek_char(subj) == '\r') {
    advance(subj);
    seen_line_end_char = true;
  }
  if (peek_char(subj) == '\n') {
    advance(subj);
    seen_line_end_char = true;
  }
  return seen_line_end_char || is_eof(subj);
}

// Take characters while a predicate holds, and return a string.
static CMARK_INLINE cmark_chunk take_while(subject *subj, int (*f)(int)) {
  unsigned char c;
  bufsize_t startpos = subj->pos;
  bufsize_t len = 0;

  while ((c = peek_char(subj)) && (*f)(c)) {
    advance(subj);
    len++;
  }

  return cmark_chunk_dup(&subj->input, startpos, len);
}

// Try to process a backtick code span that began with a
// span of ticks of length openticklength length (already
// parsed).  Return 0 if you don't find matching closing
// backticks, otherwise return the position in the subject
// after the closing backticks.
static bufsize_t scan_to_closing_backticks(subject *subj,
                                           bufsize_t openticklength) {

  bool found = false;
  if (openticklength > MAXBACKTICKS) {
    // we limit backtick string length because of the array subj->backticks:
    return 0;
  }
  if (subj->scanned_for_backticks &&
      subj->backticks[openticklength] <= subj->pos) {
    // return if we already know there's no closer
    return 0;
  }
  while (!found) {
    // read non backticks
    unsigned char c;
    while ((c = peek_char(subj)) && c != '`') {
      advance(subj);
    }
    if (is_eof(subj)) {
      break;
    }
    bufsize_t numticks = 0;
    while (peek_char(subj) == '`') {
      advance(subj);
      numticks++;
    }
    // store position of ender
    if (numticks <= MAXBACKTICKS) {
      subj->backticks[numticks] = subj->pos - numticks;
    }
    if (numticks == openticklength) {
      return (subj->pos);
    }
  }
  // got through whole input without finding closer
  subj->scanned_for_backticks = true;
  return 0;
}

// Parse backtick code section or raw backticks, return an inline.
// Assumes that the subject has a backtick at the current position.
static cmark_node *handle_backticks(subject *subj) {
  cmark_chunk openticks = take_while(subj, isbacktick);
  bufsize_t startpos = subj->pos;
  bufsize_t endpos = scan_to_closing_backticks(subj, openticks.len);

  if (endpos == 0) {      // not found
    subj->pos = startpos; // rewind
    return make_str(subj->mem, openticks);
  } else {
    cmark_strbuf buf = CMARK_BUF_INIT(subj->mem);

    cmark_strbuf_set(&buf, subj->input.data + startpos,
                     endpos - startpos - openticks.len);
    cmark_strbuf_trim(&buf);
    cmark_strbuf_normalize_whitespace(&buf);

    return make_code(subj->mem, cmark_chunk_buf_detach(&buf));
  }
}

// Scan ***, **, or * and return number scanned, or 0.
// Advances position.
static int scan_delims(subject *subj, unsigned char c, bool *can_open,
                       bool *can_close) {
  int numdelims = 0;
  bufsize_t before_char_pos;
  int32_t after_char = 0;
  int32_t before_char = 0;
  int len;
  bool left_flanking, right_flanking;

  if (subj->pos == 0) {
    before_char = 10;
  } else {
    before_char_pos = subj->pos - 1;
    // walk back to the beginning of the UTF_8 sequence:
    while (peek_at(subj, before_char_pos) >> 6 == 2 && before_char_pos > 0) {
      before_char_pos -= 1;
    }
    len = cmark_utf8proc_iterate(subj->input.data + before_char_pos,
                                 subj->pos - before_char_pos, &before_char);
    if (len == -1) {
      before_char = 10;
    }
  }

  if (c == '\'' || c == '"') {
    numdelims++;
    advance(subj); // limit to 1 delim for quotes
  } else {
    while (peek_char(subj) == c) {
      numdelims++;
      advance(subj);
    }
  }

  len = cmark_utf8proc_iterate(subj->input.data + subj->pos,
                               subj->input.len - subj->pos, &after_char);
  if (len == -1) {
    after_char = 10;
  }
  left_flanking = numdelims > 0 && !cmark_utf8proc_is_space(after_char) &&
                  !(cmark_utf8proc_is_punctuation(after_char) &&
                    !cmark_utf8proc_is_space(before_char) &&
                    !cmark_utf8proc_is_punctuation(before_char));
  right_flanking = numdelims > 0 && !cmark_utf8proc_is_space(before_char) &&
                   !(cmark_utf8proc_is_punctuation(before_char) &&
                     !cmark_utf8proc_is_space(after_char) &&
                     !cmark_utf8proc_is_punctuation(after_char));
  if (c == '_') {
    *can_open = left_flanking &&
                (!right_flanking || cmark_utf8proc_is_punctuation(before_char));
    *can_close = right_flanking &&
                 (!left_flanking || cmark_utf8proc_is_punctuation(after_char));
  } else if (c == '\'' || c == '"') {
    *can_open = left_flanking && !right_flanking;
    *can_close = right_flanking;
  } else {
    *can_open = left_flanking;
    *can_close = right_flanking;
  }
  return numdelims;
}

/*
static void print_delimiters(subject *subj)
{
        delimiter *delim;
        delim = subj->last_delim;
        while (delim != NULL) {
                printf("Item at stack pos %p: %d %d %d next(%p) prev(%p)\n",
                       (void*)delim, delim->delim_char,
                       delim->can_open, delim->can_close,
                       (void*)delim->next, (void*)delim->previous);
                delim = delim->previous;
        }
}
*/

static void remove_delimiter(subject *subj, delimiter *delim) {
  if (delim == NULL)
    return;
  if (delim->next == NULL) {
    // end of list:
    assert(delim == subj->last_delim);
    subj->last_delim = delim->previous;
  } else {
    delim->next->previous = delim->previous;
  }
  if (delim->previous != NULL) {
    delim->previous->next = delim->next;
  }
  subj->mem->free(delim);
}

static void pop_bracket(subject *subj) {
  bracket *b;
  if (subj->last_bracket == NULL)
    return;
  b = subj->last_bracket;
  subj->last_bracket = subj->last_bracket->previous;
  subj->mem->free(b);
}

static void push_delimiter(subject *subj, unsigned char c, bool can_open,
                           bool can_close, cmark_node *inl_text) {
  delimiter *delim = (delimiter *)subj->mem->calloc(1, sizeof(delimiter));
  delim->delim_char = c;
  delim->can_open = can_open;
  delim->can_close = can_close;
  delim->inl_text = inl_text;
  delim->length = inl_text->as.literal.len;
  delim->previous = subj->last_delim;
  delim->next = NULL;
  if (delim->previous != NULL) {
    delim->previous->next = delim;
  }
  subj->last_delim = delim;
}

static void push_bracket(subject *subj, bool image, cmark_node *inl_text) {
  bracket *b = (bracket *)subj->mem->calloc(1, sizeof(bracket));
  if (subj->last_bracket != NULL) {
    subj->last_bracket->bracket_after = true;
  }
  b->image = image;
  b->active = true;
  b->inl_text = inl_text;
  b->previous = subj->last_bracket;
  b->previous_delimiter = subj->last_delim;
  b->position = subj->pos;
  b->bracket_after = false;
  subj->last_bracket = b;
}

// Assumes the subject has a c at the current position.
static cmark_node *handle_delim(subject *subj, unsigned char c, bool smart) {
  bufsize_t numdelims;
  cmark_node *inl_text;
  bool can_open, can_close;
  cmark_chunk contents;

  numdelims = scan_delims(subj, c, &can_open, &can_close);

  if (c == '\'' && smart) {
    contents = cmark_chunk_literal(RIGHTSINGLEQUOTE);
  } else if (c == '"' && smart) {
    contents =
        cmark_chunk_literal(can_close ? RIGHTDOUBLEQUOTE : LEFTDOUBLEQUOTE);
  } else {
    contents = cmark_chunk_dup(&subj->input, subj->pos - numdelims, numdelims);
  }

  inl_text = make_str(subj->mem, contents);

  if ((can_open || can_close) && (!(c == '\'' || c == '"') || smart)) {
    push_delimiter(subj, c, can_open, can_close, inl_text);
  }

  return inl_text;
}

// Assumes we have a hyphen at the current position.
static cmark_node *handle_hyphen(subject *subj, bool smart) {
  int startpos = subj->pos;

  advance(subj);

  if (!smart || peek_char(subj) != '-') {
    return make_str(subj->mem, cmark_chunk_literal("-"));
  }

  while (smart && peek_char(subj) == '-') {
    advance(subj);
  }

  int numhyphens = subj->pos - startpos;
  int en_count = 0;
  int em_count = 0;
  int i;
  cmark_strbuf buf = CMARK_BUF_INIT(subj->mem);

  if (numhyphens % 3 == 0) { // if divisible by 3, use all em dashes
    em_count = numhyphens / 3;
  } else if (numhyphens % 2 == 0) { // if divisible by 2, use all en dashes
    en_count = numhyphens / 2;
  } else if (numhyphens % 3 == 2) { // use one en dash at end
    en_count = 1;
    em_count = (numhyphens - 2) / 3;
  } else { // use two en dashes at the end
    en_count = 2;
    em_count = (numhyphens - 4) / 3;
  }

  for (i = em_count; i > 0; i--) {
    cmark_strbuf_puts(&buf, EMDASH);
  }

  for (i = en_count; i > 0; i--) {
    cmark_strbuf_puts(&buf, ENDASH);
  }

  return make_str(subj->mem, cmark_chunk_buf_detach(&buf));
}

// Assumes we have a period at the current position.
static cmark_node *handle_period(subject *subj, bool smart) {
  advance(subj);
  if (smart && peek_char(subj) == '.') {
    advance(subj);
    if (peek_char(subj) == '.') {
      advance(subj);
      return make_str(subj->mem, cmark_chunk_literal(ELLIPSES));
    } else {
      return make_str(subj->mem, cmark_chunk_literal(".."));
    }
  } else {
    return make_str(subj->mem, cmark_chunk_literal("."));
  }
}

static void process_emphasis(subject *subj, delimiter *stack_bottom) {
  delimiter *closer = subj->last_delim;
  delimiter *opener;
  delimiter *old_closer;
  bool opener_found;
  int openers_bottom_index;
  delimiter *openers_bottom[6] = {stack_bottom, stack_bottom, stack_bottom,
                                  stack_bottom, stack_bottom, stack_bottom};

  // move back to first relevant delim.
  while (closer != NULL && closer->previous != stack_bottom) {
    closer = closer->previous;
  }

  // now move forward, looking for closers, and handling each
  while (closer != NULL) {
    if (closer->can_close) {
      switch (closer->delim_char) {
      case '"':
        openers_bottom_index = 0;
        break;
      case '\'':
        openers_bottom_index = 1;
        break;
      case '_':
        openers_bottom_index = 2;
        break;
      case '*':
        openers_bottom_index = 3 + (closer->length % 3);
        break;
      default:
        assert(false);
      }

      // Now look backwards for first matching opener:
      opener = closer->previous;
      opener_found = false;
      while (opener != NULL && opener != openers_bottom[openers_bottom_index]) {
        if (opener->can_open && opener->delim_char == closer->delim_char) {
          // interior closer of size 2 can't match opener of size 1
          // or of size 1 can't match 2
          if (!(closer->can_open || opener->can_close) ||
              ((opener->length + closer->length) % 3) != 0) {
            opener_found = true;
            break;
          }
        }
        opener = opener->previous;
      }
      old_closer = closer;
      if (closer->delim_char == '*' || closer->delim_char == '_') {
        if (opener_found) {
          closer = S_insert_emph(subj, opener, closer);
        } else {
          closer = closer->next;
        }
      } else if (closer->delim_char == '\'') {
        cmark_chunk_free(subj->mem, &closer->inl_text->as.literal);
        closer->inl_text->as.literal = cmark_chunk_literal(RIGHTSINGLEQUOTE);
        if (opener_found) {
          cmark_chunk_free(subj->mem, &opener->inl_text->as.literal);
          opener->inl_text->as.literal = cmark_chunk_literal(LEFTSINGLEQUOTE);
        }
        closer = closer->next;
      } else if (closer->delim_char == '"') {
        cmark_chunk_free(subj->mem, &closer->inl_text->as.literal);
        closer->inl_text->as.literal = cmark_chunk_literal(RIGHTDOUBLEQUOTE);
        if (opener_found) {
          cmark_chunk_free(subj->mem, &opener->inl_text->as.literal);
          opener->inl_text->as.literal = cmark_chunk_literal(LEFTDOUBLEQUOTE);
        }
        closer = closer->next;
      }
      if (!opener_found) {
        // set lower bound for future searches for openers
        openers_bottom[openers_bottom_index] = old_closer->previous;
        if (!old_closer->can_open) {
          // we can remove a closer that can't be an
          // opener, once we've seen there's no
          // matching opener:
          remove_delimiter(subj, old_closer);
        }
      }
    } else {
      closer = closer->next;
    }
  }
  // free all delimiters in list until stack_bottom:
  while (subj->last_delim != NULL && subj->last_delim != stack_bottom) {
    remove_delimiter(subj, subj->last_delim);
  }
}

static delimiter *S_insert_emph(subject *subj, delimiter *opener,
                                delimiter *closer) {
  delimiter *delim, *tmp_delim;
  bufsize_t use_delims;
  cmark_node *opener_inl = opener->inl_text;
  cmark_node *closer_inl = closer->inl_text;
  bufsize_t opener_num_chars = opener_inl->as.literal.len;
  bufsize_t closer_num_chars = closer_inl->as.literal.len;
  cmark_node *tmp, *tmpnext, *emph;

  // calculate the actual number of characters used from this closer
  use_delims = (closer_num_chars >= 2 && opener_num_chars >=2) ? 2 : 1;

  // remove used characters from associated inlines.
  opener_num_chars -= use_delims;
  closer_num_chars -= use_delims;
  opener_inl->as.literal.len = opener_num_chars;
  closer_inl->as.literal.len = closer_num_chars;

  // free delimiters between opener and closer
  delim = closer->previous;
  while (delim != NULL && delim != opener) {
    tmp_delim = delim->previous;
    remove_delimiter(subj, delim);
    delim = tmp_delim;
  }

  // create new emph or strong, and splice it in to our inlines
  // between the opener and closer
  emph = use_delims == 1 ? make_emph(subj->mem) : make_strong(subj->mem);

  tmp = opener_inl->next;
  while (tmp && tmp != closer_inl) {
    tmpnext = tmp->next;
    cmark_node_append_child(emph, tmp);
    tmp = tmpnext;
  }
  cmark_node_insert_after(opener_inl, emph);

  // if opener has 0 characters, remove it and its associated inline
  if (opener_num_chars == 0) {
    cmark_node_free(opener_inl);
    remove_delimiter(subj, opener);
  }

  // if closer has 0 characters, remove it and its associated inline
  if (closer_num_chars == 0) {
    // remove empty closer inline
    cmark_node_free(closer_inl);
    // remove closer from list
    tmp_delim = closer->next;
    remove_delimiter(subj, closer);
    closer = tmp_delim;
  }

  return closer;
}

// Parse backslash-escape or just a backslash, returning an inline.
static cmark_node *handle_backslash(subject *subj) {
  advance(subj);
  unsigned char nextchar = peek_char(subj);
  if (cmark_ispunct(
          nextchar)) { // only ascii symbols and newline can be escaped
    advance(subj);
    return make_str(subj->mem, cmark_chunk_dup(&subj->input, subj->pos - 1, 1));
  } else if (!is_eof(subj) && skip_line_end(subj)) {
    return make_linebreak(subj->mem);
  } else {
    return make_str(subj->mem, cmark_chunk_literal("\\"));
  }
}

// Parse an entity or a regular "&" string.
// Assumes the subject has an '&' character at the current position.
static cmark_node *handle_entity(subject *subj) {
  cmark_strbuf ent = CMARK_BUF_INIT(subj->mem);
  bufsize_t len;

  advance(subj);

  len = houdini_unescape_ent(&ent, subj->input.data + subj->pos,
                             subj->input.len - subj->pos);

  if (len == 0)
    return make_str(subj->mem, cmark_chunk_literal("&"));

  subj->pos += len;
  return make_str(subj->mem, cmark_chunk_buf_detach(&ent));
}

// Clean a URL: remove surrounding whitespace and surrounding <>,
// and remove \ that escape punctuation.
cmark_chunk cmark_clean_url(cmark_mem *mem, cmark_chunk *url) {
  cmark_strbuf buf = CMARK_BUF_INIT(mem);

  cmark_chunk_trim(url);

  if (url->len == 0) {
    cmark_chunk result = CMARK_CHUNK_EMPTY;
    return result;
  }

  if (url->data[0] == '<' && url->data[url->len - 1] == '>') {
    houdini_unescape_html_f(&buf, url->data + 1, url->len - 2);
  } else {
    houdini_unescape_html_f(&buf, url->data, url->len);
  }

  cmark_strbuf_unescape(&buf);
  return cmark_chunk_buf_detach(&buf);
}

cmark_chunk cmark_clean_title(cmark_mem *mem, cmark_chunk *title) {
  cmark_strbuf buf = CMARK_BUF_INIT(mem);
  unsigned char first, last;

  if (title->len == 0) {
    cmark_chunk result = CMARK_CHUNK_EMPTY;
    return result;
  }

  first = title->data[0];
  last = title->data[title->len - 1];

  // remove surrounding quotes if any:
  if ((first == '\'' && last == '\'') || (first == '(' && last == ')') ||
      (first == '"' && last == '"')) {
    houdini_unescape_html_f(&buf, title->data + 1, title->len - 2);
  } else {
    houdini_unescape_html_f(&buf, title->data, title->len);
  }

  cmark_strbuf_unescape(&buf);
  return cmark_chunk_buf_detach(&buf);
}

// Parse an autolink or HTML tag.
// Assumes the subject has a '<' character at the current position.
static cmark_node *handle_pointy_brace(subject *subj) {
  bufsize_t matchlen = 0;
  cmark_chunk contents;

  advance(subj); // advance past first <

  // first try to match a URL autolink
  matchlen = scan_autolink_uri(&subj->input, subj->pos);
  if (matchlen > 0) {
    contents = cmark_chunk_dup(&subj->input, subj->pos, matchlen - 1);
    subj->pos += matchlen;

    return make_autolink(subj->mem, contents, 0);
  }

  // next try to match an email autolink
  matchlen = scan_autolink_email(&subj->input, subj->pos);
  if (matchlen > 0) {
    contents = cmark_chunk_dup(&subj->input, subj->pos, matchlen - 1);
    subj->pos += matchlen;

    return make_autolink(subj->mem, contents, 1);
  }

  // finally, try to match an html tag
  matchlen = scan_html_tag(&subj->input, subj->pos);
  if (matchlen > 0) {
    contents = cmark_chunk_dup(&subj->input, subj->pos - 1, matchlen + 1);
    subj->pos += matchlen;
    return make_raw_html(subj->mem, contents);
  }

  // if nothing matches, just return the opening <:
  return make_str(subj->mem, cmark_chunk_literal("<"));
}

// Parse a link label.  Returns 1 if successful.
// Note:  unescaped brackets are not allowed in labels.
// The label begins with `[` and ends with the first `]` character
// encountered.  Backticks in labels do not start code spans.
static int link_label(subject *subj, cmark_chunk *raw_label) {
  bufsize_t startpos = subj->pos;
  int length = 0;
  unsigned char c;

  // advance past [
  if (peek_char(subj) == '[') {
    advance(subj);
  } else {
    return 0;
  }

  while ((c = peek_char(subj)) && c != '[' && c != ']') {
    if (c == '\\') {
      advance(subj);
      length++;
      if (cmark_ispunct(peek_char(subj))) {
        advance(subj);
        length++;
      }
    } else {
      advance(subj);
      length++;
    }
    if (length > MAX_LINK_LABEL_LENGTH) {
      goto noMatch;
    }
  }

  if (c == ']') { // match found
    *raw_label =
        cmark_chunk_dup(&subj->input, startpos + 1, subj->pos - (startpos + 1));
    cmark_chunk_trim(raw_label);
    advance(subj); // advance past ]
    return 1;
  }

noMatch:
  subj->pos = startpos; // rewind
  return 0;
}
static bufsize_t manual_scan_link_url(cmark_chunk *input, bufsize_t offset) {
  bufsize_t i = offset;
  size_t nb_p = 0;

  if (i < input->len && input->data[i] == '<') {
    ++i;
    while (i < input->len) {
      if (input->data[i] == '>') {
        ++i;
        break;
      } else if (input->data[i] == '\\')
        i += 2;
      else if (cmark_isspace(input->data[i]))
        return -1;
      else
        ++i;
    }
  } else {
    while (i < input->len) {
      if (input->data[i] == '\\')
        i += 2;
      else if (input->data[i] == '(') {
        ++nb_p;
        ++i;
      } else if (input->data[i] == ')') {
        if (nb_p == 0)
          break;
        --nb_p;
        ++i;
      } else if (cmark_isspace(input->data[i]))
        break;
      else
        ++i;
    }
  }

  if (i >= input->len)
    return -1;
  return i - offset;
}
// Return a link, an image, or a literal close bracket.
static cmark_node *handle_close_bracket(subject *subj) {
  bufsize_t initial_pos, after_link_text_pos;
  bufsize_t starturl, endurl, starttitle, endtitle, endall;
  bufsize_t n;
  bufsize_t sps;
  cmark_reference *ref = NULL;
  cmark_chunk url_chunk, title_chunk;
  cmark_chunk url, title;
  bracket *opener;
  cmark_node *inl;
  cmark_chunk raw_label;
  int found_label;
  cmark_node *tmp, *tmpnext;
  bool is_image;

  advance(subj); // advance past ]
  initial_pos = subj->pos;

  // get last [ or ![
  opener = subj->last_bracket;

  if (opener == NULL) {
    return make_str(subj->mem, cmark_chunk_literal("]"));
  }

  if (!opener->active) {
    // take delimiter off stack
    pop_bracket(subj);
    return make_str(subj->mem, cmark_chunk_literal("]"));
  }

  // If we got here, we matched a potential link/image text.
  // Now we check to see if it's a link/image.
  is_image = opener->image;

  after_link_text_pos = subj->pos;

  // First, look for an inline link.
  if (peek_char(subj) == '(' &&
      ((sps = scan_spacechars(&subj->input, subj->pos + 1)) > -1) &&
      ((n = manual_scan_link_url(&subj->input, subj->pos + 1 + sps)) > -1)) {

    // try to parse an explicit link:
    starturl = subj->pos + 1 + sps; // after (
    endurl = starturl + n;
    starttitle = endurl + scan_spacechars(&subj->input, endurl);

    // ensure there are spaces btw url and title
    endtitle = (starttitle == endurl)
                   ? starttitle
                   : starttitle + scan_link_title(&subj->input, starttitle);

    endall = endtitle + scan_spacechars(&subj->input, endtitle);

    if (peek_at(subj, endall) == ')') {
      subj->pos = endall + 1;

      url_chunk = cmark_chunk_dup(&subj->input, starturl, endurl - starturl);
      title_chunk =
          cmark_chunk_dup(&subj->input, starttitle, endtitle - starttitle);
      url = cmark_clean_url(subj->mem, &url_chunk);
      title = cmark_clean_title(subj->mem, &title_chunk);
      cmark_chunk_free(subj->mem, &url_chunk);
      cmark_chunk_free(subj->mem, &title_chunk);
      goto match;

    } else {
      // it could still be a shortcut reference link
      subj->pos = after_link_text_pos;
    }
  }

  // Next, look for a following [link label] that matches in refmap.
  // skip spaces
  raw_label = cmark_chunk_literal("");
  found_label = link_label(subj, &raw_label);
  if (!found_label) {
    // If we have a shortcut reference link, back up
    // to before the spacse we skipped.
    subj->pos = initial_pos;
  }

  if ((!found_label || raw_label.len == 0) && !opener->bracket_after) {
    cmark_chunk_free(subj->mem, &raw_label);
    raw_label = cmark_chunk_dup(&subj->input, opener->position,
                                initial_pos - opener->position - 1);
    found_label = true;
  }

  if (found_label) {
    ref = cmark_reference_lookup(subj->refmap, &raw_label);
    cmark_chunk_free(subj->mem, &raw_label);
  }

  if (ref != NULL) { // found
    url = chunk_clone(subj->mem, &ref->url);
    title = chunk_clone(subj->mem, &ref->title);
    goto match;
  } else {
    goto noMatch;
  }

noMatch:
  // If we fall through to here, it means we didn't match a link:
  pop_bracket(subj); // remove this opener from delimiter list
  subj->pos = initial_pos;
  return make_str(subj->mem, cmark_chunk_literal("]"));

match:
  inl = make_simple(subj->mem, is_image ? CMARK_NODE_IMAGE : CMARK_NODE_LINK);
  inl->as.link.url = url;
  inl->as.link.title = title;
  cmark_node_insert_before(opener->inl_text, inl);
  // Add link text:
  tmp = opener->inl_text->next;
  while (tmp) {
    tmpnext = tmp->next;
    cmark_node_append_child(inl, tmp);
    tmp = tmpnext;
  }

  // Free the bracket [:
  cmark_node_free(opener->inl_text);

  process_emphasis(subj, opener->previous_delimiter);
  pop_bracket(subj);

  // Now, if we have a link, we also want to deactivate earlier link
  // delimiters. (This code can be removed if we decide to allow links
  // inside links.)
  if (!is_image) {
    opener = subj->last_bracket;
    while (opener != NULL) {
      if (!opener->image) {
        if (!opener->active) {
          break;
        } else {
          opener->active = false;
        }
      }
      opener = opener->previous;
    }
  }

  return NULL;
}

// Parse a hard or soft linebreak, returning an inline.
// Assumes the subject has a cr or newline at the current position.
static cmark_node *handle_newline(subject *subj) {
  bufsize_t nlpos = subj->pos;
  // skip over cr, crlf, or lf:
  if (peek_at(subj, subj->pos) == '\r') {
    advance(subj);
  }
  if (peek_at(subj, subj->pos) == '\n') {
    advance(subj);
  }
  // skip spaces at beginning of line
  skip_spaces(subj);
  if (nlpos > 1 && peek_at(subj, nlpos - 1) == ' ' &&
      peek_at(subj, nlpos - 2) == ' ') {
    return make_linebreak(subj->mem);
  } else {
    return make_softbreak(subj->mem);
  }
}

static bufsize_t subject_find_special_char(subject *subj, int options) {
  // "\r\n\\`&_*[]<!"
  static const int8_t SPECIAL_CHARS[256] = {
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1,
      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

  // " ' . -
  static const char SMART_PUNCT_CHARS[] = {
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  };

  bufsize_t n = subj->pos + 1;

  while (n < subj->input.len) {
    if (SPECIAL_CHARS[subj->input.data[n]])
      return n;
    if (options & CMARK_OPT_SMART && SMART_PUNCT_CHARS[subj->input.data[n]])
      return n;
    n++;
  }

  return subj->input.len;
}

// Parse an inline, advancing subject, and add it as a child of parent.
// Return 0 if no inline can be parsed, 1 otherwise.
static int parse_inline(subject *subj, cmark_node *parent, int options) {
  cmark_node *new_inl = NULL;
  cmark_chunk contents;
  unsigned char c;
  bufsize_t endpos;
  c = peek_char(subj);
  if (c == 0) {
    return 0;
  }
  switch (c) {
  case '\r':
  case '\n':
    new_inl = handle_newline(subj);
    break;
  case '`':
    new_inl = handle_backticks(subj);
    break;
  case '\\':
    new_inl = handle_backslash(subj);
    break;
  case '&':
    new_inl = handle_entity(subj);
    break;
  case '<':
    new_inl = handle_pointy_brace(subj);
    break;
  case '*':
  case '_':
  case '\'':
  case '"':
    new_inl = handle_delim(subj, c, (options & CMARK_OPT_SMART) != 0);
    break;
  case '-':
    new_inl = handle_hyphen(subj, (options & CMARK_OPT_SMART) != 0);
    break;
  case '.':
    new_inl = handle_period(subj, (options & CMARK_OPT_SMART) != 0);
    break;
  case '[':
    advance(subj);
    new_inl = make_str(subj->mem, cmark_chunk_literal("["));
    push_bracket(subj, false, new_inl);
    break;
  case ']':
    new_inl = handle_close_bracket(subj);
    break;
  case '!':
    advance(subj);
    if (peek_char(subj) == '[') {
      advance(subj);
      new_inl = make_str(subj->mem, cmark_chunk_literal("!["));
      push_bracket(subj, true, new_inl);
    } else {
      new_inl = make_str(subj->mem, cmark_chunk_literal("!"));
    }
    break;
  default:
    endpos = subject_find_special_char(subj, options);
    contents = cmark_chunk_dup(&subj->input, subj->pos, endpos - subj->pos);
    subj->pos = endpos;

    // if we're at a newline, strip trailing spaces.
    if (S_is_line_end_char(peek_char(subj))) {
      cmark_chunk_rtrim(&contents);
    }

    new_inl = make_str(subj->mem, contents);
  }
  if (new_inl != NULL) {
    cmark_node_append_child(parent, new_inl);
  }

  return 1;
}

// Parse inlines from parent's string_content, adding as children of parent.
extern void cmark_parse_inlines(cmark_mem *mem, cmark_node *parent,
                                cmark_reference_map *refmap, int options) {
  subject subj;
  subject_from_buf(mem, &subj, &parent->content, refmap);
  cmark_chunk_rtrim(&subj.input);

  while (!is_eof(&subj) && parse_inline(&subj, parent, options))
    ;

  process_emphasis(&subj, NULL);
  // free bracket and delim stack
  while (subj.last_delim) {
    pop_bracket(&subj);
  }
  while (subj.last_bracket) {
    pop_bracket(&subj);
  }
}

// Parse zero or more space characters, including at most one newline.
static void spnl(subject *subj) {
  skip_spaces(subj);
  if (skip_line_end(subj)) {
    skip_spaces(subj);
  }
}

// Parse reference.  Assumes string begins with '[' character.
// Modify refmap if a reference is encountered.
// Return 0 if no reference found, otherwise position of subject
// after reference is parsed.
bufsize_t cmark_parse_reference_inline(cmark_mem *mem, cmark_strbuf *input,
                                       cmark_reference_map *refmap) {
  subject subj;

  cmark_chunk lab;
  cmark_chunk url;
  cmark_chunk title;

  bufsize_t matchlen = 0;
  bufsize_t beforetitle;

  subject_from_buf(mem, &subj, input, NULL);

  // parse label:
  if (!link_label(&subj, &lab) || lab.len == 0)
    return 0;

  // colon:
  if (peek_char(&subj) == ':') {
    advance(&subj);
  } else {
    return 0;
  }

  // parse link url:
  spnl(&subj);
  matchlen = manual_scan_link_url(&subj.input, subj.pos);
  if (matchlen > 0) {
    url = cmark_chunk_dup(&subj.input, subj.pos, matchlen);
    subj.pos += matchlen;
  } else {
    return 0;
  }

  // parse optional link_title
  beforetitle = subj.pos;
  spnl(&subj);
  matchlen = scan_link_title(&subj.input, subj.pos);
  if (matchlen) {
    title = cmark_chunk_dup(&subj.input, subj.pos, matchlen);
    subj.pos += matchlen;
  } else {
    subj.pos = beforetitle;
    title = cmark_chunk_literal("");
  }

  // parse final spaces and newline:
  skip_spaces(&subj);
  if (!skip_line_end(&subj)) {
    if (matchlen) { // try rewinding before title
      subj.pos = beforetitle;
      skip_spaces(&subj);
      if (!skip_line_end(&subj)) {
        return 0;
      }
    } else {
      return 0;
    }
  }
  // insert reference into refmap
  cmark_reference_create(refmap, &lab, &url, &title);
  return subj.pos;
}


static const int8_t utf8proc_utf8class[256] = {
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
    2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
    4, 4, 4, 4, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0};

static void encode_unknown(cmark_strbuf *buf) {
  static const uint8_t repl[] = {239, 191, 189};
  cmark_strbuf_put(buf, repl, 3);
}

static int utf8proc_charlen(const uint8_t *str, bufsize_t str_len) {
  int length, i;

  if (!str_len)
    return 0;

  length = utf8proc_utf8class[str[0]];

  if (!length)
    return -1;

  if (str_len >= 0 && (bufsize_t)length > str_len)
    return -str_len;

  for (i = 1; i < length; i++) {
    if ((str[i] & 0xC0) != 0x80)
      return -i;
  }

  return length;
}

// Validate a single UTF-8 character according to RFC 3629.
static int utf8proc_valid(const uint8_t *str, bufsize_t str_len) {
  int length = utf8proc_utf8class[str[0]];

  if (!length)
    return -1;

  if ((bufsize_t)length > str_len)
    return -str_len;

  switch (length) {
  case 2:
    if ((str[1] & 0xC0) != 0x80)
      return -1;
    if (str[0] < 0xC2) {
      // Overlong
      return -length;
    }
    break;

  case 3:
    if ((str[1] & 0xC0) != 0x80)
      return -1;
    if ((str[2] & 0xC0) != 0x80)
      return -2;
    if (str[0] == 0xE0) {
      if (str[1] < 0xA0) {
        // Overlong
        return -length;
      }
    } else if (str[0] == 0xED) {
      if (str[1] >= 0xA0) {
        // Surrogate
        return -length;
      }
    }
    break;

  case 4:
    if ((str[1] & 0xC0) != 0x80)
      return -1;
    if ((str[2] & 0xC0) != 0x80)
      return -2;
    if ((str[3] & 0xC0) != 0x80)
      return -3;
    if (str[0] == 0xF0) {
      if (str[1] < 0x90) {
        // Overlong
        return -length;
      }
    } else if (str[0] >= 0xF4) {
      if (str[0] > 0xF4 || str[1] >= 0x90) {
        // Above 0x10FFFF
        return -length;
      }
    }
    break;
  }

  return length;
}

void cmark_utf8proc_check(cmark_strbuf *ob, const uint8_t *line,
                          bufsize_t size) {
  bufsize_t i = 0;

  while (i < size) {
    bufsize_t org = i;
    int charlen = 0;

    while (i < size) {
      if (line[i] < 0x80 && line[i] != 0) {
        i++;
      } else if (line[i] >= 0x80) {
        charlen = utf8proc_valid(line + i, size - i);
        if (charlen < 0) {
          charlen = -charlen;
          break;
        }
        i += charlen;
      } else if (line[i] == 0) {
        // ASCII NUL is technically valid but rejected
        // for security reasons.
        charlen = 1;
        break;
      }
    }

    if (i > org) {
      cmark_strbuf_put(ob, line + org, i - org);
    }

    if (i >= size) {
      break;
    } else {
      // Invalid UTF-8
      encode_unknown(ob);
      i += charlen;
    }
  }
}

int cmark_utf8proc_iterate(const uint8_t *str, bufsize_t str_len,
                           int32_t *dst) {
  int length;
  int32_t uc = -1;

  *dst = -1;
  length = utf8proc_charlen(str, str_len);
  if (length < 0)
    return -1;

  switch (length) {
  case 1:
    uc = str[0];
    break;
  case 2:
    uc = ((str[0] & 0x1F) << 6) + (str[1] & 0x3F);
    if (uc < 0x80)
      uc = -1;
    break;
  case 3:
    uc = ((str[0] & 0x0F) << 12) + ((str[1] & 0x3F) << 6) + (str[2] & 0x3F);
    if (uc < 0x800 || (uc >= 0xD800 && uc < 0xE000))
      uc = -1;
    break;
  case 4:
    uc = ((str[0] & 0x07) << 18) + ((str[1] & 0x3F) << 12) +
         ((str[2] & 0x3F) << 6) + (str[3] & 0x3F);
    if (uc < 0x10000 || uc >= 0x110000)
      uc = -1;
    break;
  }

  if (uc < 0)
    return -1;

  *dst = uc;
  return length;
}

void cmark_utf8proc_encode_char(int32_t uc, cmark_strbuf *buf) {
  uint8_t dst[4];
  bufsize_t len = 0;

  assert(uc >= 0);

  if (uc < 0x80) {
    dst[0] = (uint8_t)(uc);
    len = 1;
  } else if (uc < 0x800) {
    dst[0] = (uint8_t)(0xC0 + (uc >> 6));
    dst[1] = 0x80 + (uc & 0x3F);
    len = 2;
  } else if (uc == 0xFFFF) {
    dst[0] = 0xFF;
    len = 1;
  } else if (uc == 0xFFFE) {
    dst[0] = 0xFE;
    len = 1;
  } else if (uc < 0x10000) {
    dst[0] = (uint8_t)(0xE0 + (uc >> 12));
    dst[1] = 0x80 + ((uc >> 6) & 0x3F);
    dst[2] = 0x80 + (uc & 0x3F);
    len = 3;
  } else if (uc < 0x110000) {
    dst[0] = (uint8_t)(0xF0 + (uc >> 18));
    dst[1] = 0x80 + ((uc >> 12) & 0x3F);
    dst[2] = 0x80 + ((uc >> 6) & 0x3F);
    dst[3] = 0x80 + (uc & 0x3F);
    len = 4;
  } else {
    encode_unknown(buf);
    return;
  }

  cmark_strbuf_put(buf, dst, len);
}

void cmark_utf8proc_case_fold(cmark_strbuf *dest, const uint8_t *str,
                              bufsize_t len) {
  int32_t c;

#define bufpush(x) cmark_utf8proc_encode_char(x, dest)

  while (len > 0) {
    bufsize_t char_len = cmark_utf8proc_iterate(str, len, &c);

    if (char_len >= 0) {
#include "case_fold_switch.inc"
    } else {
      encode_unknown(dest);
      char_len = -char_len;
    }

    str += char_len;
    len -= char_len;
  }
}

// matches anything in the Zs class, plus LF, CR, TAB, FF.
int cmark_utf8proc_is_space(int32_t uc) {
  return (uc == 9 || uc == 10 || uc == 12 || uc == 13 || uc == 32 ||
          uc == 160 || uc == 5760 || (uc >= 8192 && uc <= 8202) || uc == 8239 ||
          uc == 8287 || uc == 12288);
}

// matches anything in the P[cdefios] classes.
int cmark_utf8proc_is_punctuation(int32_t uc) {
  return (
      (uc < 128 && cmark_ispunct((char)uc)) || uc == 161 || uc == 167 ||
      uc == 171 || uc == 182 || uc == 183 || uc == 187 || uc == 191 ||
      uc == 894 || uc == 903 || (uc >= 1370 && uc <= 1375) || uc == 1417 ||
      uc == 1418 || uc == 1470 || uc == 1472 || uc == 1475 || uc == 1478 ||
      uc == 1523 || uc == 1524 || uc == 1545 || uc == 1546 || uc == 1548 ||
      uc == 1549 || uc == 1563 || uc == 1566 || uc == 1567 ||
      (uc >= 1642 && uc <= 1645) || uc == 1748 || (uc >= 1792 && uc <= 1805) ||
      (uc >= 2039 && uc <= 2041) || (uc >= 2096 && uc <= 2110) || uc == 2142 ||
      uc == 2404 || uc == 2405 || uc == 2416 || uc == 2800 || uc == 3572 ||
      uc == 3663 || uc == 3674 || uc == 3675 || (uc >= 3844 && uc <= 3858) ||
      uc == 3860 || (uc >= 3898 && uc <= 3901) || uc == 3973 ||
      (uc >= 4048 && uc <= 4052) || uc == 4057 || uc == 4058 ||
      (uc >= 4170 && uc <= 4175) || uc == 4347 || (uc >= 4960 && uc <= 4968) ||
      uc == 5120 || uc == 5741 || uc == 5742 || uc == 5787 || uc == 5788 ||
      (uc >= 5867 && uc <= 5869) || uc == 5941 || uc == 5942 ||
      (uc >= 6100 && uc <= 6102) || (uc >= 6104 && uc <= 6106) ||
      (uc >= 6144 && uc <= 6154) || uc == 6468 || uc == 6469 || uc == 6686 ||
      uc == 6687 || (uc >= 6816 && uc <= 6822) || (uc >= 6824 && uc <= 6829) ||
      (uc >= 7002 && uc <= 7008) || (uc >= 7164 && uc <= 7167) ||
      (uc >= 7227 && uc <= 7231) || uc == 7294 || uc == 7295 ||
      (uc >= 7360 && uc <= 7367) || uc == 7379 || (uc >= 8208 && uc <= 8231) ||
      (uc >= 8240 && uc <= 8259) || (uc >= 8261 && uc <= 8273) ||
      (uc >= 8275 && uc <= 8286) || uc == 8317 || uc == 8318 || uc == 8333 ||
      uc == 8334 || (uc >= 8968 && uc <= 8971) || uc == 9001 || uc == 9002 ||
      (uc >= 10088 && uc <= 10101) || uc == 10181 || uc == 10182 ||
      (uc >= 10214 && uc <= 10223) || (uc >= 10627 && uc <= 10648) ||
      (uc >= 10712 && uc <= 10715) || uc == 10748 || uc == 10749 ||
      (uc >= 11513 && uc <= 11516) || uc == 11518 || uc == 11519 ||
      uc == 11632 || (uc >= 11776 && uc <= 11822) ||
      (uc >= 11824 && uc <= 11842) || (uc >= 12289 && uc <= 12291) ||
      (uc >= 12296 && uc <= 12305) || (uc >= 12308 && uc <= 12319) ||
      uc == 12336 || uc == 12349 || uc == 12448 || uc == 12539 || uc == 42238 ||
      uc == 42239 || (uc >= 42509 && uc <= 42511) || uc == 42611 ||
      uc == 42622 || (uc >= 42738 && uc <= 42743) ||
      (uc >= 43124 && uc <= 43127) || uc == 43214 || uc == 43215 ||
      (uc >= 43256 && uc <= 43258) || uc == 43310 || uc == 43311 ||
      uc == 43359 || (uc >= 43457 && uc <= 43469) || uc == 43486 ||
      uc == 43487 || (uc >= 43612 && uc <= 43615) || uc == 43742 ||
      uc == 43743 || uc == 43760 || uc == 43761 || uc == 44011 || uc == 64830 ||
      uc == 64831 || (uc >= 65040 && uc <= 65049) ||
      (uc >= 65072 && uc <= 65106) || (uc >= 65108 && uc <= 65121) ||
      uc == 65123 || uc == 65128 || uc == 65130 || uc == 65131 ||
      (uc >= 65281 && uc <= 65283) || (uc >= 65285 && uc <= 65290) ||
      (uc >= 65292 && uc <= 65295) || uc == 65306 || uc == 65307 ||
      uc == 65311 || uc == 65312 || (uc >= 65339 && uc <= 65341) ||
      uc == 65343 || uc == 65371 || uc == 65373 ||
      (uc >= 65375 && uc <= 65381) || (uc >= 65792 && uc <= 65794) ||
      uc == 66463 || uc == 66512 || uc == 66927 || uc == 67671 || uc == 67871 ||
      uc == 67903 || (uc >= 68176 && uc <= 68184) || uc == 68223 ||
      (uc >= 68336 && uc <= 68342) || (uc >= 68409 && uc <= 68415) ||
      (uc >= 68505 && uc <= 68508) || (uc >= 69703 && uc <= 69709) ||
      uc == 69819 || uc == 69820 || (uc >= 69822 && uc <= 69825) ||
      (uc >= 69952 && uc <= 69955) || uc == 70004 || uc == 70005 ||
      (uc >= 70085 && uc <= 70088) || uc == 70093 ||
      (uc >= 70200 && uc <= 70205) || uc == 70854 ||
      (uc >= 71105 && uc <= 71113) || (uc >= 71233 && uc <= 71235) ||
      (uc >= 74864 && uc <= 74868) || uc == 92782 || uc == 92783 ||
      uc == 92917 || (uc >= 92983 && uc <= 92987) || uc == 92996 ||
      uc == 113823);
}

static unsigned int refhash(const unsigned char *link_ref) {
  unsigned int hash = 0;

  while (*link_ref)
    hash = (*link_ref++) + (hash << 6) + (hash << 16) - hash;

  return hash;
}

static void reference_free(cmark_reference_map *map, cmark_reference *ref) {
  cmark_mem *mem = map->mem;
  if (ref != NULL) {
    mem->free(ref->label);
    cmark_chunk_free(mem, &ref->url);
    cmark_chunk_free(mem, &ref->title);
    mem->free(ref);
  }
}

// normalize reference:  collapse internal whitespace to single space,
// remove leading/trailing whitespace, case fold
// Return NULL if the reference name is actually empty (i.e. composed
// solely from whitespace)
static unsigned char *normalize_reference(cmark_mem *mem, cmark_chunk *ref) {
  cmark_strbuf normalized = CMARK_BUF_INIT(mem);
  unsigned char *result;

  if (ref == NULL)
    return NULL;

  if (ref->len == 0)
    return NULL;

  cmark_utf8proc_case_fold(&normalized, ref->data, ref->len);
  cmark_strbuf_trim(&normalized);
  cmark_strbuf_normalize_whitespace(&normalized);

  result = cmark_strbuf_detach(&normalized);
  assert(result);

  if (result[0] == '\0') {
    mem->free(result);
    return NULL;
  }

  return result;
}

static void add_reference(cmark_reference_map *map, cmark_reference *ref) {
  cmark_reference *t = ref->next = map->table[ref->hash % REFMAP_SIZE];

  while (t) {
    if (t->hash == ref->hash && !strcmp((char *)t->label, (char *)ref->label)) {
      reference_free(map, ref);
      return;
    }

    t = t->next;
  }

  map->table[ref->hash % REFMAP_SIZE] = ref;
}

void cmark_reference_create(cmark_reference_map *map, cmark_chunk *label,
                            cmark_chunk *url, cmark_chunk *title) {
  cmark_reference *ref;
  unsigned char *reflabel = normalize_reference(map->mem, label);

  /* empty reference name, or composed from only whitespace */
  if (reflabel == NULL)
    return;

  ref = (cmark_reference *)map->mem->calloc(1, sizeof(*ref));
  ref->label = reflabel;
  ref->hash = refhash(ref->label);
  ref->url = cmark_clean_url(map->mem, url);
  ref->title = cmark_clean_title(map->mem, title);
  ref->next = NULL;

  add_reference(map, ref);
}

// Returns reference if refmap contains a reference with matching
// label, otherwise NULL.
cmark_reference *cmark_reference_lookup(cmark_reference_map *map,
                                        cmark_chunk *label) {
  cmark_reference *ref = NULL;
  unsigned char *norm;
  unsigned int hash;

  if (label->len < 1 || label->len > MAX_LINK_LABEL_LENGTH)
    return NULL;

  if (map == NULL)
    return NULL;

  norm = normalize_reference(map->mem, label);
  if (norm == NULL)
    return NULL;

  hash = refhash(norm);
  ref = map->table[hash % REFMAP_SIZE];

  while (ref) {
    if (ref->hash == hash && !strcmp((char *)ref->label, (char *)norm))
      break;
    ref = ref->next;
  }

  map->mem->free(norm);
  return ref;
}

void cmark_reference_map_free(cmark_reference_map *map) {
  unsigned int i;

  if (map == NULL)
    return;

  for (i = 0; i < REFMAP_SIZE; ++i) {
    cmark_reference *ref = map->table[i];
    cmark_reference *next;

    while (ref) {
      next = ref->next;
      reference_free(map, ref);
      ref = next;
    }
  }

  map->mem->free(map);
}

cmark_reference_map *cmark_reference_map_new(cmark_mem *mem) {
  cmark_reference_map *map =
      (cmark_reference_map *)mem->calloc(1, sizeof(cmark_reference_map));
  map->mem = mem;
  return map;
}



/**
 * Block parsing implementation.
 *
 * For a high-level overview of the block parsing process,
 * see http://spec.commonmark.org/0.24/#phase-1-block-structure
 */


#define CODE_INDENT 4
#define TAB_STOP 4

#ifndef MIN
#define MIN(x, y) ((x < y) ? x : y)
#endif

#define peek_at(i, n) (i)->data[n]

static bool S_last_line_blank(const cmark_node *node) {
  return (node->flags & CMARK_NODE__LAST_LINE_BLANK) != 0;
}

static CMARK_INLINE cmark_node_type S_type(const cmark_node *node) {
  return (cmark_node_type)node->type;
}

static void S_set_last_line_blank(cmark_node *node, bool is_blank) {
  if (is_blank)
    node->flags |= CMARK_NODE__LAST_LINE_BLANK;
  else
    node->flags &= ~CMARK_NODE__LAST_LINE_BLANK;
}

static CMARK_INLINE bool S_is_space_or_tab(char c) {
  return (c == ' ' || c == '\t');
}

static void S_parser_feed(cmark_parser *parser, const unsigned char *buffer,
                          size_t len, bool eof);

static void S_process_line(cmark_parser *parser, const unsigned char *buffer,
                           bufsize_t bytes);

static cmark_node *make_block(cmark_mem *mem, cmark_node_type tag,
                              int start_line, int start_column) {
  cmark_node *e;

  e = (cmark_node *)mem->calloc(1, sizeof(*e));
  cmark_strbuf_init(mem, &e->content, 32);
  e->type = (uint16_t)tag;
  e->flags = CMARK_NODE__OPEN;
  e->start_line = start_line;
  e->start_column = start_column;
  e->end_line = start_line;

  return e;
}

// Create a root document node.
static cmark_node *make_document(cmark_mem *mem) {
  cmark_node *e = make_block(mem, CMARK_NODE_DOCUMENT, 1, 1);
  return e;
}

cmark_parser *cmark_parser_new_with_mem(int options, cmark_mem *mem) {
  cmark_parser *parser = (cmark_parser *)mem->calloc(1, sizeof(cmark_parser));
  parser->mem = mem;

  cmark_node *document = make_document(mem);

  cmark_strbuf_init(mem, &parser->curline, 256);
  cmark_strbuf_init(mem, &parser->linebuf, 0);

  parser->refmap = cmark_reference_map_new(mem);
  parser->root = document;
  parser->current = document;
  parser->line_number = 0;
  parser->offset = 0;
  parser->column = 0;
  parser->first_nonspace = 0;
  parser->first_nonspace_column = 0;
  parser->indent = 0;
  parser->blank = false;
  parser->partially_consumed_tab = false;
  parser->last_line_length = 0;
  parser->options = options;
  parser->last_buffer_ended_with_cr = false;

  return parser;
}

cmark_parser *cmark_parser_new(int options) {
  extern cmark_mem DEFAULT_MEM_ALLOCATOR;
  return cmark_parser_new_with_mem(options, &DEFAULT_MEM_ALLOCATOR);
}

void cmark_parser_free(cmark_parser *parser) {
  cmark_mem *mem = parser->mem;
  cmark_strbuf_free(&parser->curline);
  cmark_strbuf_free(&parser->linebuf);
  cmark_reference_map_free(parser->refmap);
  mem->free(parser);
}

static cmark_node *finalize(cmark_parser *parser, cmark_node *b);

// Returns true if line has only space characters, else false.
static bool is_blank(cmark_strbuf *s, bufsize_t offset) {
  while (offset < s->size) {
    switch (s->ptr[offset]) {
    case '\r':
    case '\n':
      return true;
    case ' ':
      offset++;
      break;
    case '\t':
      offset++;
      break;
    default:
      return false;
    }
  }

  return true;
}

static CMARK_INLINE bool can_contain(cmark_node_type parent_type,
                                     cmark_node_type child_type) {
  return (parent_type == CMARK_NODE_DOCUMENT ||
          parent_type == CMARK_NODE_BLOCK_QUOTE ||
          parent_type == CMARK_NODE_ITEM ||
          (parent_type == CMARK_NODE_LIST && child_type == CMARK_NODE_ITEM));
}

static CMARK_INLINE bool accepts_lines(cmark_node_type block_type) {
  return (block_type == CMARK_NODE_PARAGRAPH ||
          block_type == CMARK_NODE_HEADING ||
          block_type == CMARK_NODE_CODE_BLOCK);
}

static CMARK_INLINE bool contains_inlines(cmark_node_type block_type) {
  return (block_type == CMARK_NODE_PARAGRAPH ||
          block_type == CMARK_NODE_HEADING);
}

static void add_line(cmark_node *node, cmark_chunk *ch, cmark_parser *parser) {
  int chars_to_tab;
  int i;
  assert(node->flags & CMARK_NODE__OPEN);
  if (parser->partially_consumed_tab) {
    parser->offset += 1; // skip over tab
    // add space characters:
    chars_to_tab = TAB_STOP - (parser->column % TAB_STOP);
    for (i = 0; i < chars_to_tab; i++) {
      cmark_strbuf_putc(&node->content, ' ');
    }
  }
  cmark_strbuf_put(&node->content, ch->data + parser->offset,
                   ch->len - parser->offset);
}

static void remove_trailing_blank_lines(cmark_strbuf *ln) {
  bufsize_t i;
  unsigned char c;

  for (i = ln->size - 1; i >= 0; --i) {
    c = ln->ptr[i];

    if (c != ' ' && c != '\t' && !S_is_line_end_char(c))
      break;
  }

  if (i < 0) {
    cmark_strbuf_clear(ln);
    return;
  }

  for (; i < ln->size; ++i) {
    c = ln->ptr[i];

    if (!S_is_line_end_char(c))
      continue;

    cmark_strbuf_truncate(ln, i);
    break;
  }
}

// Check to see if a node ends with a blank line, descending
// if needed into lists and sublists.
static bool ends_with_blank_line(cmark_node *node) {
  cmark_node *cur = node;
  while (cur != NULL) {
    if (S_last_line_blank(cur)) {
      return true;
    }
    if (S_type(cur) == CMARK_NODE_LIST || S_type(cur) == CMARK_NODE_ITEM) {
      cur = cur->last_child;
    } else {
      cur = NULL;
    }
  }
  return false;
}

static cmark_node *finalize(cmark_parser *parser, cmark_node *b) {
  bufsize_t pos;
  cmark_node *item;
  cmark_node *subitem;
  cmark_node *parent;

  parent = b->parent;
  assert(b->flags &
         CMARK_NODE__OPEN); // shouldn't call finalize on closed blocks
  b->flags &= ~CMARK_NODE__OPEN;

  if (parser->curline.size == 0) {
    // end of input - line number has not been incremented
    b->end_line = parser->line_number;
    b->end_column = parser->last_line_length;
  } else if (S_type(b) == CMARK_NODE_DOCUMENT ||
             (S_type(b) == CMARK_NODE_CODE_BLOCK && b->as.code.fenced) ||
             (S_type(b) == CMARK_NODE_HEADING && b->as.heading.setext)) {
    b->end_line = parser->line_number;
    b->end_column = parser->curline.size;
    if (b->end_column && parser->curline.ptr[b->end_column - 1] == '\n')
      b->end_column -= 1;
    if (b->end_column && parser->curline.ptr[b->end_column - 1] == '\r')
      b->end_column -= 1;
  } else {
    b->end_line = parser->line_number - 1;
    b->end_column = parser->last_line_length;
  }

  cmark_strbuf *node_content = &b->content;

  switch (S_type(b)) {
  case CMARK_NODE_PARAGRAPH:
    while (cmark_strbuf_at(node_content, 0) == '[' &&
           (pos = cmark_parse_reference_inline(parser->mem, node_content,
                                               parser->refmap))) {

      cmark_strbuf_drop(node_content, pos);
    }
    if (is_blank(node_content, 0)) {
      // remove blank node (former reference def)
      cmark_node_free(b);
    }
    break;

  case CMARK_NODE_CODE_BLOCK:
    if (!b->as.code.fenced) { // indented code
      remove_trailing_blank_lines(node_content);
      cmark_strbuf_putc(node_content, '\n');
    } else {
      // first line of contents becomes info
      for (pos = 0; pos < node_content->size; ++pos) {
        if (S_is_line_end_char(node_content->ptr[pos]))
          break;
      }
      assert(pos < node_content->size);

      cmark_strbuf tmp = CMARK_BUF_INIT(parser->mem);
      houdini_unescape_html_f(&tmp, node_content->ptr, pos);
      cmark_strbuf_trim(&tmp);
      cmark_strbuf_unescape(&tmp);
      b->as.code.info = cmark_chunk_buf_detach(&tmp);

      if (node_content->ptr[pos] == '\r')
        pos += 1;
      if (node_content->ptr[pos] == '\n')
        pos += 1;
      cmark_strbuf_drop(node_content, pos);
    }
    b->as.code.literal = cmark_chunk_buf_detach(node_content);
    break;

  case CMARK_NODE_HTML_BLOCK:
    b->as.literal = cmark_chunk_buf_detach(node_content);
    break;

  case CMARK_NODE_LIST:      // determine tight/loose status
    b->as.list.tight = true; // tight by default
    item = b->first_child;

    while (item) {
      // check for non-final non-empty list item ending with blank line:
      if (S_last_line_blank(item) && item->next) {
        b->as.list.tight = false;
        break;
      }
      // recurse into children of list item, to see if there are
      // spaces between them:
      subitem = item->first_child;
      while (subitem) {
        if (ends_with_blank_line(subitem) && (item->next || subitem->next)) {
          b->as.list.tight = false;
          break;
        }
        subitem = subitem->next;
      }
      if (!(b->as.list.tight)) {
        break;
      }
      item = item->next;
    }

    break;

  default:
    break;
  }

  return parent;
}

// Add a node as child of another.  Return pointer to child.
static cmark_node *add_child(cmark_parser *parser, cmark_node *parent,
                             cmark_node_type block_type, int start_column) {
  assert(parent);

  // if 'parent' isn't the kind of node that can accept this child,
  // then back up til we hit a node that can.
  while (!can_contain(S_type(parent), block_type)) {
    parent = finalize(parser, parent);
  }

  cmark_node *child =
      make_block(parser->mem, block_type, parser->line_number, start_column);
  child->parent = parent;

  if (parent->last_child) {
    parent->last_child->next = child;
    child->prev = parent->last_child;
  } else {
    parent->first_child = child;
    child->prev = NULL;
  }
  parent->last_child = child;
  return child;
}

// Walk through node and all children, recursively, parsing
// string content into inline content where appropriate.
static void process_inlines(cmark_mem *mem, cmark_node *root,
                            cmark_reference_map *refmap, int options) {
  cmark_iter *iter = cmark_iter_new(root);
  cmark_node *cur;
  cmark_event_type ev_type;

  while ((ev_type = cmark_iter_next(iter)) != CMARK_EVENT_DONE) {
    cur = cmark_iter_get_node(iter);
    if (ev_type == CMARK_EVENT_ENTER) {
      if (contains_inlines(S_type(cur))) {
        cmark_parse_inlines(mem, cur, refmap, options);
      }
    }
  }

  cmark_iter_free(iter);
}

// Attempts to parse a list item marker (bullet or enumerated).
// On success, returns length of the marker, and populates
// data with the details.  On failure, returns 0.
static bufsize_t parse_list_marker(cmark_mem *mem, cmark_chunk *input,
                                   bufsize_t pos, bool interrupts_paragraph,
                                   cmark_list **dataptr) {
  unsigned char c;
  bufsize_t startpos;
  cmark_list *data;
  bufsize_t i;

  startpos = pos;
  c = peek_at(input, pos);

  if (c == '*' || c == '-' || c == '+') {
    pos++;
    if (!cmark_isspace(peek_at(input, pos))) {
      return 0;
    }

    if (interrupts_paragraph) {
      i = pos;
      // require non-blank content after list marker:
      while (S_is_space_or_tab(peek_at(input, i))) {
        i++;
      }
      if (peek_at(input, i) == '\n') {
        return 0;
      }
    }

    data = (cmark_list *)mem->calloc(1, sizeof(*data));
    data->marker_offset = 0; // will be adjusted later
    data->list_type = CMARK_BULLET_LIST;
    data->bullet_char = c;
    data->start = 1;
    data->delimiter = CMARK_PERIOD_DELIM;
    data->tight = false;
  } else if (cmark_isdigit(c)) {
    int start = 0;
    int digits = 0;

    do {
      start = (10 * start) + (peek_at(input, pos) - '0');
      pos++;
      digits++;
      // We limit to 9 digits to avoid overflow,
      // assuming max int is 2^31 - 1
      // This also seems to be the limit for 'start' in some browsers.
    } while (digits < 9 && cmark_isdigit(peek_at(input, pos)));

    if (interrupts_paragraph && start != 1) {
      return 0;
    }
    c = peek_at(input, pos);
    if (c == '.' || c == ')') {
      pos++;
      if (!cmark_isspace(peek_at(input, pos))) {
        return 0;
      }
      if (interrupts_paragraph) {
        // require non-blank content after list marker:
        i = pos;
        while (S_is_space_or_tab(peek_at(input, i))) {
          i++;
        }
        if (S_is_line_end_char(peek_at(input, i))) {
          return 0;
        }
      }

      data = (cmark_list *)mem->calloc(1, sizeof(*data));
      data->marker_offset = 0; // will be adjusted later
      data->list_type = CMARK_ORDERED_LIST;
      data->bullet_char = 0;
      data->start = start;
      data->delimiter = (c == '.' ? CMARK_PERIOD_DELIM : CMARK_PAREN_DELIM);
      data->tight = false;
    } else {
      return 0;
    }
  } else {
    return 0;
  }

  *dataptr = data;
  return (pos - startpos);
}

// Return 1 if list item belongs in list, else 0.
static int lists_match(cmark_list *list_data, cmark_list *item_data) {
  return (list_data->list_type == item_data->list_type &&
          list_data->delimiter == item_data->delimiter &&
          // list_data->marker_offset == item_data.marker_offset &&
          list_data->bullet_char == item_data->bullet_char);
}

static cmark_node *finalize_document(cmark_parser *parser) {
  while (parser->current != parser->root) {
    parser->current = finalize(parser, parser->current);
  }

  finalize(parser, parser->root);
  process_inlines(parser->mem, parser->root, parser->refmap, parser->options);

  return parser->root;
}

cmark_node *cmark_parse_file(FILE *f, int options) {
  unsigned char buffer[4096];
  cmark_parser *parser = cmark_parser_new(options);
  size_t bytes;
  cmark_node *document;

  while ((bytes = fread(buffer, 1, sizeof(buffer), f)) > 0) {
    bool eof = bytes < sizeof(buffer);
    S_parser_feed(parser, buffer, bytes, eof);
    if (eof) {
      break;
    }
  }

  document = cmark_parser_finish(parser);
  cmark_parser_free(parser);
  return document;
}

cmark_node *cmark_parse_document(const char *buffer, size_t len, int options) {
  cmark_parser *parser = cmark_parser_new(options);
  cmark_node *document;

  S_parser_feed(parser, (const unsigned char *)buffer, len, true);

  document = cmark_parser_finish(parser);
  cmark_parser_free(parser);
  return document;
}

void cmark_parser_feed(cmark_parser *parser, const char *buffer, size_t len) {
  S_parser_feed(parser, (const unsigned char *)buffer, len, false);
}

static void S_parser_feed(cmark_parser *parser, const unsigned char *buffer,
                          size_t len, bool eof) {
  const unsigned char *end = buffer + len;
  static const uint8_t repl[] = {239, 191, 189};

  if (parser->last_buffer_ended_with_cr && *buffer == '\n') {
    // skip NL if last buffer ended with CR ; see #117
    buffer++;
  }
  parser->last_buffer_ended_with_cr = false;
  while (buffer < end) {
    const unsigned char *eol;
    bufsize_t chunk_len;
    bool process = false;
    for (eol = buffer; eol < end; ++eol) {
      if (S_is_line_end_char(*eol)) {
        process = true;
        break;
      }
      if (*eol == '\0' && eol < end) {
        break;
      }
    }
    if (eol >= end && eof) {
      process = true;
    }

    chunk_len = (eol - buffer);
    if (process) {
      if (parser->linebuf.size > 0) {
        cmark_strbuf_put(&parser->linebuf, buffer, chunk_len);
        S_process_line(parser, parser->linebuf.ptr, parser->linebuf.size);
        cmark_strbuf_clear(&parser->linebuf);
      } else {
        S_process_line(parser, buffer, chunk_len);
      }
    } else {
      if (eol < end && *eol == '\0') {
        // omit NULL byte
        cmark_strbuf_put(&parser->linebuf, buffer, chunk_len);
        // add replacement character
        cmark_strbuf_put(&parser->linebuf, repl, 3);
      } else {
        cmark_strbuf_put(&parser->linebuf, buffer, chunk_len);
      }
    }

    buffer += chunk_len;
    if (buffer < end) {
      if (*buffer == '\0') {
        // skip over NULL
        buffer++;
      } else {
        // skip over line ending characters
        if (*buffer == '\r') {
          buffer++;
          if (buffer == end)
            parser->last_buffer_ended_with_cr = true;
        }
        if (buffer < end && *buffer == '\n')
          buffer++;
      }
    }
  }
}

static void chop_trailing_hashtags(cmark_chunk *ch) {
  bufsize_t n, orig_n;

  cmark_chunk_rtrim(ch);
  orig_n = n = ch->len - 1;

  // if string ends in space followed by #s, remove these:
  while (n >= 0 && peek_at(ch, n) == '#')
    n--;

  // Check for a space before the final #s:
  if (n != orig_n && n >= 0 && S_is_space_or_tab(peek_at(ch, n))) {
    ch->len = n;
    cmark_chunk_rtrim(ch);
  }
}

// Find first nonspace character from current offset, setting
// parser->first_nonspace, parser->first_nonspace_column,
// parser->indent, and parser->blank. Does not advance parser->offset.
static void S_find_first_nonspace(cmark_parser *parser, cmark_chunk *input) {
  char c;
  int chars_to_tab = TAB_STOP - (parser->column % TAB_STOP);

  parser->first_nonspace = parser->offset;
  parser->first_nonspace_column = parser->column;
  while ((c = peek_at(input, parser->first_nonspace))) {
    if (c == ' ') {
      parser->first_nonspace += 1;
      parser->first_nonspace_column += 1;
      chars_to_tab = chars_to_tab - 1;
      if (chars_to_tab == 0) {
        chars_to_tab = TAB_STOP;
      }
    } else if (c == '\t') {
      parser->first_nonspace += 1;
      parser->first_nonspace_column += chars_to_tab;
      chars_to_tab = TAB_STOP;
    } else {
      break;
    }
  }

  parser->indent = parser->first_nonspace_column - parser->column;
  parser->blank = S_is_line_end_char(peek_at(input, parser->first_nonspace));
}

// Advance parser->offset and parser->column.  parser->offset is the
// byte position in input; parser->column is a virtual column number
// that takes into account tabs. (Multibyte characters are not taken
// into account, because the Markdown line prefixes we are interested in
// analyzing are entirely ASCII.)  The count parameter indicates
// how far to advance the offset.  If columns is true, then count
// indicates a number of columns; otherwise, a number of bytes.
// If advancing a certain number of columns partially consumes
// a tab character, parser->partially_consumed_tab is set to true.
static void S_advance_offset(cmark_parser *parser, cmark_chunk *input,
                             bufsize_t count, bool columns) {
  char c;
  int chars_to_tab;
  int chars_to_advance;
  while (count > 0 && (c = peek_at(input, parser->offset))) {
    if (c == '\t') {
      chars_to_tab = TAB_STOP - (parser->column % TAB_STOP);
      if (columns) {
        parser->partially_consumed_tab = chars_to_tab > count;
        chars_to_advance = MIN(count, chars_to_tab);
        parser->column += chars_to_advance;
        parser->offset += (parser->partially_consumed_tab ? 0 : 1);
        count -= chars_to_advance;
      } else {
        parser->partially_consumed_tab = false;
        parser->column += chars_to_tab;
        parser->offset += 1;
        count -= 1;
      }
    } else {
      parser->partially_consumed_tab = false;
      parser->offset += 1;
      parser->column += 1; // assume ascii; block starts are ascii
      count -= 1;
    }
  }
}

static bool S_last_child_is_open(cmark_node *container) {
  return container->last_child &&
         (container->last_child->flags & CMARK_NODE__OPEN);
}

static bool parse_block_quote_prefix(cmark_parser *parser, cmark_chunk *input) {
  bool res = false;
  bufsize_t matched = 0;

  matched =
      parser->indent <= 3 && peek_at(input, parser->first_nonspace) == '>';
  if (matched) {

    S_advance_offset(parser, input, parser->indent + 1, true);

    if (S_is_space_or_tab(peek_at(input, parser->offset))) {
      S_advance_offset(parser, input, 1, true);
    }

    res = true;
  }
  return res;
}

static bool parse_node_item_prefix(cmark_parser *parser, cmark_chunk *input,
                                   cmark_node *container) {
  bool res = false;

  if (parser->indent >=
      container->as.list.marker_offset + container->as.list.padding) {
    S_advance_offset(parser, input, container->as.list.marker_offset +
                                        container->as.list.padding,
                     true);
    res = true;
  } else if (parser->blank && container->first_child != NULL) {
    // if container->first_child is NULL, then the opening line
    // of the list item was blank after the list marker; in this
    // case, we are done with the list item.
    S_advance_offset(parser, input, parser->first_nonspace - parser->offset,
                     false);
    res = true;
  }
  return res;
}

static bool parse_code_block_prefix(cmark_parser *parser, cmark_chunk *input,
                                    cmark_node *container,
                                    bool *should_continue) {
  bool res = false;

  if (!container->as.code.fenced) { // indented
    if (parser->indent >= CODE_INDENT) {
      S_advance_offset(parser, input, CODE_INDENT, true);
      res = true;
    } else if (parser->blank) {
      S_advance_offset(parser, input, parser->first_nonspace - parser->offset,
                       false);
      res = true;
    }
  } else { // fenced
    bufsize_t matched = 0;

    if (parser->indent <= 3 && (peek_at(input, parser->first_nonspace) ==
                                container->as.code.fence_char)) {
      matched = scan_close_code_fence(input, parser->first_nonspace);
    }

    if (matched >= container->as.code.fence_length) {
      // closing fence - and since we're at
      // the end of a line, we can stop processing it:
      *should_continue = false;
      S_advance_offset(parser, input, matched, false);
      parser->current = finalize(parser, container);
    } else {
      // skip opt. spaces of fence parser->offset
      int i = container->as.code.fence_offset;

      while (i > 0 && S_is_space_or_tab(peek_at(input, parser->offset))) {
        S_advance_offset(parser, input, 1, true);
        i--;
      }
      res = true;
    }
  }

  return res;
}

static bool parse_html_block_prefix(cmark_parser *parser,
                                    cmark_node *container) {
  bool res = false;
  int html_block_type = container->as.html_block_type;

  assert(html_block_type >= 1 && html_block_type <= 7);
  switch (html_block_type) {
  case 1:
  case 2:
  case 3:
  case 4:
  case 5:
    // these types of blocks can accept blanks
    res = true;
    break;
  case 6:
  case 7:
    res = !parser->blank;
    break;
  }

  return res;
}

/**
 * For each containing node, try to parse the associated line start.
 *
 * Will not close unmatched blocks, as we may have a lazy continuation
 * line -> http://spec.commonmark.org/0.24/#lazy-continuation-line
 *
 * Returns: The last matching node, or NULL
 */
static cmark_node *check_open_blocks(cmark_parser *parser, cmark_chunk *input,
                                     bool *all_matched) {
  bool should_continue = true;
  *all_matched = false;
  cmark_node *container = parser->root;
  cmark_node_type cont_type;

  while (S_last_child_is_open(container)) {
    container = container->last_child;
    cont_type = S_type(container);

    S_find_first_nonspace(parser, input);

    switch (cont_type) {
    case CMARK_NODE_BLOCK_QUOTE:
      if (!parse_block_quote_prefix(parser, input))
        goto done;
      break;
    case CMARK_NODE_ITEM:
      if (!parse_node_item_prefix(parser, input, container))
        goto done;
      break;
    case CMARK_NODE_CODE_BLOCK:
      if (!parse_code_block_prefix(parser, input, container, &should_continue))
        goto done;
      break;
    case CMARK_NODE_HEADING:
      // a heading can never contain more than one line
      goto done;
    case CMARK_NODE_HTML_BLOCK:
      if (!parse_html_block_prefix(parser, container))
        goto done;
      break;
    case CMARK_NODE_PARAGRAPH:
      if (parser->blank)
        goto done;
      break;
    default:
      break;
    }
  }

  *all_matched = true;

done:
  if (!*all_matched) {
    container = container->parent; // back up to last matching node
  }

  if (!should_continue) {
    container = NULL;
  }

  return container;
}

static void open_new_blocks(cmark_parser *parser, cmark_node **container,
                            cmark_chunk *input, bool all_matched) {
  bool indented;
  cmark_list *data = NULL;
  bool maybe_lazy = S_type(parser->current) == CMARK_NODE_PARAGRAPH;
  cmark_node_type cont_type = S_type(*container);
  bufsize_t matched = 0;
  int lev = 0;
  bool save_partially_consumed_tab;
  int save_offset;
  int save_column;

  while (cont_type != CMARK_NODE_CODE_BLOCK &&
         cont_type != CMARK_NODE_HTML_BLOCK) {

    S_find_first_nonspace(parser, input);
    indented = parser->indent >= CODE_INDENT;

    if (!indented && peek_at(input, parser->first_nonspace) == '>') {

      bufsize_t blockquote_startpos = parser->first_nonspace;

      S_advance_offset(parser, input,
                       parser->first_nonspace + 1 - parser->offset, false);
      // optional following character
      if (S_is_space_or_tab(peek_at(input, parser->offset))) {
        S_advance_offset(parser, input, 1, true);
      }
      *container = add_child(parser, *container, CMARK_NODE_BLOCK_QUOTE,
                             blockquote_startpos + 1);

    } else if (!indented && (matched = scan_atx_heading_start(
                                 input, parser->first_nonspace))) {
      bufsize_t hashpos;
      int level = 0;
      bufsize_t heading_startpos = parser->first_nonspace;

      S_advance_offset(parser, input,
                       parser->first_nonspace + matched - parser->offset,
                       false);
      *container = add_child(parser, *container, CMARK_NODE_HEADING,
                             heading_startpos + 1);

      hashpos = cmark_chunk_strchr(input, '#', parser->first_nonspace);

      while (peek_at(input, hashpos) == '#') {
        level++;
        hashpos++;
      }

      (*container)->as.heading.level = level;
      (*container)->as.heading.setext = false;

    } else if (!indented && (matched = scan_open_code_fence(
                                 input, parser->first_nonspace))) {
      *container = add_child(parser, *container, CMARK_NODE_CODE_BLOCK,
                             parser->first_nonspace + 1);
      (*container)->as.code.fenced = true;
      (*container)->as.code.fence_char = peek_at(input, parser->first_nonspace);
      (*container)->as.code.fence_length = (matched > 255) ? 255 : matched;
      (*container)->as.code.fence_offset =
          (int8_t)(parser->first_nonspace - parser->offset);
      (*container)->as.code.info = cmark_chunk_literal("");
      S_advance_offset(parser, input,
                       parser->first_nonspace + matched - parser->offset,
                       false);

    } else if (!indented && ((matched = scan_html_block_start(
                                  input, parser->first_nonspace)) ||
                             (cont_type != CMARK_NODE_PARAGRAPH &&
                              (matched = scan_html_block_start_7(
                                   input, parser->first_nonspace))))) {
      *container = add_child(parser, *container, CMARK_NODE_HTML_BLOCK,
                             parser->first_nonspace + 1);
      (*container)->as.html_block_type = matched;
      // note, we don't adjust parser->offset because the tag is part of the
      // text
    } else if (!indented && cont_type == CMARK_NODE_PARAGRAPH &&
               (lev =
                    scan_setext_heading_line(input, parser->first_nonspace))) {
      (*container)->type = (uint16_t)CMARK_NODE_HEADING;
      (*container)->as.heading.level = lev;
      (*container)->as.heading.setext = true;
      S_advance_offset(parser, input, input->len - 1 - parser->offset, false);
    } else if (!indented &&
               !(cont_type == CMARK_NODE_PARAGRAPH && !all_matched) &&
               (matched = scan_thematic_break(input, parser->first_nonspace))) {
      // it's only now that we know the line is not part of a setext heading:
      *container = add_child(parser, *container, CMARK_NODE_THEMATIC_BREAK,
                             parser->first_nonspace + 1);
      S_advance_offset(parser, input, input->len - 1 - parser->offset, false);
    } else if ((!indented || cont_type == CMARK_NODE_LIST) &&
               (matched = parse_list_marker(
                    parser->mem, input, parser->first_nonspace,
                    (*container)->type == CMARK_NODE_PARAGRAPH, &data))) {

      // Note that we can have new list items starting with >= 4
      // spaces indent, as long as the list container is still open.
      int i = 0;

      // compute padding:
      S_advance_offset(parser, input,
                       parser->first_nonspace + matched - parser->offset,
                       false);

      save_partially_consumed_tab = parser->partially_consumed_tab;
      save_offset = parser->offset;
      save_column = parser->column;

      while (parser->column - save_column <= 5 &&
             S_is_space_or_tab(peek_at(input, parser->offset))) {
        S_advance_offset(parser, input, 1, true);
      }

      i = parser->column - save_column;
      if (i >= 5 || i < 1 ||
          // only spaces after list marker:
          S_is_line_end_char(peek_at(input, parser->offset))) {
        data->padding = matched + 1;
        parser->offset = save_offset;
        parser->column = save_column;
        parser->partially_consumed_tab = save_partially_consumed_tab;
        if (i > 0) {
          S_advance_offset(parser, input, 1, true);
        }
      } else {
        data->padding = matched + i;
      }

      // check container; if it's a list, see if this list item
      // can continue the list; otherwise, create a list container.

      data->marker_offset = parser->indent;

      if (cont_type != CMARK_NODE_LIST ||
          !lists_match(&((*container)->as.list), data)) {
        *container = add_child(parser, *container, CMARK_NODE_LIST,
                               parser->first_nonspace + 1);

        memcpy(&((*container)->as.list), data, sizeof(*data));
      }

      // add the list item
      *container = add_child(parser, *container, CMARK_NODE_ITEM,
                             parser->first_nonspace + 1);
      /* TODO: static */
      memcpy(&((*container)->as.list), data, sizeof(*data));
      parser->mem->free(data);
    } else if (indented && !maybe_lazy && !parser->blank) {
      S_advance_offset(parser, input, CODE_INDENT, true);
      *container = add_child(parser, *container, CMARK_NODE_CODE_BLOCK,
                             parser->offset + 1);
      (*container)->as.code.fenced = false;
      (*container)->as.code.fence_char = 0;
      (*container)->as.code.fence_length = 0;
      (*container)->as.code.fence_offset = 0;
      (*container)->as.code.info = cmark_chunk_literal("");

    } else {
      break;
    }

    if (accepts_lines(S_type(*container))) {
      // if it's a line container, it can't contain other containers
      break;
    }

    cont_type = S_type(*container);
    maybe_lazy = false;
  }
}

static void add_text_to_container(cmark_parser *parser, cmark_node *container,
                                  cmark_node *last_matched_container,
                                  cmark_chunk *input) {
  cmark_node *tmp;
  // what remains at parser->offset is a text line.  add the text to the
  // appropriate container.

  S_find_first_nonspace(parser, input);

  if (parser->blank && container->last_child)
    S_set_last_line_blank(container->last_child, true);

  // block quote lines are never blank as they start with >
  // and we don't count blanks in fenced code for purposes of tight/loose
  // lists or breaking out of lists.  we also don't set last_line_blank
  // on an empty list item.
  const cmark_node_type ctype = S_type(container);
  const bool last_line_blank =
      (parser->blank && ctype != CMARK_NODE_BLOCK_QUOTE &&
       ctype != CMARK_NODE_HEADING && ctype != CMARK_NODE_THEMATIC_BREAK &&
       !(ctype == CMARK_NODE_CODE_BLOCK && container->as.code.fenced) &&
       !(ctype == CMARK_NODE_ITEM && container->first_child == NULL &&
         container->start_line == parser->line_number));

  S_set_last_line_blank(container, last_line_blank);

  tmp = container;
  while (tmp->parent) {
    S_set_last_line_blank(tmp->parent, false);
    tmp = tmp->parent;
  }

  // If the last line processed belonged to a paragraph node,
  // and we didn't match all of the line prefixes for the open containers,
  // and we didn't start any new containers,
  // and the line isn't blank,
  // then treat this as a "lazy continuation line" and add it to
  // the open paragraph.
  if (parser->current != last_matched_container &&
      container == last_matched_container && !parser->blank &&
      S_type(parser->current) == CMARK_NODE_PARAGRAPH) {
    add_line(parser->current, input, parser);
  } else { // not a lazy continuation
    // Finalize any blocks that were not matched and set cur to container:
    while (parser->current != last_matched_container) {
      parser->current = finalize(parser, parser->current);
      assert(parser->current != NULL);
    }

    if (S_type(container) == CMARK_NODE_CODE_BLOCK) {
      add_line(container, input, parser);
    } else if (S_type(container) == CMARK_NODE_HTML_BLOCK) {
      add_line(container, input, parser);

      int matches_end_condition;
      switch (container->as.html_block_type) {
      case 1:
        // </script>, </style>, </pre>
        matches_end_condition =
            scan_html_block_end_1(input, parser->first_nonspace);
        break;
      case 2:
        // -->
        matches_end_condition =
            scan_html_block_end_2(input, parser->first_nonspace);
        break;
      case 3:
        // ?>
        matches_end_condition =
            scan_html_block_end_3(input, parser->first_nonspace);
        break;
      case 4:
        // >
        matches_end_condition =
            scan_html_block_end_4(input, parser->first_nonspace);
        break;
      case 5:
        // ]]>
        matches_end_condition =
            scan_html_block_end_5(input, parser->first_nonspace);
        break;
      default:
        matches_end_condition = 0;
        break;
      }

      if (matches_end_condition) {
        container = finalize(parser, container);
        assert(parser->current != NULL);
      }
    } else if (parser->blank) {
      // ??? do nothing
    } else if (accepts_lines(S_type(container))) {
      if (S_type(container) == CMARK_NODE_HEADING &&
          container->as.heading.setext == false) {
        chop_trailing_hashtags(input);
      }
      S_advance_offset(parser, input, parser->first_nonspace - parser->offset,
                       false);
      add_line(container, input, parser);
    } else {
      // create paragraph container for line
      container = add_child(parser, container, CMARK_NODE_PARAGRAPH,
                            parser->first_nonspace + 1);
      S_advance_offset(parser, input, parser->first_nonspace - parser->offset,
                       false);
      add_line(container, input, parser);
    }

    parser->current = container;
  }
}

/* See http://spec.commonmark.org/0.24/#phase-1-block-structure */
static void S_process_line(cmark_parser *parser, const unsigned char *buffer,
                           bufsize_t bytes) {
  cmark_node *last_matched_container;
  bool all_matched = true;
  cmark_node *container;
  cmark_chunk input;

  if (parser->options & CMARK_OPT_VALIDATE_UTF8)
    cmark_utf8proc_check(&parser->curline, buffer, bytes);
  else
    cmark_strbuf_put(&parser->curline, buffer, bytes);

  // ensure line ends with a newline:
  if (bytes == 0 || !S_is_line_end_char(parser->curline.ptr[bytes - 1]))
    cmark_strbuf_putc(&parser->curline, '\n');

  parser->offset = 0;
  parser->column = 0;
  parser->blank = false;
  parser->partially_consumed_tab = false;

  input.data = parser->curline.ptr;
  input.len = parser->curline.size;
  input.alloc = 0;

  parser->line_number++;

  last_matched_container = check_open_blocks(parser, &input, &all_matched);

  if (!last_matched_container)
    goto finished;

  container = last_matched_container;

  open_new_blocks(parser, &container, &input, all_matched);

  add_text_to_container(parser, container, last_matched_container, &input);

finished:
  parser->last_line_length = input.len;
  if (parser->last_line_length &&
      input.data[parser->last_line_length - 1] == '\n')
    parser->last_line_length -= 1;
  if (parser->last_line_length &&
      input.data[parser->last_line_length - 1] == '\r')
    parser->last_line_length -= 1;

  cmark_strbuf_clear(&parser->curline);
}

cmark_node *cmark_parser_finish(cmark_parser *parser) {
  if (parser->linebuf.size) {
    S_process_line(parser, parser->linebuf.ptr, parser->linebuf.size);
    cmark_strbuf_clear(&parser->linebuf);
  }

  finalize_document(parser);

  if (parser->options & CMARK_OPT_NORMALIZE) {
    cmark_consolidate_text_nodes(parser->root);
  }

  cmark_strbuf_free(&parser->curline);

#if CMARK_DEBUG_NODES
  if (cmark_node_check(parser->root, stderr)) {
    abort();
  }
#endif
  return parser->root;
}



const char *cmark_version_string() { return CMARK_VERSION_STRING; }

static void *xcalloc(size_t nmem, size_t size) {
  void *ptr = calloc(nmem, size);
  if (!ptr)
    abort();
  return ptr;
}

static void *xrealloc(void *ptr, size_t size) {
  void *new_ptr = realloc(ptr, size);
  if (!new_ptr)
    abort();
  return new_ptr;
}

cmark_mem DEFAULT_MEM_ALLOCATOR = {xcalloc, xrealloc, free};

char *cmark_markdown_to_html(const char *text, size_t len, int options) {
  cmark_node *doc;
  char *result;

  doc = cmark_parse_document(text, len, options);

  result = cmark_render_html(doc, options);
  cmark_node_free(doc);

  return result;
}



/** 1 = space, 2 = punct, 3 = digit, 4 = alpha, 0 = other
 */
static const uint8_t cmark_ctype_class[256] = {
    /*      0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f */
    /* 0 */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0,
    /* 1 */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    /* 2 */ 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
    /* 3 */ 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2,
    /* 4 */ 2, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
    /* 5 */ 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 2,
    /* 6 */ 2, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
    /* 7 */ 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 2, 2, 2, 2, 0,
    /* 8 */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    /* 9 */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    /* a */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    /* b */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    /* c */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    /* d */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    /* e */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    /* f */ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

/**
 * Returns 1 if c is a "whitespace" character as defined by the spec.
 */
int cmark_isspace(char c) { return cmark_ctype_class[(uint8_t)c] == 1; }

/**
 * Returns 1 if c is an ascii punctuation character.
 */
int cmark_ispunct(char c) { return cmark_ctype_class[(uint8_t)c] == 2; }

int cmark_isalnum(char c) {
  uint8_t result;
  result = cmark_ctype_class[(uint8_t)c];
  return (result == 3 || result == 4);
}

int cmark_isdigit(char c) { return cmark_ctype_class[(uint8_t)c] == 3; }

int cmark_isalpha(char c) { return cmark_ctype_class[(uint8_t)c] == 4; }



#include <stdarg.h>
#include <string.h>
#include <assert.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <limits.h>


/* Used as default value for cmark_strbuf->ptr so that people can always
 * assume ptr is non-NULL and zero terminated even for new cmark_strbufs.
 */
unsigned char cmark_strbuf__initbuf[1];

#ifndef MIN
#define MIN(x, y) ((x < y) ? x : y)
#endif

void cmark_strbuf_init(cmark_mem *mem, cmark_strbuf *buf,
                       bufsize_t initial_size) {
  buf->mem = mem;
  buf->asize = 0;
  buf->size = 0;
  buf->ptr = cmark_strbuf__initbuf;

  if (initial_size > 0)
    cmark_strbuf_grow(buf, initial_size);
}

static CMARK_INLINE void S_strbuf_grow_by(cmark_strbuf *buf, bufsize_t add) {
  cmark_strbuf_grow(buf, buf->size + add);
}

void cmark_strbuf_grow(cmark_strbuf *buf, bufsize_t target_size) {
  assert(target_size > 0);

  if (target_size < buf->asize)
    return;

  if (target_size > (bufsize_t)(INT32_MAX / 2))
    abort();

  /* Oversize the buffer by 50% to guarantee amortized linear time
   * complexity on append operations. */
  bufsize_t new_size = target_size + target_size / 2;
  new_size += 1;
  new_size = (new_size + 7) & ~7;

  buf->ptr = (unsigned char *)buf->mem->realloc(buf->asize ? buf->ptr : NULL,
                                                new_size);
  buf->asize = new_size;
}

bufsize_t cmark_strbuf_len(const cmark_strbuf *buf) { return buf->size; }

void cmark_strbuf_free(cmark_strbuf *buf) {
  if (!buf)
    return;

  if (buf->ptr != cmark_strbuf__initbuf)
    buf->mem->free(buf->ptr);

  cmark_strbuf_init(buf->mem, buf, 0);
}

void cmark_strbuf_clear(cmark_strbuf *buf) {
  buf->size = 0;

  if (buf->asize > 0)
    buf->ptr[0] = '\0';
}

void cmark_strbuf_set(cmark_strbuf *buf, const unsigned char *data,
                      bufsize_t len) {
  if (len <= 0 || data == NULL) {
    cmark_strbuf_clear(buf);
  } else {
    if (data != buf->ptr) {
      if (len >= buf->asize)
        cmark_strbuf_grow(buf, len);
      memmove(buf->ptr, data, len);
    }
    buf->size = len;
    buf->ptr[buf->size] = '\0';
  }
}

void cmark_strbuf_sets(cmark_strbuf *buf, const char *string) {
  cmark_strbuf_set(buf, (const unsigned char *)string,
                   string ? strlen(string) : 0);
}

void cmark_strbuf_putc(cmark_strbuf *buf, int c) {
  S_strbuf_grow_by(buf, 1);
  buf->ptr[buf->size++] = (unsigned char)(c & 0xFF);
  buf->ptr[buf->size] = '\0';
}

void cmark_strbuf_put(cmark_strbuf *buf, const unsigned char *data,
                      bufsize_t len) {
  if (len <= 0)
    return;

  S_strbuf_grow_by(buf, len);
  memmove(buf->ptr + buf->size, data, len);
  buf->size += len;
  buf->ptr[buf->size] = '\0';
}

void cmark_strbuf_puts(cmark_strbuf *buf, const char *string) {
  cmark_strbuf_put(buf, (const unsigned char *)string, strlen(string));
}

void cmark_strbuf_copy_cstr(char *data, bufsize_t datasize,
                            const cmark_strbuf *buf) {
  bufsize_t copylen;

  assert(buf);
  if (!data || datasize <= 0)
    return;

  data[0] = '\0';

  if (buf->size == 0 || buf->asize <= 0)
    return;

  copylen = buf->size;
  if (copylen > datasize - 1)
    copylen = datasize - 1;
  memmove(data, buf->ptr, copylen);
  data[copylen] = '\0';
}

void cmark_strbuf_swap(cmark_strbuf *buf_a, cmark_strbuf *buf_b) {
  cmark_strbuf t = *buf_a;
  *buf_a = *buf_b;
  *buf_b = t;
}

unsigned char *cmark_strbuf_detach(cmark_strbuf *buf) {
  unsigned char *data = buf->ptr;

  if (buf->asize == 0) {
    /* return an empty string */
    return (unsigned char *)buf->mem->calloc(1, 1);
  }

  cmark_strbuf_init(buf->mem, buf, 0);
  return data;
}

int cmark_strbuf_cmp(const cmark_strbuf *a, const cmark_strbuf *b) {
  int result = memcmp(a->ptr, b->ptr, MIN(a->size, b->size));
  return (result != 0) ? result
                       : (a->size < b->size) ? -1 : (a->size > b->size) ? 1 : 0;
}

bufsize_t cmark_strbuf_strchr(const cmark_strbuf *buf, int c, bufsize_t pos) {
  if (pos >= buf->size)
    return -1;
  if (pos < 0)
    pos = 0;

  const unsigned char *p =
      (unsigned char *)memchr(buf->ptr + pos, c, buf->size - pos);
  if (!p)
    return -1;

  return (bufsize_t)(p - (const unsigned char *)buf->ptr);
}

bufsize_t cmark_strbuf_strrchr(const cmark_strbuf *buf, int c, bufsize_t pos) {
  if (pos < 0 || buf->size == 0)
    return -1;
  if (pos >= buf->size)
    pos = buf->size - 1;

  bufsize_t i;
  for (i = pos; i >= 0; i--) {
    if (buf->ptr[i] == (unsigned char)c)
      return i;
  }

  return -1;
}

void cmark_strbuf_truncate(cmark_strbuf *buf, bufsize_t len) {
  if (len < 0)
    len = 0;

  if (len < buf->size) {
    buf->size = len;
    buf->ptr[buf->size] = '\0';
  }
}

void cmark_strbuf_drop(cmark_strbuf *buf, bufsize_t n) {
  if (n > 0) {
    if (n > buf->size)
      n = buf->size;
    buf->size = buf->size - n;
    if (buf->size)
      memmove(buf->ptr, buf->ptr + n, buf->size);

    buf->ptr[buf->size] = '\0';
  }
}

void cmark_strbuf_rtrim(cmark_strbuf *buf) {
  if (!buf->size)
    return;

  while (buf->size > 0) {
    if (!cmark_isspace(buf->ptr[buf->size - 1]))
      break;

    buf->size--;
  }

  buf->ptr[buf->size] = '\0';
}

void cmark_strbuf_trim(cmark_strbuf *buf) {
  bufsize_t i = 0;

  if (!buf->size)
    return;

  while (i < buf->size && cmark_isspace(buf->ptr[i]))
    i++;

  cmark_strbuf_drop(buf, i);

  cmark_strbuf_rtrim(buf);
}

// Destructively modify string, collapsing consecutive
// space and newline characters into a single space.
void cmark_strbuf_normalize_whitespace(cmark_strbuf *s) {
  bool last_char_was_space = false;
  bufsize_t r, w;

  for (r = 0, w = 0; r < s->size; ++r) {
    if (cmark_isspace(s->ptr[r])) {
      if (!last_char_was_space) {
        s->ptr[w++] = ' ';
        last_char_was_space = true;
      }
    } else {
      s->ptr[w++] = s->ptr[r];
      last_char_was_space = false;
    }
  }

  cmark_strbuf_truncate(s, w);
}

// Destructively unescape a string: remove backslashes before punctuation chars.
extern void cmark_strbuf_unescape(cmark_strbuf *buf) {
  bufsize_t r, w;

  for (r = 0, w = 0; r < buf->size; ++r) {
    if (buf->ptr[r] == '\\' && cmark_ispunct(buf->ptr[r + 1]))
      r++;

    buf->ptr[w++] = buf->ptr[r];
  }

  cmark_strbuf_truncate(buf, w);
}


static void S_node_unlink(cmark_node *node);

#define NODE_MEM(node) cmark_node_mem(node)

static CMARK_INLINE bool S_is_block(cmark_node *node) {
  if (node == NULL) {
    return false;
  }
  return node->type >= CMARK_NODE_FIRST_BLOCK &&
         node->type <= CMARK_NODE_LAST_BLOCK;
}

static CMARK_INLINE bool S_is_inline(cmark_node *node) {
  if (node == NULL) {
    return false;
  }
  return node->type >= CMARK_NODE_FIRST_INLINE &&
         node->type <= CMARK_NODE_LAST_INLINE;
}

static bool S_can_contain(cmark_node *node, cmark_node *child) {
  cmark_node *cur;

  if (node == NULL || child == NULL) {
    return false;
  }

  // Verify that child is not an ancestor of node or equal to node.
  cur = node;
  do {
    if (cur == child) {
      return false;
    }
    cur = cur->parent;
  } while (cur != NULL);

  if (child->type == CMARK_NODE_DOCUMENT) {
    return false;
  }

  switch (node->type) {
  case CMARK_NODE_DOCUMENT:
  case CMARK_NODE_BLOCK_QUOTE:
  case CMARK_NODE_ITEM:
    return S_is_block(child) && child->type != CMARK_NODE_ITEM;

  case CMARK_NODE_LIST:
    return child->type == CMARK_NODE_ITEM;

  case CMARK_NODE_CUSTOM_BLOCK:
    return true;

  case CMARK_NODE_PARAGRAPH:
  case CMARK_NODE_HEADING:
  case CMARK_NODE_EMPH:
  case CMARK_NODE_STRONG:
  case CMARK_NODE_LINK:
  case CMARK_NODE_IMAGE:
  case CMARK_NODE_CUSTOM_INLINE:
    return S_is_inline(child);

  default:
    break;
  }

  return false;
}

cmark_node *cmark_node_new_with_mem(cmark_node_type type, cmark_mem *mem) {
  cmark_node *node = (cmark_node *)mem->calloc(1, sizeof(*node));
  cmark_strbuf_init(mem, &node->content, 0);
  node->type = (uint16_t)type;

  switch (node->type) {
  case CMARK_NODE_HEADING:
    node->as.heading.level = 1;
    break;

  case CMARK_NODE_LIST: {
    cmark_list *list = &node->as.list;
    list->list_type = CMARK_BULLET_LIST;
    list->start = 1;
    list->tight = false;
    break;
  }

  default:
    break;
  }

  return node;
}

cmark_node *cmark_node_new(cmark_node_type type) {
  extern cmark_mem DEFAULT_MEM_ALLOCATOR;
  return cmark_node_new_with_mem(type, &DEFAULT_MEM_ALLOCATOR);
}

// Free a cmark_node list and any children.
static void S_free_nodes(cmark_node *e) {
  cmark_node *next;
  while (e != NULL) {
    cmark_strbuf_free(&e->content);
    switch (e->type) {
    case CMARK_NODE_CODE_BLOCK:
      cmark_chunk_free(NODE_MEM(e), &e->as.code.info);
      cmark_chunk_free(NODE_MEM(e), &e->as.code.literal);
      break;
    case CMARK_NODE_TEXT:
    case CMARK_NODE_HTML_INLINE:
    case CMARK_NODE_CODE:
    case CMARK_NODE_HTML_BLOCK:
      cmark_chunk_free(NODE_MEM(e), &e->as.literal);
      break;
    case CMARK_NODE_LINK:
    case CMARK_NODE_IMAGE:
      cmark_chunk_free(NODE_MEM(e), &e->as.link.url);
      cmark_chunk_free(NODE_MEM(e), &e->as.link.title);
      break;
    case CMARK_NODE_CUSTOM_BLOCK:
    case CMARK_NODE_CUSTOM_INLINE:
      cmark_chunk_free(NODE_MEM(e), &e->as.custom.on_enter);
      cmark_chunk_free(NODE_MEM(e), &e->as.custom.on_exit);
      break;
    default:
      break;
    }
    if (e->last_child) {
      // Splice children into list
      e->last_child->next = e->next;
      e->next = e->first_child;
    }
    next = e->next;
    NODE_MEM(e)->free(e);
    e = next;
  }
}

void cmark_node_free(cmark_node *node) {
  S_node_unlink(node);
  node->next = NULL;
  S_free_nodes(node);
}

cmark_node_type cmark_node_get_type(cmark_node *node) {
  if (node == NULL) {
    return CMARK_NODE_NONE;
  } else {
    return (cmark_node_type)node->type;
  }
}

const char *cmark_node_get_type_string(cmark_node *node) {
  if (node == NULL) {
    return "NONE";
  }

  switch (node->type) {
  case CMARK_NODE_NONE:
    return "none";
  case CMARK_NODE_DOCUMENT:
    return "document";
  case CMARK_NODE_BLOCK_QUOTE:
    return "block_quote";
  case CMARK_NODE_LIST:
    return "list";
  case CMARK_NODE_ITEM:
    return "item";
  case CMARK_NODE_CODE_BLOCK:
    return "code_block";
  case CMARK_NODE_HTML_BLOCK:
    return "html_block";
  case CMARK_NODE_CUSTOM_BLOCK:
    return "custom_block";
  case CMARK_NODE_PARAGRAPH:
    return "paragraph";
  case CMARK_NODE_HEADING:
    return "heading";
  case CMARK_NODE_THEMATIC_BREAK:
    return "thematic_break";
  case CMARK_NODE_TEXT:
    return "text";
  case CMARK_NODE_SOFTBREAK:
    return "softbreak";
  case CMARK_NODE_LINEBREAK:
    return "linebreak";
  case CMARK_NODE_CODE:
    return "code";
  case CMARK_NODE_HTML_INLINE:
    return "html_inline";
  case CMARK_NODE_CUSTOM_INLINE:
    return "custom_inline";
  case CMARK_NODE_EMPH:
    return "emph";
  case CMARK_NODE_STRONG:
    return "strong";
  case CMARK_NODE_LINK:
    return "link";
  case CMARK_NODE_IMAGE:
    return "image";
  }

  return "<unknown>";
}

cmark_node *cmark_node_next(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  } else {
    return node->next;
  }
}

cmark_node *cmark_node_previous(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  } else {
    return node->prev;
  }
}

cmark_node *cmark_node_parent(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  } else {
    return node->parent;
  }
}

cmark_node *cmark_node_first_child(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  } else {
    return node->first_child;
  }
}

cmark_node *cmark_node_last_child(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  } else {
    return node->last_child;
  }
}

void *cmark_node_get_user_data(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  } else {
    return node->user_data;
  }
}

int cmark_node_set_user_data(cmark_node *node, void *user_data) {
  if (node == NULL) {
    return 0;
  }
  node->user_data = user_data;
  return 1;
}

const char *cmark_node_get_literal(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  }

  switch (node->type) {
  case CMARK_NODE_HTML_BLOCK:
  case CMARK_NODE_TEXT:
  case CMARK_NODE_HTML_INLINE:
  case CMARK_NODE_CODE:
    return cmark_chunk_to_cstr(NODE_MEM(node), &node->as.literal);

  case CMARK_NODE_CODE_BLOCK:
    return cmark_chunk_to_cstr(NODE_MEM(node), &node->as.code.literal);

  default:
    break;
  }

  return NULL;
}

int cmark_node_set_literal(cmark_node *node, const char *content) {
  if (node == NULL) {
    return 0;
  }

  switch (node->type) {
  case CMARK_NODE_HTML_BLOCK:
  case CMARK_NODE_TEXT:
  case CMARK_NODE_HTML_INLINE:
  case CMARK_NODE_CODE:
    cmark_chunk_set_cstr(NODE_MEM(node), &node->as.literal, content);
    return 1;

  case CMARK_NODE_CODE_BLOCK:
    cmark_chunk_set_cstr(NODE_MEM(node), &node->as.code.literal, content);
    return 1;

  default:
    break;
  }

  return 0;
}

int cmark_node_get_heading_level(cmark_node *node) {
  if (node == NULL) {
    return 0;
  }

  switch (node->type) {
  case CMARK_NODE_HEADING:
    return node->as.heading.level;

  default:
    break;
  }

  return 0;
}

int cmark_node_set_heading_level(cmark_node *node, int level) {
  if (node == NULL || level < 1 || level > 6) {
    return 0;
  }

  switch (node->type) {
  case CMARK_NODE_HEADING:
    node->as.heading.level = level;
    return 1;

  default:
    break;
  }

  return 0;
}

cmark_list_type cmark_node_get_list_type(cmark_node *node) {
  if (node == NULL) {
    return CMARK_NO_LIST;
  }

  if (node->type == CMARK_NODE_LIST) {
    return node->as.list.list_type;
  } else {
    return CMARK_NO_LIST;
  }
}

int cmark_node_set_list_type(cmark_node *node, cmark_list_type type) {
  if (!(type == CMARK_BULLET_LIST || type == CMARK_ORDERED_LIST)) {
    return 0;
  }

  if (node == NULL) {
    return 0;
  }

  if (node->type == CMARK_NODE_LIST) {
    node->as.list.list_type = type;
    return 1;
  } else {
    return 0;
  }
}

cmark_delim_type cmark_node_get_list_delim(cmark_node *node) {
  if (node == NULL) {
    return CMARK_NO_DELIM;
  }

  if (node->type == CMARK_NODE_LIST) {
    return node->as.list.delimiter;
  } else {
    return CMARK_NO_DELIM;
  }
}

int cmark_node_set_list_delim(cmark_node *node, cmark_delim_type delim) {
  if (!(delim == CMARK_PERIOD_DELIM || delim == CMARK_PAREN_DELIM)) {
    return 0;
  }

  if (node == NULL) {
    return 0;
  }

  if (node->type == CMARK_NODE_LIST) {
    node->as.list.delimiter = delim;
    return 1;
  } else {
    return 0;
  }
}

int cmark_node_get_list_start(cmark_node *node) {
  if (node == NULL) {
    return 0;
  }

  if (node->type == CMARK_NODE_LIST) {
    return node->as.list.start;
  } else {
    return 0;
  }
}

int cmark_node_set_list_start(cmark_node *node, int start) {
  if (node == NULL || start < 0) {
    return 0;
  }

  if (node->type == CMARK_NODE_LIST) {
    node->as.list.start = start;
    return 1;
  } else {
    return 0;
  }
}

int cmark_node_get_list_tight(cmark_node *node) {
  if (node == NULL) {
    return 0;
  }

  if (node->type == CMARK_NODE_LIST) {
    return node->as.list.tight;
  } else {
    return 0;
  }
}

int cmark_node_set_list_tight(cmark_node *node, int tight) {
  if (node == NULL) {
    return 0;
  }

  if (node->type == CMARK_NODE_LIST) {
    node->as.list.tight = tight == 1;
    return 1;
  } else {
    return 0;
  }
}

const char *cmark_node_get_fence_info(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  }

  if (node->type == CMARK_NODE_CODE_BLOCK) {
    return cmark_chunk_to_cstr(NODE_MEM(node), &node->as.code.info);
  } else {
    return NULL;
  }
}

int cmark_node_set_fence_info(cmark_node *node, const char *info) {
  if (node == NULL) {
    return 0;
  }

  if (node->type == CMARK_NODE_CODE_BLOCK) {
    cmark_chunk_set_cstr(NODE_MEM(node), &node->as.code.info, info);
    return 1;
  } else {
    return 0;
  }
}

const char *cmark_node_get_url(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  }

  switch (node->type) {
  case CMARK_NODE_LINK:
  case CMARK_NODE_IMAGE:
    return cmark_chunk_to_cstr(NODE_MEM(node), &node->as.link.url);
  default:
    break;
  }

  return NULL;
}

int cmark_node_set_url(cmark_node *node, const char *url) {
  if (node == NULL) {
    return 0;
  }

  switch (node->type) {
  case CMARK_NODE_LINK:
  case CMARK_NODE_IMAGE:
    cmark_chunk_set_cstr(NODE_MEM(node), &node->as.link.url, url);
    return 1;
  default:
    break;
  }

  return 0;
}

const char *cmark_node_get_title(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  }

  switch (node->type) {
  case CMARK_NODE_LINK:
  case CMARK_NODE_IMAGE:
    return cmark_chunk_to_cstr(NODE_MEM(node), &node->as.link.title);
  default:
    break;
  }

  return NULL;
}

int cmark_node_set_title(cmark_node *node, const char *title) {
  if (node == NULL) {
    return 0;
  }

  switch (node->type) {
  case CMARK_NODE_LINK:
  case CMARK_NODE_IMAGE:
    cmark_chunk_set_cstr(NODE_MEM(node), &node->as.link.title, title);
    return 1;
  default:
    break;
  }

  return 0;
}

const char *cmark_node_get_on_enter(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  }

  switch (node->type) {
  case CMARK_NODE_CUSTOM_INLINE:
  case CMARK_NODE_CUSTOM_BLOCK:
    return cmark_chunk_to_cstr(NODE_MEM(node), &node->as.custom.on_enter);
  default:
    break;
  }

  return NULL;
}

int cmark_node_set_on_enter(cmark_node *node, const char *on_enter) {
  if (node == NULL) {
    return 0;
  }

  switch (node->type) {
  case CMARK_NODE_CUSTOM_INLINE:
  case CMARK_NODE_CUSTOM_BLOCK:
    cmark_chunk_set_cstr(NODE_MEM(node), &node->as.custom.on_enter, on_enter);
    return 1;
  default:
    break;
  }

  return 0;
}

const char *cmark_node_get_on_exit(cmark_node *node) {
  if (node == NULL) {
    return NULL;
  }

  switch (node->type) {
  case CMARK_NODE_CUSTOM_INLINE:
  case CMARK_NODE_CUSTOM_BLOCK:
    return cmark_chunk_to_cstr(NODE_MEM(node), &node->as.custom.on_exit);
  default:
    break;
  }

  return NULL;
}

int cmark_node_set_on_exit(cmark_node *node, const char *on_exit) {
  if (node == NULL) {
    return 0;
  }

  switch (node->type) {
  case CMARK_NODE_CUSTOM_INLINE:
  case CMARK_NODE_CUSTOM_BLOCK:
    cmark_chunk_set_cstr(NODE_MEM(node), &node->as.custom.on_exit, on_exit);
    return 1;
  default:
    break;
  }

  return 0;
}

int cmark_node_get_start_line(cmark_node *node) {
  if (node == NULL) {
    return 0;
  }
  return node->start_line;
}

int cmark_node_get_start_column(cmark_node *node) {
  if (node == NULL) {
    return 0;
  }
  return node->start_column;
}

int cmark_node_get_end_line(cmark_node *node) {
  if (node == NULL) {
    return 0;
  }
  return node->end_line;
}

int cmark_node_get_end_column(cmark_node *node) {
  if (node == NULL) {
    return 0;
  }
  return node->end_column;
}

// Unlink a node without adjusting its next, prev, and parent pointers.
static void S_node_unlink(cmark_node *node) {
  if (node == NULL) {
    return;
  }

  if (node->prev) {
    node->prev->next = node->next;
  }
  if (node->next) {
    node->next->prev = node->prev;
  }

  // Adjust first_child and last_child of parent.
  cmark_node *parent = node->parent;
  if (parent) {
    if (parent->first_child == node) {
      parent->first_child = node->next;
    }
    if (parent->last_child == node) {
      parent->last_child = node->prev;
    }
  }
}

void cmark_node_unlink(cmark_node *node) {
  S_node_unlink(node);

  node->next = NULL;
  node->prev = NULL;
  node->parent = NULL;
}

int cmark_node_insert_before(cmark_node *node, cmark_node *sibling) {
  if (node == NULL || sibling == NULL) {
    return 0;
  }

  if (!node->parent || !S_can_contain(node->parent, sibling)) {
    return 0;
  }

  S_node_unlink(sibling);

  cmark_node *old_prev = node->prev;

  // Insert 'sibling' between 'old_prev' and 'node'.
  if (old_prev) {
    old_prev->next = sibling;
  }
  sibling->prev = old_prev;
  sibling->next = node;
  node->prev = sibling;

  // Set new parent.
  cmark_node *parent = node->parent;
  sibling->parent = parent;

  // Adjust first_child of parent if inserted as first child.
  if (parent && !old_prev) {
    parent->first_child = sibling;
  }

  return 1;
}

int cmark_node_insert_after(cmark_node *node, cmark_node *sibling) {
  if (node == NULL || sibling == NULL) {
    return 0;
  }

  if (!node->parent || !S_can_contain(node->parent, sibling)) {
    return 0;
  }

  S_node_unlink(sibling);

  cmark_node *old_next = node->next;

  // Insert 'sibling' between 'node' and 'old_next'.
  if (old_next) {
    old_next->prev = sibling;
  }
  sibling->next = old_next;
  sibling->prev = node;
  node->next = sibling;

  // Set new parent.
  cmark_node *parent = node->parent;
  sibling->parent = parent;

  // Adjust last_child of parent if inserted as last child.
  if (parent && !old_next) {
    parent->last_child = sibling;
  }

  return 1;
}

int cmark_node_replace(cmark_node *oldnode, cmark_node *newnode) {
  if (!cmark_node_insert_before(oldnode, newnode)) {
    return 0;
  }
  cmark_node_unlink(oldnode);
  return 1;
}

int cmark_node_prepend_child(cmark_node *node, cmark_node *child) {
  if (!S_can_contain(node, child)) {
    return 0;
  }

  S_node_unlink(child);

  cmark_node *old_first_child = node->first_child;

  child->next = old_first_child;
  child->prev = NULL;
  child->parent = node;
  node->first_child = child;

  if (old_first_child) {
    old_first_child->prev = child;
  } else {
    // Also set last_child if node previously had no children.
    node->last_child = child;
  }

  return 1;
}

int cmark_node_append_child(cmark_node *node, cmark_node *child) {
  if (!S_can_contain(node, child)) {
    return 0;
  }

  S_node_unlink(child);

  cmark_node *old_last_child = node->last_child;

  child->next = NULL;
  child->prev = old_last_child;
  child->parent = node;
  node->last_child = child;

  if (old_last_child) {
    old_last_child->next = child;
  } else {
    // Also set first_child if node previously had no children.
    node->first_child = child;
  }

  return 1;
}

static void S_print_error(FILE *out, cmark_node *node, const char *elem) {
  if (out == NULL) {
    return;
  }
  fprintf(out, "Invalid '%s' in node type %s at %d:%d\n", elem,
          cmark_node_get_type_string(node), node->start_line,
          node->start_column);
}

int cmark_node_check(cmark_node *node, FILE *out) {
  cmark_node *cur;
  int errors = 0;

  if (!node) {
    return 0;
  }

  cur = node;
  for (;;) {
    if (cur->first_child) {
      if (cur->first_child->prev != NULL) {
        S_print_error(out, cur->first_child, "prev");
        cur->first_child->prev = NULL;
        ++errors;
      }
      if (cur->first_child->parent != cur) {
        S_print_error(out, cur->first_child, "parent");
        cur->first_child->parent = cur;
        ++errors;
      }
      cur = cur->first_child;
      continue;
    }

  next_sibling:
    if (cur == node) {
      break;
    }
    if (cur->next) {
      if (cur->next->prev != cur) {
        S_print_error(out, cur->next, "prev");
        cur->next->prev = cur;
        ++errors;
      }
      if (cur->next->parent != cur->parent) {
        S_print_error(out, cur->next, "parent");
        cur->next->parent = cur->parent;
        ++errors;
      }
      cur = cur->next;
      continue;
    }

    if (cur->parent->last_child != cur) {
      S_print_error(out, cur->parent, "last_child");
      cur->parent->last_child = cur;
      ++errors;
    }
    cur = cur->parent;
    goto next_sibling;
  }

  return errors;
}


#include "entities.inc"

/* Binary tree lookup code for entities added by JGM */

static const unsigned char *S_lookup(int i, int low, int hi,
                                     const unsigned char *s, int len) {
  int j;
  int cmp =
      strncmp((const char *)s, (const char *)cmark_entities[i].entity, len);
  if (cmp == 0 && cmark_entities[i].entity[len] == 0) {
    return (const unsigned char *)cmark_entities[i].bytes;
  } else if (cmp <= 0 && i > low) {
    j = i - ((i - low) / 2);
    if (j == i)
      j -= 1;
    return S_lookup(j, low, i - 1, s, len);
  } else if (cmp > 0 && i < hi) {
    j = i + ((hi - i) / 2);
    if (j == i)
      j += 1;
    return S_lookup(j, i + 1, hi, s, len);
  } else {
    return NULL;
  }
}

static const unsigned char *S_lookup_entity(const unsigned char *s, int len) {
  return S_lookup(CMARK_NUM_ENTITIES / 2, 0, CMARK_NUM_ENTITIES - 1, s, len);
}

bufsize_t houdini_unescape_ent(cmark_strbuf *ob, const uint8_t *src,
                               bufsize_t size) {
  bufsize_t i = 0;

  if (size >= 3 && src[0] == '#') {
    int codepoint = 0;
    int num_digits = 0;

    if (_isdigit(src[1])) {
      for (i = 1; i < size && _isdigit(src[i]); ++i) {
        codepoint = (codepoint * 10) + (src[i] - '0');

        if (codepoint >= 0x110000) {
          // Keep counting digits but
          // avoid integer overflow.
          codepoint = 0x110000;
        }
      }

      num_digits = i - 1;
    }

    else if (src[1] == 'x' || src[1] == 'X') {
      for (i = 2; i < size && _isxdigit(src[i]); ++i) {
        codepoint = (codepoint * 16) + ((src[i] | 32) % 39 - 9);

        if (codepoint >= 0x110000) {
          // Keep counting digits but
          // avoid integer overflow.
          codepoint = 0x110000;
        }
      }

      num_digits = i - 2;
    }

    if (num_digits >= 1 && num_digits <= 8 && i < size && src[i] == ';') {
      if (codepoint == 0 || (codepoint >= 0xD800 && codepoint < 0xE000) ||
          codepoint >= 0x110000) {
        codepoint = 0xFFFD;
      }
      cmark_utf8proc_encode_char(codepoint, ob);
      return i + 1;
    }
  }

  else {
    if (size > CMARK_ENTITY_MAX_LENGTH)
      size = CMARK_ENTITY_MAX_LENGTH;

    for (i = CMARK_ENTITY_MIN_LENGTH; i < size; ++i) {
      if (src[i] == ' ')
        break;

      if (src[i] == ';') {
        const unsigned char *entity = S_lookup_entity(src, i);

        if (entity != NULL) {
          cmark_strbuf_puts(ob, (const char *)entity);
          return i + 1;
        }

        break;
      }
    }
  }

  return 0;
}

int houdini_unescape_html(cmark_strbuf *ob, const uint8_t *src,
                          bufsize_t size) {
  bufsize_t i = 0, org, ent;

  while (i < size) {
    org = i;
    while (i < size && src[i] != '&')
      i++;

    if (likely(i > org)) {
      if (unlikely(org == 0)) {
        if (i >= size)
          return 0;

        cmark_strbuf_grow(ob, HOUDINI_UNESCAPED_SIZE(size));
      }

      cmark_strbuf_put(ob, src + org, i - org);
    }

    /* escaping */
    if (i >= size)
      break;

    i++;

    ent = houdini_unescape_ent(ob, src + i, size - i);
    i += ent;

    /* not really an entity */
    if (ent == 0)
      cmark_strbuf_putc(ob, '&');
  }

  return 1;
}

void houdini_unescape_html_f(cmark_strbuf *ob, const uint8_t *src,
                             bufsize_t size) {
  if (!houdini_unescape_html(ob, src, size))
    cmark_strbuf_put(ob, src, size);
}


static const int S_leaf_mask =
    (1 << CMARK_NODE_HTML_BLOCK) | (1 << CMARK_NODE_THEMATIC_BREAK) |
    (1 << CMARK_NODE_CODE_BLOCK) | (1 << CMARK_NODE_TEXT) |
    (1 << CMARK_NODE_SOFTBREAK) | (1 << CMARK_NODE_LINEBREAK) |
    (1 << CMARK_NODE_CODE) | (1 << CMARK_NODE_HTML_INLINE);

cmark_iter *cmark_iter_new(cmark_node *root) {
  if (root == NULL) {
    return NULL;
  }
  cmark_mem *mem = root->content.mem;
  cmark_iter *iter = (cmark_iter *)mem->calloc(1, sizeof(cmark_iter));
  iter->mem = mem;
  iter->root = root;
  iter->cur.ev_type = CMARK_EVENT_NONE;
  iter->cur.node = NULL;
  iter->next.ev_type = CMARK_EVENT_ENTER;
  iter->next.node = root;
  return iter;
}

void cmark_iter_free(cmark_iter *iter) { iter->mem->free(iter); }

static bool S_is_leaf(cmark_node *node) {
  return ((1 << node->type) & S_leaf_mask) != 0;
}

cmark_event_type cmark_iter_next(cmark_iter *iter) {
  cmark_event_type ev_type = iter->next.ev_type;
  cmark_node *node = iter->next.node;

  iter->cur.ev_type = ev_type;
  iter->cur.node = node;

  if (ev_type == CMARK_EVENT_DONE) {
    return ev_type;
  }

  /* roll forward to next item, setting both fields */
  if (ev_type == CMARK_EVENT_ENTER && !S_is_leaf(node)) {
    if (node->first_child == NULL) {
      /* stay on this node but exit */
      iter->next.ev_type = CMARK_EVENT_EXIT;
    } else {
      iter->next.ev_type = CMARK_EVENT_ENTER;
      iter->next.node = node->first_child;
    }
  } else if (node == iter->root) {
    /* don't move past root */
    iter->next.ev_type = CMARK_EVENT_DONE;
    iter->next.node = NULL;
  } else if (node->next) {
    iter->next.ev_type = CMARK_EVENT_ENTER;
    iter->next.node = node->next;
  } else if (node->parent) {
    iter->next.ev_type = CMARK_EVENT_EXIT;
    iter->next.node = node->parent;
  } else {
    assert(false);
    iter->next.ev_type = CMARK_EVENT_DONE;
    iter->next.node = NULL;
  }

  return ev_type;
}

void cmark_iter_reset(cmark_iter *iter, cmark_node *current,
                      cmark_event_type event_type) {
  iter->next.ev_type = event_type;
  iter->next.node = current;
  cmark_iter_next(iter);
}

cmark_node *cmark_iter_get_node(cmark_iter *iter) { return iter->cur.node; }

cmark_event_type cmark_iter_get_event_type(cmark_iter *iter) {
  return iter->cur.ev_type;
}

cmark_node *cmark_iter_get_root(cmark_iter *iter) { return iter->root; }

void cmark_consolidate_text_nodes(cmark_node *root) {
  if (root == NULL) {
    return;
  }
  cmark_iter *iter = cmark_iter_new(root);
  cmark_strbuf buf = CMARK_BUF_INIT(iter->mem);
  cmark_event_type ev_type;
  cmark_node *cur, *tmp, *next;

  while ((ev_type = cmark_iter_next(iter)) != CMARK_EVENT_DONE) {
    cur = cmark_iter_get_node(iter);
    if (ev_type == CMARK_EVENT_ENTER && cur->type == CMARK_NODE_TEXT &&
        cur->next && cur->next->type == CMARK_NODE_TEXT) {
      cmark_strbuf_clear(&buf);
      cmark_strbuf_put(&buf, cur->as.literal.data, cur->as.literal.len);
      tmp = cur->next;
      while (tmp && tmp->type == CMARK_NODE_TEXT) {
        cmark_iter_next(iter); // advance pointer
        cmark_strbuf_put(&buf, tmp->as.literal.data, tmp->as.literal.len);
        next = tmp->next;
        cmark_node_free(tmp);
        tmp = next;
      }
      cmark_chunk_free(iter->mem, &cur->as.literal);
      cur->as.literal = cmark_chunk_buf_detach(&buf);
    }
  }

  cmark_strbuf_free(&buf);
  cmark_iter_free(iter);
}


#define BUFFER_SIZE 100

// Functions to convert cmark_nodes to HTML strings.

static void escape_html(cmark_strbuf *dest, const unsigned char *source,
                        bufsize_t length) {
  houdini_escape_html0(dest, source, length, 0);
}

static CMARK_INLINE void cr(cmark_strbuf *html) {
  if (html->size && html->ptr[html->size - 1] != '\n')
    cmark_strbuf_putc(html, '\n');
}

struct render_state {
  cmark_strbuf *html;
  cmark_node *plain;
};

static void S_render_sourcepos(cmark_node *node, cmark_strbuf *html,
                               int options) {
  char buffer[BUFFER_SIZE];
  if (CMARK_OPT_SOURCEPOS & options) {
    snprintf(buffer, BUFFER_SIZE, " data-sourcepos=\"%d:%d-%d:%d\"",
             cmark_node_get_start_line(node), cmark_node_get_start_column(node),
             cmark_node_get_end_line(node), cmark_node_get_end_column(node));
    cmark_strbuf_puts(html, buffer);
  }
}

static int S_render_node(cmark_node *node, cmark_event_type ev_type,
                         struct render_state *state, int options) {
  cmark_node *parent;
  cmark_node *grandparent;
  cmark_strbuf *html = state->html;
  char start_heading[] = "<h0";
  char end_heading[] = "</h0";
  bool tight;
  char buffer[BUFFER_SIZE];

  bool entering = (ev_type == CMARK_EVENT_ENTER);

  if (state->plain == node) { // back at original node
    state->plain = NULL;
  }

  if (state->plain != NULL) {
    switch (node->type) {
    case CMARK_NODE_TEXT:
    case CMARK_NODE_CODE:
    case CMARK_NODE_HTML_INLINE:
      escape_html(html, node->as.literal.data, node->as.literal.len);
      break;

    case CMARK_NODE_LINEBREAK:
    case CMARK_NODE_SOFTBREAK:
      cmark_strbuf_putc(html, ' ');
      break;

    default:
      break;
    }
    return 1;
  }

  switch (node->type) {
  case CMARK_NODE_DOCUMENT:
    break;

  case CMARK_NODE_BLOCK_QUOTE:
    if (entering) {
      cr(html);
      cmark_strbuf_puts(html, "<blockquote");
      S_render_sourcepos(node, html, options);
      cmark_strbuf_puts(html, ">\n");
    } else {
      cr(html);
      cmark_strbuf_puts(html, "</blockquote>\n");
    }
    break;

  case CMARK_NODE_LIST: {
    cmark_list_type list_type = node->as.list.list_type;
    int start = node->as.list.start;

    if (entering) {
      cr(html);
      if (list_type == CMARK_BULLET_LIST) {
        cmark_strbuf_puts(html, "<ul");
        S_render_sourcepos(node, html, options);
        cmark_strbuf_puts(html, ">\n");
      } else if (start == 1) {
        cmark_strbuf_puts(html, "<ol");
        S_render_sourcepos(node, html, options);
        cmark_strbuf_puts(html, ">\n");
      } else {
        snprintf(buffer, BUFFER_SIZE, "<ol start=\"%d\"", start);
        cmark_strbuf_puts(html, buffer);
        S_render_sourcepos(node, html, options);
        cmark_strbuf_puts(html, ">\n");
      }
    } else {
      cmark_strbuf_puts(html,
                        list_type == CMARK_BULLET_LIST ? "</ul>\n" : "</ol>\n");
    }
    break;
  }

  case CMARK_NODE_ITEM:
    if (entering) {
      cr(html);
      cmark_strbuf_puts(html, "<li");
      S_render_sourcepos(node, html, options);
      cmark_strbuf_putc(html, '>');
    } else {
      cmark_strbuf_puts(html, "</li>\n");
    }
    break;

  case CMARK_NODE_HEADING:
    if (entering) {
      cr(html);
      start_heading[2] = (char)('0' + node->as.heading.level);
      cmark_strbuf_puts(html, start_heading);
      S_render_sourcepos(node, html, options);
      cmark_strbuf_putc(html, '>');
    } else {
      end_heading[3] = (char)('0' + node->as.heading.level);
      cmark_strbuf_puts(html, end_heading);
      cmark_strbuf_puts(html, ">\n");
    }
    break;

  case CMARK_NODE_CODE_BLOCK:
    cr(html);

    if (node->as.code.info.len == 0) {
      cmark_strbuf_puts(html, "<pre");
      S_render_sourcepos(node, html, options);
      cmark_strbuf_puts(html, "><code>");
    } else {
      bufsize_t first_tag = 0;
      while (first_tag < node->as.code.info.len &&
             !cmark_isspace(node->as.code.info.data[first_tag])) {
        first_tag += 1;
      }

      cmark_strbuf_puts(html, "<pre");
      S_render_sourcepos(node, html, options);
      cmark_strbuf_puts(html, "><code class=\"language-");
      escape_html(html, node->as.code.info.data, first_tag);
      cmark_strbuf_puts(html, "\">");
    }

    escape_html(html, node->as.code.literal.data, node->as.code.literal.len);
    cmark_strbuf_puts(html, "</code></pre>\n");
    break;

  case CMARK_NODE_HTML_BLOCK:
    cr(html);
    if (options & CMARK_OPT_SAFE) {
      cmark_strbuf_puts(html, "<!-- raw HTML omitted -->");
    } else {
      cmark_strbuf_put(html, node->as.literal.data, node->as.literal.len);
    }
    cr(html);
    break;

  case CMARK_NODE_CUSTOM_BLOCK:
    cr(html);
    if (entering) {
      cmark_strbuf_put(html, node->as.custom.on_enter.data,
                       node->as.custom.on_enter.len);
    } else {
      cmark_strbuf_put(html, node->as.custom.on_exit.data,
                       node->as.custom.on_exit.len);
    }
    cr(html);
    break;

  case CMARK_NODE_THEMATIC_BREAK:
    cr(html);
    cmark_strbuf_puts(html, "<hr");
    S_render_sourcepos(node, html, options);
    cmark_strbuf_puts(html, " />\n");
    break;

  case CMARK_NODE_PARAGRAPH:
    parent = cmark_node_parent(node);
    grandparent = cmark_node_parent(parent);
    if (grandparent != NULL && grandparent->type == CMARK_NODE_LIST) {
      tight = grandparent->as.list.tight;
    } else {
      tight = false;
    }
    if (!tight) {
      if (entering) {
        cr(html);
        cmark_strbuf_puts(html, "<p");
        S_render_sourcepos(node, html, options);
        cmark_strbuf_putc(html, '>');
      } else {
        cmark_strbuf_puts(html, "</p>\n");
      }
    }
    break;

  case CMARK_NODE_TEXT:
    escape_html(html, node->as.literal.data, node->as.literal.len);
    break;

  case CMARK_NODE_LINEBREAK:
    cmark_strbuf_puts(html, "<br />\n");
    break;

  case CMARK_NODE_SOFTBREAK:
    if (options & CMARK_OPT_HARDBREAKS) {
      cmark_strbuf_puts(html, "<br />\n");
    } else if (options & CMARK_OPT_NOBREAKS) {
      cmark_strbuf_putc(html, ' ');
    } else {
      cmark_strbuf_putc(html, '\n');
    }
    break;

  case CMARK_NODE_CODE:
    cmark_strbuf_puts(html, "<code>");
    escape_html(html, node->as.literal.data, node->as.literal.len);
    cmark_strbuf_puts(html, "</code>");
    break;

  case CMARK_NODE_HTML_INLINE:
    if (options & CMARK_OPT_SAFE) {
      cmark_strbuf_puts(html, "<!-- raw HTML omitted -->");
    } else {
      cmark_strbuf_put(html, node->as.literal.data, node->as.literal.len);
    }
    break;

  case CMARK_NODE_CUSTOM_INLINE:
    if (entering) {
      cmark_strbuf_put(html, node->as.custom.on_enter.data,
                       node->as.custom.on_enter.len);
    } else {
      cmark_strbuf_put(html, node->as.custom.on_exit.data,
                       node->as.custom.on_exit.len);
    }
    break;

  case CMARK_NODE_STRONG:
    if (entering) {
      cmark_strbuf_puts(html, "<strong>");
    } else {
      cmark_strbuf_puts(html, "</strong>");
    }
    break;

  case CMARK_NODE_EMPH:
    if (entering) {
      cmark_strbuf_puts(html, "<em>");
    } else {
      cmark_strbuf_puts(html, "</em>");
    }
    break;

  case CMARK_NODE_LINK:
    if (entering) {
      cmark_strbuf_puts(html, "<a href=\"");
      if (!((options & CMARK_OPT_SAFE) &&
            scan_dangerous_url(&node->as.link.url, 0))) {
        houdini_escape_href(html, node->as.link.url.data,
                            node->as.link.url.len);
      }
      if (node->as.link.title.len) {
        cmark_strbuf_puts(html, "\" title=\"");
        escape_html(html, node->as.link.title.data, node->as.link.title.len);
      }
      cmark_strbuf_puts(html, "\">");
    } else {
      cmark_strbuf_puts(html, "</a>");
    }
    break;

  case CMARK_NODE_IMAGE:
    if (entering) {
      cmark_strbuf_puts(html, "<img src=\"");
      if (!((options & CMARK_OPT_SAFE) &&
            scan_dangerous_url(&node->as.link.url, 0))) {
        houdini_escape_href(html, node->as.link.url.data,
                            node->as.link.url.len);
      }
      cmark_strbuf_puts(html, "\" alt=\"");
      state->plain = node;
    } else {
      if (node->as.link.title.len) {
        cmark_strbuf_puts(html, "\" title=\"");
        escape_html(html, node->as.link.title.data, node->as.link.title.len);
      }

      cmark_strbuf_puts(html, "\" />");
    }
    break;

  default:
    assert(false);
    break;
  }

  // cmark_strbuf_putc(html, 'x');
  return 1;
}

char *cmark_render_html(cmark_node *root, int options) {
  char *result;
  cmark_strbuf html = CMARK_BUF_INIT(cmark_node_mem(root));
  cmark_event_type ev_type;
  cmark_node *cur;
  struct render_state state = {&html, NULL};
  cmark_iter *iter = cmark_iter_new(root);

  while ((ev_type = cmark_iter_next(iter)) != CMARK_EVENT_DONE) {
    cur = cmark_iter_get_node(iter);
    S_render_node(cur, ev_type, &state, options);
  }
  result = (char *)cmark_strbuf_detach(&html);

  cmark_iter_free(iter);
  return result;
}



/**
 * According to the OWASP rules:
 *
 * & --> &amp;
 * < --> &lt;
 * > --> &gt;
 * " --> &quot;
 * ' --> &#x27;     &apos; is not recommended
 * / --> &#x2F;     forward slash is included as it helps end an HTML entity
 *
 */
static const char HTML_ESCAPE_TABLE[] = {
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 2, 3, 0, 0, 0, 0, 0, 0, 0, 4,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
};

static const char *HTML_ESCAPES[] = {"",      "&quot;", "&amp;", "&#39;",
                                     "&#47;", "&lt;",   "&gt;"};

int houdini_escape_html0(cmark_strbuf *ob, const uint8_t *src, bufsize_t size,
                         int secure) {
  bufsize_t i = 0, org, esc = 0;

  while (i < size) {
    org = i;
    while (i < size && (esc = HTML_ESCAPE_TABLE[src[i]]) == 0)
      i++;

    if (i > org)
      cmark_strbuf_put(ob, src + org, i - org);

    /* escaping */
    if (unlikely(i >= size))
      break;

    /* The forward slash is only escaped in secure mode */
    if ((src[i] == '/' || src[i] == '\'') && !secure) {
      cmark_strbuf_putc(ob, src[i]);
    } else {
      cmark_strbuf_puts(ob, HTML_ESCAPES[esc]);
    }

    i++;
  }

  return 1;
}

int houdini_escape_html(cmark_strbuf *ob, const uint8_t *src, bufsize_t size) {
  return houdini_escape_html0(ob, src, size, 1);
}


/*
 * The following characters will not be escaped:
 *
 *		-_.+!*'(),%#@?=;:/,+&$ alphanum
 *
 * Note that this character set is the addition of:
 *
 *	- The characters which are safe to be in an URL
 *	- The characters which are *not* safe to be in
 *	an URL because they are RESERVED characters.
 *
 * We asume (lazily) that any RESERVED char that
 * appears inside an URL is actually meant to
 * have its native function (i.e. as an URL
 * component/separator) and hence needs no escaping.
 *
 * There are two exceptions: the chacters & (amp)
 * and ' (single quote) do not appear in the table.
 * They are meant to appear in the URL as components,
 * yet they require special HTML-entity escaping
 * to generate valid HTML markup.
 *
 * All other characters will be escaped to %XX.
 *
 */
static const char HREF_SAFE[] = {
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1,
    0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
};

int houdini_escape_href(cmark_strbuf *ob, const uint8_t *src, bufsize_t size) {
  static const uint8_t hex_chars[] = "0123456789ABCDEF";
  bufsize_t i = 0, org;
  uint8_t hex_str[3];

  hex_str[0] = '%';

  while (i < size) {
    org = i;
    while (i < size && HREF_SAFE[src[i]] != 0)
      i++;

    if (likely(i > org))
      cmark_strbuf_put(ob, src + org, i - org);

    /* escaping */
    if (i >= size)
      break;

    switch (src[i]) {
    /* amp appears all the time in URLs, but needs
     * HTML-entity escaping to be inside an href */
    case '&':
      cmark_strbuf_puts(ob, "&amp;");
      break;

    /* the single quote is a valid URL character
     * according to the standard; it needs HTML
     * entity escaping too */
    case '\'':
      cmark_strbuf_puts(ob, "&#x27;");
      break;

/* the space can be escaped to %20 or a plus
 * sign. we're going with the generic escape
 * for now. the plus thing is more commonly seen
 * when building GET strings */
#if 0
		case ' ':
			cmark_strbuf_putc(ob, '+');
			break;
#endif

    /* every other character goes with a %XX escaping */
    default:
      hex_str[1] = hex_chars[(src[i] >> 4) & 0xF];
      hex_str[2] = hex_chars[src[i] & 0xF];
      cmark_strbuf_put(ob, hex_str, 3);
    }

    i++;
  }

  return 1;
}
